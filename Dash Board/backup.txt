seg12.py code :

import os
import cv2
import time
import csv
import torch
import numpy as np
from PIL import Image
from datetime import datetime
from torchvision import transforms, models
from ultralytics import YOLO
from torch import nn
from gpio_controller import turn_on_device, turn_off_device, cleanup_gpio
from deep_sort_realtime.deepsort_tracker import DeepSort
import logging
from flask import Flask, jsonify, Response, render_template, request, session, send_from_directory
from flask_cors import CORS
import threading
import json

app = Flask(__name__)
CORS(app)  # Enable CORS for frontend communication

# Serve frontend HTML files
@app.route('/')
def serve_index():
    return send_from_directory('../frontend', 'index.html')

@app.route('/device-control.html')
def serve_device_control():
    return send_from_directory('../frontend', 'device-control.html')

# Serve static assets (JS, CSS)
@app.route('/<path:filename>')
def serve_static_file(filename):
    return send_from_directory('../frontend', filename)

# Global variables for system state
current_stats = {
    'people_count': 0,
    'density': 0.0,
    'device_status': 'off',
    'crowd_level': 'unknown',
    'crowd_confidence': 0.0,
    'tracked_ids': [],
    'tracking_info': [],
    'processing_time': 0,
    'fps': 0,
    'frame_count': 0
}

detection_running = False
frame_buffer = None
cap = None

# In-memory storage for devices (you can replace with database)
devices = {
    'fan': {'name': 'Ceiling Fan', 'room': 'Living Room', 'speed': 0, 'state': False},
    'light': {'name': 'Smart Light', 'room': 'Living Room', 'brightness': 0, 'state': False},
    'tv': {'name': 'Smart TV', 'room': 'Living Room', 'volume': 0, 'state': False}
}

# Device control history
device_history = []

# Configuration constants
CAMERA_ID = 0
CAMERA_FOV_M2 = 100  # Camera field of view in square meters
DENSITY_THRESHOLD = 0.05
CSV_FILE = "density_log.csv"
DATASET_DIR = "dataset"
OUTPUT_DIR = "output_results"
YOLO_MODEL_PATH = "yolov8n.pt"
RESNET_MODEL_PATH = "model/resnet50_density_model.pth"
MIN_CONFIDENCE = 0.3
FRAME_SKIP = 2
FORCE_GPU = True
BATCH_SIZE = 4
USE_RESNET = True

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Create necessary directories
os.makedirs(DATASET_DIR, exist_ok=True)
os.makedirs(OUTPUT_DIR, exist_ok=True)
os.makedirs('model', exist_ok=True)

# Initialize CSV file
if not os.path.exists(CSV_FILE):
    with open(CSV_FILE, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(["Timestamp", "Camera ID", "People Count", "Density", "Device Status", 
                         "Crowd Density", "Tracked IDs", "Processing Time (ms)"])

def check_mps_availability():
    """Check if Apple Silicon GPU is available"""
    if torch.backends.mps.is_available():
        logger.info("MPS is available. Using Apple Silicon GPU!")
        return torch.device("mps")
    else:
        logger.info("MPS not available. Falling back to CPU.")
        return torch.device("cpu")

# Setup torch device
torch_device = check_mps_availability()
logger.info(f"Using device: {torch_device}")

# Load YOLO model
yolo_model = YOLO(YOLO_MODEL_PATH)
if torch_device.type == 'mps':
    yolo_model.to(torch_device)
    logger.info("YOLO model moved to GPU")

class DensityResNet(nn.Module):
    def __init__(self):
        super().__init__()
        self.base_model = models.resnet50(weights='IMAGENET1K_V2')
        self.base_model.fc = nn.Identity()
        self.base_model.avgpool = nn.Identity()
        self.density_head = nn.Sequential(
            nn.Conv2d(2048, 1024, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.Conv2d(1024, 512, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.Conv2d(512, 256, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.Conv2d(256, 1, kernel_size=1),
            nn.ReLU()
        )
    def forward(self, x):
        x = self.base_model.conv1(x)
        x = self.base_model.bn1(x)
        x = self.base_model.relu(x)
        x = self.base_model.maxpool(x)
        x = self.base_model.layer1(x)
        x = self.base_model.layer2(x)
        x = self.base_model.layer3(x)
        x = self.base_model.layer4(x)
        x = self.density_head(x)
        x = nn.functional.interpolate(x, size=(224, 224), mode='bilinear', align_corners=False)
        return x

class CrowdDensityClassifier(nn.Module):
    def __init__(self, density_model):
        super().__init__()
        self.density_model = density_model
        for param in self.density_model.parameters():
            param.requires_grad = False
        self.classifier = nn.Sequential(
            nn.AdaptiveAvgPool2d((1, 1)),
            nn.Flatten(),
            nn.Linear(1, 64),
            nn.ReLU(),
            nn.Dropout(0.3),
            nn.Linear(64, 32),
            nn.ReLU(),
            nn.Dropout(0.2),
            nn.Linear(32, 4),
            nn.Softmax(dim=1)
        )
    def forward(self, x):
        density_map = self.density_model(x)
        crowd_level = self.classifier(density_map)
        return density_map, crowd_level

def load_trained_model(model_path, device):
    """Load trained ResNet model"""
    try:
        model = DensityResNet()
        checkpoint = torch.load(model_path, map_location=device)
        if 'model_state_dict' in checkpoint:
            state_dict = checkpoint['model_state_dict']
            logger.info("Loaded checkpoint format")
        else:
            state_dict = checkpoint
            logger.info("Loaded direct state dict format")
        model.load_state_dict(state_dict)
        model.to(device)
        model.eval()
        logger.info("DensityResNet model loaded successfully")
        classifier_model = CrowdDensityClassifier(model)
        classifier_model.to(device)
        classifier_model.eval()
        return model, classifier_model
    except Exception as e:
        logger.error(f"Error loading model: {e}")
        return None, None

# Load ResNet model
resnet_model = None
crowd_classifier = None

if USE_RESNET:
    try:
        logger.info("Loading trained DensityResNet model...")
        resnet_model, crowd_classifier = load_trained_model(RESNET_MODEL_PATH, torch_device)
        if resnet_model is None:
            logger.warning("Could not load ResNet model, continuing without it")
            USE_RESNET = False
        else:
            logger.info("ResNet density model loaded successfully")
    except FileNotFoundError:
        logger.warning("ResNet model not found, continuing without it")
        USE_RESNET = False
    except Exception as e:
        logger.warning(f"Error loading ResNet model: {e}, continuing without it")
        USE_RESNET = False

# Setup transforms
resnet_transform = transforms.Compose([
    transforms.ToPILImage(),
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
])

# Initialize DeepSORT tracker
tracker = DeepSort(
    max_age=50,
    n_init=3,
    max_cosine_distance=0.4,
    nn_budget=None,
    embedder="mobilenet",
    half=True,
    bgr=True,
    embedder_gpu=torch_device.type == 'mps',
    embedder_wts=None,
    polygon=False,
    today=None
)

def calculate_iou(box1, box2):
    """Calculate IoU between two bounding boxes"""
    x1 = max(box1[0], box2[0])
    y1 = max(box1[1], box2[1])
    x2 = min(box1[2], box2[2])
    y2 = min(box1[3], box2[3])
    
    inter_area = max(0, x2 - x1) * max(0, y2 - y1)
    box1_area = (box1[2] - box1[0]) * (box1[3] - box1[1])
    box2_area = (box2[2] - box2[0]) * (box2[3] - box2[1])
    
    return inter_area / float(box1_area + box2_area - inter_area)

def analyze_crowd_density(frame, model, classifier, transform, device):
    """Analyze crowd density using ResNet"""
    if model is None or classifier is None:
        return 0.0, "Unknown", 0.0
    
    try:
        frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        input_tensor = transform(frame_rgb).unsqueeze(0).to(device)
        
        with torch.no_grad():
            density_map, crowd_level = classifier(input_tensor)
            
            total_count = torch.sum(density_map).item()
            
            crowd_probs = crowd_level[0]
            crowd_class = torch.argmax(crowd_probs).item()
            crowd_confidence = torch.max(crowd_probs).item()
            
            crowd_labels = ["Low", "Medium", "High", "Very High"]
            crowd_label = crowd_labels[crowd_class]
            
            return total_count, crowd_label, crowd_confidence
            
    except Exception as e:
        logger.warning(f"Error in crowd analysis: {e}")
        return 0.0, "Error", 0.0

def process_frame():
    """Main frame processing function"""
    global current_stats, frame_buffer, cap
    
    if not detection_running or cap is None:
        return
    
    start_time = time.time()
    ret, frame = cap.read()
    
    if not ret:
        logger.warning("Failed to read frame from camera")
        return
    
    try:
        # YOLO detection for people
        results = yolo_model(frame, verbose=False, conf=MIN_CONFIDENCE)
        people_boxes = []
        
        for r in results:
            for box in r.boxes:
                cls = int(box.cls[0])
                conf = float(box.conf[0])
                if yolo_model.names[cls] == "person":
                    x1, y1, x2, y2 = map(int, box.xyxy[0])
                    
                    # Validate bounding box
                    if x2 <= x1 or y2 <= y1 or x1 < 0 or y1 < 0 or x2 >= frame.shape[1] or y2 >= frame.shape[0]:
                        continue
                    
                    people_boxes.append((x1, y1, x2, y2, conf))
        
        # Format detections for DeepSORT
        formatted_detections = []
        for x1, y1, x2, y2, conf in people_boxes:
            formatted_detections.append(([x1, y1, x2, y2], conf, 0))
        
        # Update tracker
        tracks = tracker.update_tracks(formatted_detections, frame=frame)
        
        # Process tracked objects
        tracked_people = []
        active_track_ids = []
        tracking_info = []
        
        for track in tracks:
            if not track.is_confirmed():
                continue
            
            track_id = track.track_id
            ltrb = track.to_ltrb()
            x1, y1, x2, y2 = map(int, ltrb)
            active_track_ids.append(track_id)
            
            # Find best matching detection
            best_match = None
            best_iou = 0
            for det in people_boxes:
                det_box = det[:4]
                iou = calculate_iou(ltrb, det_box)
                if iou > best_iou:
                    best_iou = iou
                    best_match = det
            
            if best_match and best_iou > 0.3:
                conf = best_match[4]
            else:
                conf = 0.7
            
            tracked_people.append((x1, y1, x2, y2, track_id, conf))
            
            # Add to tracking info for frontend
            tracking_info.append({
                'track_id': track_id,
                'position': f"({x1},{y1})",
                'confidence': round(conf, 2),
                'status': 'Confirmed'
            })
        
        # Calculate density and device status
        people_count = len(tracked_people)
        density = people_count / CAMERA_FOV_M2
        device_status = "on" if people_count > 0 else "off"

        # Control GPIO devices
        try:
            if device_status == "on":
                turn_on_device()
                if 'fan' in devices:
                    # Map density to speed (e.g., 30% to 100%)
                    speed = min(100, max(30, int(density * 200)))
                    devices['fan']['state'] = True
                    devices['fan']['speed'] = speed
                if 'light' in devices:
                    # Map density to brightness (e.g., 40% to 100%)
                    brightness = min(100, max(40, int(density * 250)))
                    devices['light']['state'] = True
                    devices['light']['brightness'] = brightness
                if 'tv' in devices:
                    # Map density to volume (e.g., 10 to 100)
                    volume = min(100, max(10, int(density * 150)))
                    devices['tv']['state'] = True
                    devices['tv']['volume'] = volume
            else:
                turn_off_device()
                if 'fan' in devices:
                    devices['fan']['state'] = False
                    devices['fan']['speed'] = 0
                if 'light' in devices:
                    devices['light']['state'] = False
                    devices['light']['brightness'] = 0
                if 'tv' in devices:
                    devices['tv']['state'] = False
                    devices['tv']['volume'] = 0
        except Exception as e:
            logger.warning(f"GPIO control error: {e}")
        
        # Analyze crowd density with ResNet
        crowd_level = "Unknown"
        crowd_confidence = 0.0
        if USE_RESNET and resnet_model is not None:
            _, crowd_level, crowd_confidence = analyze_crowd_density(
                frame, resnet_model, crowd_classifier, resnet_transform, torch_device
            )
        
        # Calculate processing time and FPS
        processing_time = (time.time() - start_time) * 1000
        fps = 1000 / processing_time if processing_time > 0 else 0
        
        # Update global stats
        current_stats.update({
            'people_count': people_count,
            'density': round(density, 4),
            'device_status': device_status,
            'crowd_level': crowd_level,
            'crowd_confidence': round(crowd_confidence, 2),
            'tracked_ids': active_track_ids,
            'tracking_info': tracking_info,
            'processing_time': round(processing_time, 2),
            'fps': round(fps, 1),
            'frame_count': current_stats['frame_count'] + 1
        })
        
        # Draw tracking results on frame
        for x1, y1, x2, y2, track_id, conf in tracked_people:
            # Draw bounding box
            cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
            
            # Draw track ID and confidence
            label = f"ID:{track_id} ({conf:.2f})"
            cv2.putText(frame, label, (x1, y1 - 5), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 2)
        
        # Draw system info on frame
        cv2.putText(frame, f"People: {people_count}", (10, 30), 
                   cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 0), 2)
        cv2.putText(frame, f"Density: {density:.4f} ppl/m² | Device: {device_status.upper()}", 
                   (10, 60), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 255, 0), 2)
        cv2.putText(frame, f"Crowd: {crowd_level} ({crowd_confidence:.2f})", 
                   (10, 90), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 0, 255), 2)
        cv2.putText(frame, f"FPS: {fps:.1f} | Tracks: {len(active_track_ids)}", 
                   (10, 120), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 255), 2)
        
        # Update frame buffer
        frame_buffer = frame.copy()
        
        # Log to CSV
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        tracked_ids_str = ",".join(map(str, active_track_ids)) if active_track_ids else "None"
        
        with open(CSV_FILE, mode='a', newline='') as file:
            writer = csv.writer(file)
            writer.writerow([
                timestamp,
                f"Camera {CAMERA_ID}",
                people_count,
                f"{density:.4f}",
                device_status.upper(),
                f"{crowd_level} ({crowd_confidence:.2f})",
                tracked_ids_str,
                f"{processing_time:.2f}"
            ])
        
    except Exception as e:
        logger.error(f"Error processing frame: {e}")

def detection_loop():
    """Main detection loop running in separate thread"""
    global detection_running, cap
    
    logger.info("Starting detection loop")
    
    while detection_running:
        try:
            process_frame()
            time.sleep(0.033)  # ~30 FPS
        except Exception as e:
            logger.error(f"Error in detection loop: {e}")
            time.sleep(1)
    
    logger.info("Detection loop stopped")

def generate_frames():
    """Generate frames for video streaming"""
    global frame_buffer
    
    while True:
        if frame_buffer is not None and detection_running:
            try:
                # Encode frame as JPEG
                _, buffer = cv2.imencode('.jpg', frame_buffer, [cv2.IMWRITE_JPEG_QUALITY, 85])
                frame_bytes = buffer.tobytes()
                
                yield (b'--frame\r\n'
                       b'Content-Type: image/jpeg\r\n\r\n' + frame_bytes + b'\r\n')
            except Exception as e:
                logger.error(f"Error generating frame: {e}")
        else:
            # Send placeholder image when detection is not running
            placeholder = np.zeros((480, 640, 3), dtype=np.uint8)
            cv2.putText(placeholder, "Camera Feed Stopped", (200, 240), 
                       cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 255), 2)
            
            _, buffer = cv2.imencode('.jpg', placeholder)
            frame_bytes = buffer.tobytes()
            
            yield (b'--frame\r\n'
                   b'Content-Type: image/jpeg\r\n\r\n' + frame_bytes + b'\r\n')
        
        time.sleep(0.033)  # ~30 FPS

@app.route('/api/detection_status')
def detection_status():
    """Get current detection status and stats with device integration"""
    # Calculate overall device status
    any_device_on = any(d.get('state') for d in devices.values()) 
    return jsonify({
        'running': detection_running,
        'stats': {
            **current_stats,
            'devices': devices,
            'device_status': 'on' if any_device_on else current_stats.get('device_status', 'off'),
            'total_devices': len(devices),
            'active_devices': sum(1 for d in devices.values() if d.get('state'))
        }
    })


@app.route('/api/start_detection', methods=['POST'])
def start_detection():
    """Start detection process"""
    global detection_running, cap
    
    try:
        if not detection_running:
            # Initialize camera
            cap = cv2.VideoCapture(CAMERA_ID)
            if not cap.isOpened():
                return jsonify({'error': 'Cannot access camera'}), 500
            
            # Set camera properties
            cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
            cap.set(cv2.CAP_PROP_FPS, 30)
            cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
            cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
            
            detection_running = True
            
            # Start detection thread
            detection_thread = threading.Thread(target=detection_loop, daemon=True)
            detection_thread.start()
            
            logger.info("Detection started successfully")
            return jsonify({'status': 'Detection started'})
        else:
            return jsonify({'status': 'Detection already running'})
            
    except Exception as e:
        logger.error(f"Error starting detection: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/stop_detection', methods=['POST'])
def stop_detection():
    """Stop detection process"""
    global detection_running, cap, frame_buffer
    
    try:
        if detection_running:
            detection_running = False
            
            # Release camera
            if cap is not None:
                cap.release()
                cap = None
            
            # Clear frame buffer
            frame_buffer = None
            
            # Reset stats
            current_stats.update({
                'people_count': 0,
                'density': 0.0,
                'device_status': 'off',
                'crowd_level': 'unknown',
                'crowd_confidence': 0.0,
                'tracked_ids': [],
                'tracking_info': [],
                'processing_time': 0,
                'fps': 0
            })
            
            # Turn off devices
            try:
                turn_off_device()
            except:
                pass
            
            logger.info("Detection stopped successfully")
            return jsonify({'status': 'Detection stopped'})
        else:
            return jsonify({'status': 'Detection not running'})
            
    except Exception as e:
        logger.error(f"Error stopping detection: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/video_feed')
def video_feed():
    """Video streaming route"""
    return Response(generate_frames(), 
                   mimetype='multipart/x-mixed-replace; boundary=frame')

@app.route('/api/system_info')
def system_info():
    """Get system information"""
    return jsonify({
        'device': str(devices),
        'yolo_model': YOLO_MODEL_PATH,
        'resnet_enabled': USE_RESNET,
        'camera_id': CAMERA_ID,
        'camera_fov': CAMERA_FOV_M2,
        'density_threshold': DENSITY_THRESHOLD
    })

# Device Control API Routes (Added from pasted code)
@app.route('/device-control')
def device_control():
    """Render the device control page"""
    return render_template('device-control.html')

@app.route('/api/devices', methods=['GET'])
def get_devices():
    """Get all devices and their current states"""
    try:
        return jsonify({
            'status': 'success',
            'devices': devices,
            'timestamp': datetime.now().isoformat()
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500
    

@app.route('/api/device/toggle', methods=['POST'])
def toggle_device():
    """Toggle device on/off state"""
    try:
        data = request.get_json()
        device_id = data.get('device')
        new_state = data.get('state')

        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404
        
        # Update device state
        devices[device_id]['state'] = new_state
        devices[device_id]['last_updated'] = datetime.now().isoformat()

        # If turning off, reset control values
        if not new_state:
            if 'speed' in devices[device_id]:
                devices[device_id]['speed'] = 0
            if 'brightness' in devices[device_id]:
                devices[device_id]['brightness'] = 0
            if 'volume' in devices[device_id]:
                devices[device_id]['volume'] = 0
            if 'temperature' in devices[device_id]:
                devices[device_id]['temperature'] = 0

        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'toggle',
            'state': new_state,
            'timestamp': datetime.now().isoformat(),
            'device_name': devices[device_id]['name']
        })
        
        return jsonify({
            'status': 'success',
            'device': device_id,
            'new_state': new_state,
            'message': f"Device {devices[device_id]['name']} turned {'on' if new_state else 'off'}",
            'timestamp': devices[device_id]['last_updated']
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/control', methods=['POST'])
def control_device():
    """Update device control settings (brightness, speed, volume, etc.)"""
    try:
        data = request.get_json()
        device_id = data.get('device')
        control_type = data.get('control')
        value = data.get('value')
        
        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404
        
        # Validate control type and update device
        valid_controls = {
            'speed': ['fan'],
            'brightness': ['light'],
            'volume': ['tv'],
            'temperature': ['ac']
        }
        
        # Extract base device type from device_id (handles dynamic IDs like 'fan-123456')
        base_device_type = device_id.split('-')[0]
        valid_controls = {
            'speed': ['fan'],
            'brightness': ['light'],
            'volume': ['tv'],
            'temperature': ['ac']
        }

        if control_type not in valid_controls or base_device_type not in valid_controls[control_type]:
            return jsonify({
                'status': 'error',
                'message': f"Invalid control type '{control_type}' for device type '{base_device_type}'"
            }), 400

        # Validate value
        if not isinstance(value, (int, float)):
            return jsonify({
                'status': 'error',
                'message': f"Invalid value type for control '{control_type}'. Expected int or float."
            }), 400

        # Update the control value
        devices[device_id][control_type] = value
        devices[device_id]['last_updated'] = datetime.now().isoformat()

        # Auto-turn on device if control value > 0
        if value > 0:
            devices[device_id]['state'] = True

        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'control_update',
            'control_type': control_type,
            'value': value,
            'timestamp': datetime.now().isoformat(),
            'device_name': devices[device_id]['name']
        })
        
        return jsonify({
            'status': 'success',
            'device': device_id,
            'control': control_type,
            'value': value,
            'message': f"{devices[device_id]['name']} {control_type} set to {value}%",
            'timestamp': devices[device_id]['last_updated']
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/add', methods=['POST'])
def add_device():
    """Add a new device to the system"""
    try:
        data = request.get_json()
        device_type = data.get('type')
        device_name = data.get('name')
        device_room = data.get('room')
        
        if not all([device_type, device_name, device_room]):
            return jsonify({
                'status': 'error',
                'message': 'Missing required fields: type, name, room'
            }), 400
        
        # Generate unique device ID
        import time
        device_id = f"{device_type}-{int(time.time())}"
        
        # Create device configuration based on type
        device_config = {
            'name': device_name,
            'state': False,
            'room': device_room,
            'type': device_type,
            'last_updated': datetime.now().isoformat(),
            'created_at': datetime.now().isoformat()
        }
        
        # Add type-specific controls
        if device_type == 'fan':
            device_config['speed'] = 1
        elif device_type == 'light':
            device_config['brightness'] = 0
        elif device_type == 'tv':
            device_config['volume'] = 0
        elif device_type == 'ac':
            device_config['temperature'] = 20  # Default temperature
        
        # Add device to storage
        devices[device_id] = device_config
        
        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'device_added',
            'device_type': device_type,
            'device_name': device_name,
            'room': device_room,
            'timestamp': datetime.now().isoformat()
        })
        
        return jsonify({
            'status': 'success',
            'device_id': device_id,
            'device': device_config,
            'message': f"Device '{device_name}' added successfully"
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/remove/<device_id>', methods=['DELETE'])
def remove_device(device_id):
    """Remove a device from the system"""
    try:
        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404

        device_name = devices[device_id]['name']
        del devices[device_id]

        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'device_removed',
            'device_name': device_name,
            'timestamp': datetime.now().isoformat()
        })
        
        return jsonify({
            'status': 'success',
            'message': f"Device '{device_name}' removed successfully"
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/history', methods=['GET'])
def get_device_history():
    """Get device control history"""
    try:
        # Get last N entries (default 50)
        limit = request.args.get('limit', 50, type=int)
        
        return jsonify({
            'status': 'success',
            'history': device_history[-limit:],
            'total_entries': len(device_history)
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/stats', methods=['GET'])
def get_device_stats():
    """Get device statistics"""
    try:
        stats = {
            'total_devices': len(devices),
            'active_devices': sum(1 for d in devices.values() if d.get('state')),
            'inactive_devices': sum(1 for d in devices.values() if not d.get('state')),
            'devices_by_room': {},
            'devices_by_type': {}
        }
        
        # Count devices by room and type
        for d in devices.values():
            room = d.get('room', 'Unknown')
            device_type = d.get('type', 'Unknown')

            stats['devices_by_room'][room] = stats['devices_by_room'].get(room, 0) + 1
            stats['devices_by_type'][device_type] = stats['devices_by_type'].get(device_type, 0) + 1
        
        return jsonify({
            'status': 'success',
            'stats': stats,
            'timestamp': datetime.now().isoformat()
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/density')
def get_density():
    """Get current density from live detection stats"""
    return jsonify({
        "density": current_stats.get('density', 0),
        "people_count": current_stats.get('people_count', 0),
        "device_status": current_stats.get('device_status', 'off'),
        "timestamp": datetime.now().isoformat()
    })

@app.route('/api/device/status/<device_id>', methods=['GET'])
def get_device_status(device_id):
    """Get specific device status"""
    try:
        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404
        
        return jsonify({
            'status': 'success',
            'device_id': device_id,
            'device': devices[device_id]
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

# Error handlers
@app.errorhandler(404)
def not_found_error(error):
    return jsonify({
        'status': 'error',
        'message': 'Endpoint not found'
    }), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({
        'status': 'error',
        'message': 'Internal server error'
    }), 500

if __name__ == '__main__':
    try:
        logger.info("Starting Crowd Management System Backend")
        logger.info(f"Using devices: {devices}")
        logger.info(f"ResNet enabled: {USE_RESNET}")
        logger.info("Starting Flask server on http://0.0.0.0:5000")
        
        app.run(host='0.0.0.0', port=5000, debug=False, threaded=True)
        
    except KeyboardInterrupt:
        logger.info("Shutting down...")
    finally:
        # Cleanup
        detection_running = False
        if cap is not None:
            cap.release()
        cleanup_gpio()
        cv2.destroyAllWindows()
        logger.info("Cleanup completed")



----------------------------------------------****************************************************************-------------------------------------




device-control.html 


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Device Control System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2rem;
            font-weight: 600;
        }

        .header h1 i {
            color: #667eea;
            margin-right: 10px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            text-decoration: none;
            color: #4a5568;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            gap: 30px;
        }

        .section-title {
            color: white;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .device-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .device-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #4a5568;
        }

        .device-icon {
            font-size: 1.8rem;
            padding: 10px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .power-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .power-switch.on {
            background: #48bb78;
        }

        .power-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .power-switch.on::after {
            transform: translateX(30px);
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e53e3e;
        }

        .status-indicator.active {
            background: #48bb78;
        }

        .controls-section {
            margin-top: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .slider-container {
            position: relative;
            margin-bottom: 10px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #718096;
        }

        .current-value {
            font-weight: 600;
            color: #667eea;
        }

        .add-device-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
        }

        .add-device-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .add-device-card i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .add-device-card h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #4a5568;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #4a5568;
        }

        .device-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .device-type {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .device-type:hover,
        .device-type.selected {
            border-color: #667eea;
            background: #f7fafc;
        }

        .device-type i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 40px;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .devices-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-home"></i> Smart Device Control</h1>
            <nav class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-users"></i> Crowd Management</a>
                <a href="/device-control.html" class="nav-link active"><i class="fas fa-home"></i> Device Control</a>
            </nav>
            <div class="auth-buttons">
                <button id="login-btn" class="btn btn-primary">Login</button>
                <button id="logout-btn" class="btn btn-danger" style="display: none;">Logout</button>
            </div>
        </header>

        <main class="main-content">
            <h2 class="section-title">
                <i class="fas fa-microchip"></i>
                Connected Devices
            </h2>

            <div class="devices-grid" id="devices-grid">
                <!-- Fan Device -->
                <div class="device-card" data-device="fan">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-fan"></i>
                            </div>
                            <span>Ceiling Fan</span>
                        </div>
                        <div class="power-switch" data-device="fan"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Speed Control</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="speed">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Light Device -->
                <div class="device-card" data-device="light">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <span>Smart Light</span>
                        </div>
                        <div class="power-switch" data-device="light"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Brightness</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="brightness">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TV Device -->
                <div class="device-card" data-device="tv">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-tv"></i>
                            </div>
                            <span>Smart TV</span>
                        </div>
                        <div class="power-switch" data-device="tv"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Volume</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="volume">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Device Card -->
                <div class="device-card add-device-card" id="add-device-btn">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Add New Device</h3>
                    <p>Connect a new smart device</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Made with 💡 by Yesvin Veluchamy for Summer Internship &copy; 2025</p>
        </footer>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Device</h2>
                <span class="close">&times;</span>
            </div>
            
            <div class="device-types">
                <div class="device-type" data-type="fan">
                    <i class="fas fa-fan"></i>
                    <div>Fan</div>
                </div>
                <div class="device-type" data-type="light">
                    <i class="fas fa-lightbulb"></i>
                    <div>Light</div>
                </div>
                <div class="device-type" data-type="tv">
                    <i class="fas fa-tv"></i>
                    <div>TV</div>
                </div>
                <div class="device-type" data-type="ac">
                    <i class="fas fa-snowflake"></i>
                    <div>AC</div>
                </div>
            </div>

            <form id="deviceForm">
                <div class="form-group">
                    <label for="deviceName">Device Name</label>
                    <input type="text" id="deviceName" name="deviceName" placeholder="Enter device name" required>
                </div>
                
                <div class="form-group">
                    <label for="deviceRoom">Room</label>
                    <select id="deviceRoom" name="deviceRoom" required>
                        <option value="">Select Room</option>
                        <option value="living-room">Living Room</option>
                        <option value="bedroom">Bedroom</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="bathroom">Bathroom</option>
                        <option value="office">Office</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Device</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables for device management
        let devices = {};
        let selectedDeviceType = '';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadDevices();
            setInterval(loadDevices, 2000); // Poll backend every 2 seconds for real-time sync
        });

        function initializeEventListeners() {
            // Power switch toggles
            document.querySelectorAll('.power-switch').forEach(switchEl => {
                switchEl.addEventListener('click', function() {
                    const deviceId = this.closest('.device-card').getAttribute('data-device');
                    sendDeviceState(deviceId, !this.classList.contains('on'));
                });
            });

            // Slider controls
            document.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('change', function() {
                    const value = this.value;
                    const deviceCard = this.closest('.device-card');
                    const deviceId = deviceCard.getAttribute('data-device');
                    const controlType = this.getAttribute('data-control');
                    sendControlUpdate(deviceId, controlType, value);
                });
            });

            // Add device modal
            const modal = document.getElementById('addDeviceModal');
            const addBtn = document.getElementById('add-device-btn');
            const closeBtn = document.querySelector('.close');

            addBtn.addEventListener('click', () => {
                modal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                resetModal();
            });

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    resetModal();
                }
            });

            // Device type selection
            document.querySelectorAll('.device-type').forEach(type => {
                type.addEventListener('click', function() {
                    document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDeviceType = this.getAttribute('data-type');
                });
            });

            // Form submission
            document.getElementById('deviceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewDevice();
            });

            // Auth buttons
            document.getElementById('login-btn').addEventListener('click', () => {
                // Simulate login - in real implementation, this would redirect to login page
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'block';
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'none';
            });
        }

        function sendDeviceState(deviceId, isOn) {
            fetch('/api/device/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, state: isOn })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device state updated:', data);
            })
            .catch(error => {
                console.error('Error updating device state:', error);
            });
        }

        function sendControlUpdate(deviceId, controlType, value) {
            fetch('/api/device/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, control: controlType, value: parseInt(value) })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device control updated:', data);
            })
            .catch(error => {
                console.error('Error updating device control:', error);
            });
        }

        function addNewDevice() {
            if (!selectedDeviceType) {
                alert('Please select a device type');
                return;
            }
            const deviceName = document.getElementById('deviceName').value;
            const deviceRoom = document.getElementById('deviceRoom').value;
            if (!deviceName || !deviceRoom) {
                alert('Please fill in all fields');
                return;
            }
            fetch('/api/device/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: selectedDeviceType, name: deviceName, room: deviceRoom })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('addDeviceModal').style.display = 'none';
                resetModal();
                // UI will update on next poll from backend
            })
            .catch(error => {
                console.error('Error adding new device:', error);
            });
        }

        function resetModal() {
            document.getElementById('deviceForm').reset();
            document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
            selectedDeviceType = '';
        }

        function loadDevices() {
            fetch('/api/devices')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateDevicesUI(data.devices);
                }
            })
            .catch(error => {
                console.error('Error loading devices:', error);
            });
        }

        function updateDevicesUI(devices) {
            for (const [deviceId, deviceInfo] of Object.entries(devices)) {
                const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
                if (deviceCard) {
                    // Power switch
                    const powerSwitch = deviceCard.querySelector('.power-switch');
                    if (powerSwitch) {
                        if (deviceInfo.state) {
                            powerSwitch.classList.add('on');
                            powerSwitch.classList.remove('off');
                        } else {
                            powerSwitch.classList.remove('on');
                            powerSwitch.classList.add('off');
                        }
                    }
                    // Status indicator
                    const statusIndicator = deviceCard.querySelector('.status-indicator');
                    const statusText = deviceCard.querySelector('.status-text');
                    if (statusIndicator && statusText) {
                        if (deviceInfo.state) {
                            statusIndicator.classList.add('active');
                            statusText.textContent = 'Online';
                        } else {
                            statusIndicator.classList.remove('active');
                            statusText.textContent = 'Offline';
                        }
                    }
                    // Sliders
                    const sliders = deviceCard.querySelectorAll('.slider');
                    sliders.forEach(slider => {
                        const controlType = slider.getAttribute('data-control');
                        if (deviceInfo[controlType] !== undefined) {
                            slider.value = deviceInfo[controlType];
                            const currentValueSpan = slider.parentElement.querySelector('.current-value');
                            if (currentValueSpan) {
                                currentValueSpan.textContent = deviceInfo[controlType] + '%';
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>


----------------------------------------------****************************************************************-------------------------------------


device-control.js 



// Device Control System JavaScript
// Updated to work with the existing Flask API endpoints

// DOM Elements
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const mainContent = document.getElementById('main-content');
const devicesGrid = document.getElementById('devices-grid');
const systemStatus = document.getElementById('system-status');

// State variables (using memory instead of localStorage)
let isAuthenticated = false;
let deviceStates = {};
let authToken = null;
let detectionRunning = false;
let currentStats = {};

// API Base URL
const API_BASE = '/api';

// Initialize the application
function init() {
    console.log('🚀 Initializing Device Control System...');
    checkAuthStatus();
    setupEventListeners();
    // Load devices first, then start control loop after devices are loaded
    loadDevicesFromServer().then(() => {
        console.log('✅ Devices loaded successfully');
        // Delay starting the density control to ensure DOM is ready
        setTimeout(() => {
            startDensityControlLoop();
            console.log('🔄 Density control loop started');
        }, 1000);
    }).catch(err => {
        console.error('❌ Error loading devices:', err);
    });
    loadSystemStatus();
    updateUI();
    
    // Start periodic updates
    setInterval(updateSystemStatus, 2000); // Update every 2 seconds
    setInterval(loadDevices, 2000);
}

// Authentication functions
function checkAuthStatus() {
    // In a real application, you would check with your server
    // For now, we'll use a simple in-memory authentication state
    isAuthenticated = authToken !== null;
    console.log('Authentication status:', isAuthenticated);
}

function setupEventListeners() {
    // Authentication event listeners
    if (loginBtn) {
        loginBtn.addEventListener('click', () => {
            simulateLogin();
        });
    }
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
    }
    
    // Detection control buttons
    const startDetectionBtn = document.getElementById('start-detection-btn');
    const stopDetectionBtn = document.getElementById('stop-detection-btn');
    
    if (startDetectionBtn) {
        startDetectionBtn.addEventListener('click', startDetection);
    }
    
    if (stopDetectionBtn) {
        stopDetectionBtn.addEventListener('click', stopDetection);
    }
    
    // Device switch toggles
    document.querySelectorAll('.power-switch').forEach(switchEl => {
        switchEl.addEventListener('click', function() {
            const deviceId = this.getAttribute('data-device');
            toggleDeviceState(deviceId, this);
        });
    });
    
    // Slider controls
    document.querySelectorAll('.slider').forEach(slider => {
        slider.addEventListener('input', function() {
            const value = this.value;
            const currentValueSpan = this.parentElement.querySelector('.current-value');
            if (currentValueSpan) {
                currentValueSpan.textContent = value + '%';
            }
            
            const deviceCard = this.closest('.device-card');
            const deviceId = deviceCard.getAttribute('data-device');
            const controlType = this.getAttribute('data-control');
            
            updateDeviceControl(deviceId, controlType, value);
        });
    });
    
    // Add device button
    const addDeviceBtn = document.getElementById('add-device-btn');
    if (addDeviceBtn) {
        addDeviceBtn.addEventListener('click', function() {
            showAddDeviceModal();
        });
    }
    
    // Modal event listeners
    setupModalEventListeners();
}

function setupModalEventListeners() {
    const modal = document.getElementById('addDeviceModal');
    const closeBtn = document.querySelector('.close');
    
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            hideAddDeviceModal();
        });
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideAddDeviceModal();
        }
    });

    window.location.href = '/frontend/device-control.html';
        fetch('/frontend/device-control.html');
    
    // Device type selection
    document.querySelectorAll('.device-type').forEach(type => {
        type.addEventListener('click', function() {
            document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
            this.classList.add('selected');
        });
    });
    
    // Form submission
    const deviceForm = document.getElementById('deviceForm');
    if (deviceForm) {
        deviceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleAddDevice();
        });
    }
}

function simulateLogin() {
    // Simulate authentication
    authToken = 'simulated-token-' + Date.now();
    isAuthenticated = true;
    updateUI();
    console.log('Logged in successfully');
}

function logout() {
    authToken = null;
    isAuthenticated = false;
    deviceStates = {};
    updateUI();
    console.log('Logged out successfully');
}

function updateUI() {
    // Update authentication UI
    if (loginBtn) {
        loginBtn.style.display = isAuthenticated ? 'none' : 'block';
    }
    if (logoutBtn) {
        logoutBtn.style.display = isAuthenticated ? 'block' : 'none';
    }
    
    if (mainContent) {
        mainContent.style.display = isAuthenticated ? 'block' : 'none';
    }
}

// Detection Control Functions
function startDetection() {
    fetch(`${API_BASE}/start_detection`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Detection started:', data);
        detectionRunning = true;
        updateDetectionUI();
        showNotification('Detection started successfully', 'success');
    })
    .catch(error => {
        console.error('Error starting detection:', error);
        showNotification('Failed to start detection', 'error');
    });
}

function stopDetection() {
    fetch(`${API_BASE}/stop_detection`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Detection stopped:', data);
        detectionRunning = false;
        updateDetectionUI();
        showNotification('Detection stopped successfully', 'success');
    })
    .catch(error => {
        console.error('Error stopping detection:', error);
        showNotification('Failed to stop detection', 'error');
    });
}

function updateDetectionUI() {
    const startBtn = document.getElementById('start-detection-btn');
    const stopBtn = document.getElementById('stop-detection-btn');
    const statusIndicator = document.getElementById('detection-status');
    
    if (startBtn) startBtn.disabled = detectionRunning;
    if (stopBtn) stopBtn.disabled = !detectionRunning;
    
    if (statusIndicator) {
        statusIndicator.textContent = detectionRunning ? 'Running' : 'Stopped';
        statusIndicator.className = detectionRunning ? 'status-active' : 'status-inactive';
    }
}

// System Status Functions
function loadSystemStatus() {
    fetch(`${API_BASE}/detection_status`)
    .then(response => response.json())
    .then(data => {
        detectionRunning = data.running;
        currentStats = data.stats;
        updateSystemStatusUI(data);
        updateDetectionUI();
    })
    .catch(error => {
        console.error('Error loading system status:', error);
    });
}

function updateSystemStatus() {
    if (!isAuthenticated) return;
    
    fetch(`${API_BASE}/detection_status`)
    .then(response => response.json())
    .then(data => {
        detectionRunning = data.running;
        currentStats = data.stats;
        updateSystemStatusUI(data);
    })
    .catch(error => {
        console.error('Error updating system status:', error);
    });
}

function updateSystemStatusUI(data) {
    // Update people count
    const peopleCountEl = document.getElementById('people-count');
    if (peopleCountEl) {
        peopleCountEl.textContent = data.stats.people_count || 0;
    }
    
    // Update density
    const densityEl = document.getElementById('density-value');
    if (densityEl) {
        densityEl.textContent = (data.stats.density || 0).toFixed(4);
    }
    
    // Update device status
    const deviceStatusEl = document.getElementById('auto-device-status');
    if (deviceStatusEl) {
        deviceStatusEl.textContent = data.stats.device_status || 'off';
        deviceStatusEl.className = data.stats.device_status === 'on' ? 'status-on' : 'status-off';
    }
    
    // Update crowd level
    const crowdLevelEl = document.getElementById('crowd-level');
    if (crowdLevelEl) {
        crowdLevelEl.textContent = `${data.stats.crowd_level} (${data.stats.crowd_confidence}%)`;
    }
    
    // Update FPS
    const fpsEl = document.getElementById('fps-value');
    if (fpsEl) {
        fpsEl.textContent = data.stats.fps || 0;
    }
    
    // Update tracked IDs
    const trackedIdsEl = document.getElementById('tracked-ids');
    if (trackedIdsEl) {
        const ids = data.stats.tracked_ids || [];
        trackedIdsEl.textContent = ids.length > 0 ? ids.join(', ') : 'None';
    }
    
    // Update processing time
    const processingTimeEl = document.getElementById('processing-time');
    if (processingTimeEl) {
        processingTimeEl.textContent = `${data.stats.processing_time || 0}ms`;
    }
}

// Device Control Functions
function toggleDeviceState(deviceId, switchElement) {
    const isCurrentlyOn = switchElement.classList.contains('on');
    const newState = !isCurrentlyOn;

    // Optimistically update UI
    updateDeviceUI(deviceId, newState, switchElement);

    // Send to backend
    fetch(`${API_BASE}/device/toggle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device: deviceId, state: newState })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'success') {
            // If backend says error, revert UI
            updateDeviceUI(deviceId, isCurrentlyOn, switchElement);
            showNotification(data.message, 'error');
        }
    })
    .catch(() => {
        // On network error, revert UI
        updateDeviceUI(deviceId, isCurrentlyOn, switchElement);
        showNotification('Network error occurred', 'error');
    });
}

function updateDeviceUI(deviceId, isOn, switchElement) {
    const deviceCard = switchElement.closest('.device-card');
    const statusIndicator = deviceCard.querySelector('.status-indicator');
    const statusText = deviceCard.querySelector('.status-text');
    
    if (isOn) {
        switchElement.classList.add('on');
        switchElement.classList.remove('off');
        if (statusIndicator) statusIndicator.classList.add('active');
        if (statusText) statusText.textContent = 'Online';
    } else {
        switchElement.classList.remove('on');
        switchElement.classList.add('off');
        if (statusIndicator) statusIndicator.classList.remove('active');
        if (statusText) statusText.textContent = 'Offline';
        
        // Reset all sliders to 0
        deviceCard.querySelectorAll('.slider').forEach(slider => {
            slider.value = 0;
            const currentValueSpan = slider.parentElement.querySelector('.current-value');
            if (currentValueSpan) {
                currentValueSpan.textContent = '0%';
            }
        });
    }
}

function updateDeviceControl(deviceId, controlType, value) {
    const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
    const slider = deviceCard.querySelector(`.slider[data-control="${controlType}"]`);
    const currentValueSpan = slider.parentElement.querySelector('.current-value');

    // Optimistically update UI
    slider.value = value;
    if (currentValueSpan) currentValueSpan.textContent = value + '%';

    // Send to backend
    fetch(`${API_BASE}/device/control`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device: deviceId, control: controlType, value: parseInt(value) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'success') {
            // If backend says error, revert UI (will be fixed on next poll)
            showNotification(data.message, 'error');
        }
    })
    .catch(() => {
        showNotification('Network error occurred', 'error');
    });
}

function showAddDeviceModal() {
    const modal = document.getElementById('addDeviceModal');
    if (modal) {
        modal.style.display = 'block';
    }
}

function hideAddDeviceModal() {
    const modal = document.getElementById('addDeviceModal');
    if (modal) {
        modal.style.display = 'none';
        resetAddDeviceForm();
    }
}

function resetAddDeviceForm() {
    const form = document.getElementById('deviceForm');
    if (form) {
        form.reset();
    }
    document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
}

function handleAddDevice() {
    const selectedType = document.querySelector('.device-type.selected');
    if (!selectedType) {
        showNotification('Please select a device type', 'error');
        return;
    }
    
    const deviceType = selectedType.getAttribute('data-type');
    const deviceName = document.getElementById('deviceName').value;
    const deviceRoom = document.getElementById('deviceRoom').value;
    
    if (!deviceName || !deviceRoom) {
        showNotification('Please fill in all fields', 'error');
        return;
    }
    
    // Send new device to server
    fetch(`${API_BASE}/device/add`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: deviceType,
            name: deviceName,
            room: deviceRoom
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('New device added:', data);
            // Create device card in UI
            createDeviceCard(data.device_id, data.device);
            hideAddDeviceModal();
            showNotification(data.message, 'success');
        } else {
            console.error('Error adding device:', data.message);
            showNotification('Error adding device: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        showNotification('Network error. Please try again.', 'error');
    });
}

function createDeviceCard(deviceId, device) {
    const devicesGrid = document.getElementById('devices-grid');
    const addDeviceCard = document.querySelector('.add-device-card');
    
    if (!devicesGrid) return;
    
    const icons = {
        fan: 'fas fa-fan',
        light: 'fas fa-lightbulb',
        tv: 'fas fa-tv',
        ac: 'fas fa-snowflake'
    };
    
    const controls = {
        fan: { label: 'Speed Control', type: 'speed' },
        light: { label: 'Brightness', type: 'brightness' },
        tv: { label: 'Volume', type: 'volume' },
        ac: { label: 'Temperature', type: 'temperature' }
    };
    
    const deviceType = device.type || 'unknown';
    const deviceCard = document.createElement('div');
    deviceCard.className = 'device-card';
    deviceCard.setAttribute('data-device', deviceId);
    
    deviceCard.innerHTML = `
        <div class="device-header">
            <div class="device-title">
                <div class="device-icon">
                    <i class="${icons[deviceType] || 'fas fa-microchip'}"></i>
                </div>
                <span>${device.name} (${device.room})</span>
            </div>
            <div class="power-switch off" data-device="${deviceId}"></div>
        </div>
        <div class="device-status">
            <div class="status-indicator"></div>
            <span class="status-text">Offline</span>
        </div>
        <div class="controls-section">
            <div class="control-group">
                <label class="control-label">${controls[deviceType]?.label || 'Control'}</label>
                <div class="slider-container">
                    <input type="range" class="slider" min="0" max="100" value="0" data-control="${controls[deviceType]?.type || 'value'}">
                    <div class="slider-value">
                        <span>0%</span>
                        <span class="current-value">0%</span>
                        <span>100%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="device-actions">
            <button class="remove-device-btn" onclick="removeDevice('${deviceId}')">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
    `;
    
    if (addDeviceCard) {
        devicesGrid.insertBefore(deviceCard, addDeviceCard);
    } else {
        devicesGrid.appendChild(deviceCard);
    }
    
    // Add event listeners to new device
    const powerSwitch = deviceCard.querySelector('.power-switch');
    const slider = deviceCard.querySelector('.slider');
    
    if (powerSwitch) {
        powerSwitch.addEventListener('click', function() {
            toggleDeviceState(deviceId, this);
        });
    }
    
    if (slider) {
        slider.addEventListener('input', function() {
            const value = this.value;
            const currentValueSpan = this.parentElement.querySelector('.current-value');
            if (currentValueSpan) {
                currentValueSpan.textContent = value + '%';
            }
            
            const controlType = this.getAttribute('data-control');
            updateDeviceControl(deviceId, controlType, value);
        });
    }
}

function removeDevice(deviceId) {
    if (!confirm('Are you sure you want to remove this device?')) {
        return;
    }
    
    fetch(`${API_BASE}/device/remove/${deviceId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Remove device card from UI
            const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
            if (deviceCard) {
                deviceCard.remove();
            }
            delete deviceStates[deviceId];
            showNotification(data.message, 'success');
        } else {
            showNotification('Error removing device: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        showNotification('Network error occurred', 'error');
    });
}

function loadDevicesFromServer() {
    console.log('📱 Loading devices from server...');
    return new Promise((resolve, reject) => {
        fetch('/api/devices')
            .then(async response => {
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Error response from server:', text);
                    throw new Error(`Server responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📱 Devices loaded:', data.devices);
                updateDevicesUI(data.devices);
                
                // Add debugging to see device structure
                if (data.devices) {
                    console.log('📊 Device structure:', JSON.stringify(data.devices, null, 2));
                }
                
                // Show debug info about device cards in DOM
                const deviceCards = document.querySelectorAll('.device-card');
                console.log(`📱 Found ${deviceCards.length} device cards in DOM:`);
                deviceCards.forEach(card => {
                    const id = card.getAttribute('data-device');
                    console.log(`- Device card: ${id}`);
                });
                
                resolve(data.devices);
            })
            .catch(error => {
                console.error('❌ Error loading devices:', error);
                reject(error);
            });
    });
}


function updateDevicesUI(devices) {
    Object.keys(devices).forEach(deviceId => {
        const device = devices[deviceId];
        const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
        if (deviceCard) {
            // Power switch
            const powerSwitch = deviceCard.querySelector('.power-switch');
            if (powerSwitch) {
                if (device.state) {
                    powerSwitch.classList.add('on');
                    powerSwitch.classList.remove('off');
                } else {
                    powerSwitch.classList.remove('on');
                    powerSwitch.classList.add('off');
                }
            }
            // Slider
            const slider = deviceCard.querySelector('.slider');
            if (slider) {
                const controlType = slider.getAttribute('data-control');
                if (device[controlType] !== undefined) {
                    slider.value = device[controlType];
                    const currentValueSpan = slider.parentElement.querySelector('.current-value');
                    if (currentValueSpan) {
                        currentValueSpan.textContent = device[controlType] + '%';
                    }
                }
            }
        }
    });
}

// Notification System
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button class="notification-close">&times;</button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
    
    // Manual close
    const closeBtn = notification.querySelector('.notification-close');
    closeBtn.addEventListener('click', () => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    });
}

// Load system information
function loadSystemInfo() {
    fetch(`${API_BASE}/system_info`)
    .then(response => response.json())
    .then(data => {
        console.log('System info:', data);
        // Update system info UI if elements exist
        const deviceEl = document.getElementById('system-device');
        if (deviceEl) deviceEl.textContent = data.device;
        
        const yoloEl = document.getElementById('yolo-model');
        if (yoloEl) yoloEl.textContent = data.yolo_model;
        
        const resnetEl = document.getElementById('resnet-enabled');
        if (resnetEl) resnetEl.textContent = data.resnet_enabled ? 'Yes' : 'No';
    })
    .catch(error => {
        console.error('Error loading system info:', error);
    });
}

// Density Control Config
const DENSITY_POLL_INTERVAL = 2000; // 2 seconds

function startDensityControlLoop() {
    console.log(`🔄 Starting density control loop (interval: ${DENSITY_POLL_INTERVAL}ms)`);
    
    // Run once immediately to check if everything works
    fetchAndApplyDensity().then(() => {
        console.log('✅ Initial density control check complete');
    }).catch(err => {
        console.error('❌ Error in initial density control:', err);
    });
    
    // Then start the interval
    setInterval(fetchAndApplyDensity, DENSITY_POLL_INTERVAL);
    // Also manually trigger the loop when detection status changes
    document.getElementById('start-detection-btn')?.addEventListener('click', () => {
        setTimeout(fetchAndApplyDensity, 1000);
    });
}

async function fetchAndApplyDensity() {
    try {
        // First get detection status to check people count
        const detectionRes = await fetch('/api/detection_status');
        const detectionData = await detectionRes.json();
        const peopleCount = detectionData.stats?.people_count || 0;
        
        // Get density data
        const densityRes = await fetch('/api/density');
        const densityData = await densityRes.json();
        const density = densityData.density || 0;

        // Clear debug log to track the automation process
        console.clear();
        console.log(`🔍 DETECTION DATA: People count: ${peopleCount}, Density: ${density}`);
        console.log(`⏱️ Time: ${new Date().toLocaleTimeString()}`);
        
        // Auto-control based on presence detection
        if (peopleCount > 0) {
            console.log("👤 PERSON DETECTED! Activating auto-control...");
            
            // Get all available devices in the DOM
            const deviceCards = document.querySelectorAll('.device-card');
            console.log(`📱 Found ${deviceCards.length} devices in DOM`);
            
            // List all devices found
            deviceCards.forEach(card => {
                const deviceId = card.getAttribute('data-device');
                console.log(`- Device found: ${deviceId}`);
            });
            
            // Turn on devices (if they're not already on)
            deviceCards.forEach(card => {
                const deviceId = card.getAttribute('data-device');
                if (deviceId === 'fan' || deviceId === 'light') {
                    turnOnDeviceIfNeeded(deviceId);
                }
            });
            
            // Calculate control values based on density
            // Map density to control value with a more sensitive scale
            // Higher density = higher control values (max 100)
            const fanSpeedValue = calculateControlValue(density, 0.3, 30, 100);
            const lightBrightnessValue = calculateControlValue(density, 0.3, 40, 100);
            
            console.log(`🎛️ AUTO-ADJUSTING: Fan: ${fanSpeedValue}%, Light: ${lightBrightnessValue}%`);
            
            // Apply to devices
            autoAdjustDevice('fan', 'speed', fanSpeedValue);
            autoAdjustDevice('light', 'brightness', lightBrightnessValue);
        } else {
            // No people detected - devices can remain in their current state
            console.log("❌ NO PEOPLE DETECTED - Devices remain in current state");
        }
    } catch (err) {
        console.error('❌ Density control error:', err);
    }
}

// Calculate control value based on density with custom scaling
function calculateControlValue(density, threshold, minValue, maxValue) {
    if (density <= 0) return 0;
    
    // Apply a non-linear scaling to make the control more responsive
    // Square root function gives more granular control at lower densities
    const scaledDensity = Math.sqrt(density) * 2;
    
    // Clamp the value between min and max
    return Math.min(maxValue, Math.max(minValue, Math.round(scaledDensity * 100)));
}

// Check and turn on a device if it's not already on
function turnOnDeviceIfNeeded(deviceId) {
    const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
    if (!deviceCard) {
        console.warn(`⚠️ Device not found: ${deviceId}`);
        return;
    }
    
    const powerSwitch = deviceCard.querySelector('.power-switch');
    if (!powerSwitch) {
        console.warn(`⚠️ Power switch not found for device: ${deviceId}`);
        return;
    }
    
    if (!powerSwitch.classList.contains('on')) {
        console.log(`🔌 AUTO-TURNING ON: ${deviceId}`);
        // Force change UI immediately
        powerSwitch.classList.add('on');
        powerSwitch.classList.remove('off');
        
        const statusIndicator = deviceCard.querySelector('.status-indicator');
        const statusText = deviceCard.querySelector('.status-text');
        
        if (statusIndicator) statusIndicator.classList.add('active');
        if (statusText) statusText.textContent = 'Online';
        
        // Then update server state
        toggleDeviceState(deviceId, powerSwitch);
    } else {
        console.log(`✓ Device already on: ${deviceId}`);
    }
}

function autoAdjustDevice(deviceId, controlType, value) {
    const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
    if (!deviceCard) {
        console.warn(`⚠️ Cannot adjust - Device not found: ${deviceId}`);
        return;
    }
    const slider = deviceCard.querySelector(`.slider[data-control="${controlType}"]`);
    if (!slider) {
        console.warn(`⚠️ Control slider not found: ${deviceId} - ${controlType}`);
        return;
    }
    
    const powerSwitch = deviceCard.querySelector('.power-switch');
    if (!powerSwitch) {
        console.warn(`⚠️ Power switch not found: ${deviceId}`);
        return;
    }

    // Ensure device is on before adjusting
    if (!powerSwitch.classList.contains('on')) {
        console.log(`🔌 Auto-turning on ${deviceId} before adjusting`);
        turnOnDeviceIfNeeded(deviceId);
    }
    
    // Only update if the value is different (reduces unnecessary updates)
    if (parseInt(slider.value) !== value) {
        console.log(`🎚️ Adjusting ${deviceId} ${controlType} to ${value}%`);
        
        // Force UI update immediately for responsive feel
        slider.value = value;
        
        // This triggers browser UI update for the slider
        const event = new Event('input', { bubbles: true });
        slider.dispatchEvent(event);
        
        const currentValueSpan = slider.parentElement.querySelector('.current-value');
        if (currentValueSpan) {
            currentValueSpan.textContent = value + '%';
        }
        
        // Update device control via API
        fetch(`${API_BASE}/device/control`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device: deviceId,
                control: controlType,
                value: parseInt(value)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log(`✓ Successfully adjusted ${deviceId} ${controlType}`);
                // Update local state
                if (!deviceStates[deviceId]) deviceStates[deviceId] = {};
                deviceStates[deviceId][controlType] = parseInt(value);
            } else {
                console.error(`❌ Error adjusting ${deviceId}: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('❌ Network error in auto-adjust:', error);
        });
    } else {
        console.log(`✓ ${deviceId} ${controlType} already at ${value}%`);
    }
}

// Poll and sync devices from server
function pollAndSyncDevices() {
    fetch('/api/devices')
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                updateDevicesUI(data.devices);
            }
        })
        .catch(err => console.error('Device poll error:', err));
}

// Call this every 2 seconds
setInterval(pollAndSyncDevices, 2000);

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    init();
    loadSystemInfo();
    startDensityControlLoop();
});



----------------------------------------------****************************************************************-------------------------------------


index.html


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crowd Management System</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-users"></i> Crowd Management System</h1>
      <div class="auth-buttons">
        <button id="login-btn" class="btn btn-primary">Login</button>
        <button id="logout-btn" class="btn btn-danger">Logout</button>
      </div>
      <nav class="nav-links">
        <a href="/" class="nav-link active"><i class="fas fa-users"></i> Crowd Management</a>
        <a href="/device-control.html" class="nav-link"><i class="fas fa-lightbulb"></i> Device Control</a>
      </nav>
    </header>

    <div class="login-modal" id="login-modal">
      <div class="modal-content">
        <span class="close-modal">×</span>
        <h2>Login</h2>
        <form id="login-form">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" required />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required />
          </div>
          <button type="submit" class="btn btn-primary">Login</button>
        </form>
      </div>
    </div>

    <main class="main-content" id="main-content">
      <section class="control-panel">
        <h2><i class="fas fa-sliders-h"></i> Control Panel</h2>
        <div class="control-buttons">
          <button id="start-detection" class="btn btn-success">
            <i class="fas fa-play"></i> Start Detection
          </button>
          <button id="stop-detection" class="btn btn-danger">
            <i class="fas fa-stop"></i> Stop Detection
          </button>
        </div>
        <div class="system-status">
          <span class="status-label">System Status:</span>
          <span id="system-status" class="status-badge stopped">Stopped</span>
        </div>
      </section>

      <section class="dashboard">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon people-icon"><i class="fas fa-user-friends"></i></div>
            <div class="stat-info">
              <h3>People Count</h3>
              <p id="people-count">0</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon density-icon"><i class="fas fa-chart-area"></i></div>
            <div class="stat-info">
              <h3>Density</h3>
              <p id="density">0.00 ppl/m²</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon crowd-icon"><i class="fas fa-tachometer-alt"></i></div>
            <div class="stat-info">
              <h3>Crowd Level</h3>
              <p id="crowd-level">Unknown (0%)</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon device-icon"><i class="fas fa-lightbulb"></i></div>
            <div class="stat-info">
              <h3>Device Status</h3>
              <p id="device-status">OFF</p>
            </div>
          </div>
        </div>

        <div class="video-container">
          <h2><i class="fas fa-video"></i> Live Feed</h2>
          <div class="video-wrapper">
            <img id="video-feed" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjQ4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhbWVyYSBGZWVkIE9mZmxpbmU8L3RleHQ+Cjwvc3ZnPg==" alt="Live camera feed" />
            <button id="fullscreen-btn" class="fullscreen-btn">
              <i class="fas fa-expand"></i>
            </button>
          </div>
          <div class="video-stats">
            <div class="video-stat">
              <span>FPS:</span> 
              <span id="fps" class="stat-value">0.0</span>
            </div>
            <div class="video-stat">
              <span>Processing Time:</span> 
              <span id="processing-time" class="stat-value">0.00 ms</span>
            </div>
            <div class="video-stat">
              <span>Frame Count:</span> 
              <span id="frame-count" class="stat-value">0</span>
            </div>
            <div class="video-stat">
              <span>Active Tracks:</span> 
              <span id="active-tracks" class="stat-value">0</span>
            </div>
          </div>
        </div>

        <div class="tracking-info">
          <h2><i class="fas fa-id-card"></i> Tracking Information</h2>
          <div class="tracking-summary">
            <div class="summary-item">
              <span>Total Tracked IDs:</span>
              <span id="total-tracked" class="summary-value">0</span>
            </div>
            <div class="summary-item">
              <span>Active Tracks:</span>
              <span id="active-tracks-summary" class="summary-value">0</span>
            </div>
          </div>
          <div class="tracking-table-container">
            <table class="tracking-table">
              <thead>
                <tr>
                  <th>Track ID</th>
                  <th>Position</th>
                  <th>Confidence</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tracking-data">
                <tr>
                  <td colspan="4" class="no-data">No tracking data available</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="system-info">
          <h2><i class="fas fa-info-circle"></i> System Information</h2>
          <div class="system-details">
            <div class="detail-item">
              <span>Processing Device:</span>
              <span id="processing-device">Unknown</span>
            </div>
            <div class="detail-item">
              <span>YOLO Model:</span>
              <span id="yolo-model">yolov8n.pt</span>
            </div>
            <div class="detail-item">
              <span>ResNet Enabled:</span>
              <span id="resnet-enabled">Unknown</span>
            </div>
            <div class="detail-item">
              <span>Camera FOV:</span>
              <span id="camera-fov">100 m²</span>
            </div>
            <div class="detail-item">
              <span>Density Threshold:</span>
              <span id="density-threshold">0.05 ppl/m²</span>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <p>Made with 🔥 by Yesvin Veluchamy for Summer Intern © 2025</p>
    </footer>
  </div>

  <script src="scripts.js"></script>
</body>
</html>




----------------------------------------------****************************************************************-------------------------------------


scripts.js


// DOM Elements
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loginModal = document.getElementById('login-modal');
const closeModal = document.querySelector('.close-modal');
const loginForm = document.getElementById('login-form');
const mainContent = document.getElementById('main-content');
const startDetectionBtn = document.getElementById('start-detection');
const stopDetectionBtn = document.getElementById('stop-detection');
const systemStatus = document.getElementById('system-status');
const fullscreenBtn = document.getElementById('fullscreen-btn');
const videoFeed = document.getElementById('video-feed');

// State variables
let isAuthenticated = false;
let isDetectionRunning = false;
let updateInterval;
let lastUpdateTime = 0;
let connectionRetries = 0;
const maxRetries = 3;

// API Configuration
const API_BASE_URL = '';
const API_ENDPOINTS = {
    startDetection: '/api/start_detection',
    stopDetection: '/api/stop_detection',
    getStatus: '/api/detection_status',
    videoFeed: '/video_feed',
    systemInfo: '/api/system_info'
};

// Initialize the application
function init() {
    console.log('Initializing Crowd Management System...');
    checkAuthStatus();
    setupEventListeners();
    updateUI();
    
    // Load system info on startup
    if (isAuthenticated) {
        loadSystemInfo();
        checkInitialDetectionStatus();
    }
}

// Authentication functions
function checkAuthStatus() {
    const token = localStorage.getItem('authToken');
    isAuthenticated = !!token;
    console.log('Authentication status:', isAuthenticated);
}

function setupEventListeners() {
    // Authentication event listeners
    loginBtn.addEventListener('click', () => {
        loginModal.style.display = 'flex';
        document.getElementById('username').focus();
    });
    
    logoutBtn.addEventListener('click', logout);
    closeModal.addEventListener('click', () => loginModal.style.display = 'none');
    loginForm.addEventListener('submit', handleLogin);
    
    // Detection control event listeners
    startDetectionBtn.addEventListener('click', startDetection);
    stopDetectionBtn.addEventListener('click', stopDetection);
    
    // Video controls
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    videoFeed.addEventListener('click', toggleFullscreen);
    
    // Modal close on outside click
    window.addEventListener('click', (e) => {
        if (e.target === loginModal) {
            loginModal.style.display = 'none';
        }
    });
    
    // Fullscreen change listener
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', handleVisibilityChange);
}

function updateUI() {
    // Update authentication UI
    loginBtn.style.display = isAuthenticated ? 'none' : 'block';
    logoutBtn.style.display = isAuthenticated ? 'block' : 'none';
    mainContent.style.display = isAuthenticated ? 'block' : 'none';
    
    // Update system status
    systemStatus.textContent = isDetectionRunning ? 'Running' : 'Stopped';
    systemStatus.className = `status-badge ${isDetectionRunning ? 'running' : 'stopped'}`;
    
    // Update control buttons
    startDetectionBtn.disabled = isDetectionRunning;
    stopDetectionBtn.disabled = !isDetectionRunning;
    
    // Update button styles
    if (isDetectionRunning) {
        startDetectionBtn.classList.add('disabled');
        stopDetectionBtn.classList.remove('disabled');
    } else {
        startDetectionBtn.classList.remove('disabled');
        stopDetectionBtn.classList.add('disabled');
    }
}

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    // Simple authentication (replace with real authentication in production)
    if (username === 'admin' && password === 'admin123') {
        localStorage.setItem('authToken', `token-${Date.now()}`);
        isAuthenticated = true;
        loginModal.style.display = 'none';
        updateUI();
        
        // Load system information and check detection status
        await loadSystemInfo();
        await checkInitialDetectionStatus();
        
        console.log('Login successful');
    } else {
        alert('Invalid credentials. Please use admin/admin123');
        document.getElementById('password').value = '';
        document.getElementById('password').focus();
    }
}

function logout() {
    localStorage.removeItem('authToken');
    isAuthenticated = false;
    isDetectionRunning = false;
    stopRealTimeUpdates();
    resetUI();
    updateUI();
    console.log('Logged out successfully');
}

// Detection control functions
async function startDetection() {
    console.log('Starting detection...');
    startDetectionBtn.disabled = true;
    startDetectionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
    
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.startDetection}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Detection start response:', result);
        
        isDetectionRunning = true;
        
        // Start video feed
        const timestamp = Date.now();
        videoFeed.src = `${API_BASE_URL}${API_ENDPOINTS.videoFeed}?t=${timestamp}`;
        videoFeed.onerror = handleVideoError;
        
        updateUI();
        startRealTimeUpdates();
        connectionRetries = 0;
        
        console.log('Detection started successfully');
        
    } catch (error) {
        console.error('Failed to start detection:', error);
        alert('Failed to start detection. Please check if the backend server is running.');
    } finally {
        startDetectionBtn.disabled = false;
        startDetectionBtn.innerHTML = '<i class="fas fa-play"></i> Start Detection';
    }
}

async function stopDetection() {
    console.log('Stopping detection...');
    stopDetectionBtn.disabled = true;
    stopDetectionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
    
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.stopDetection}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Detection stop response:', result);
        
        isDetectionRunning = false;
        stopRealTimeUpdates();
        
        // Reset video feed to placeholder
        videoFeed.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjQ4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhbWVyYSBGZWVkIE9mZmxpbmU8L3RleHQ+Cjwvc3ZnPg==";
        
        // Reset all stats
        resetStats();
        updateUI();
        
        console.log('Detection stopped successfully');
        
    } catch (error) {
        console.error('Failed to stop detection:', error);
        alert('Failed to stop detection. Please check if the backend server is running.');
    } finally {
        stopDetectionBtn.disabled = false;
        stopDetectionBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Detection';
    }
}

// Data fetching functions
async function checkInitialDetectionStatus() {
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.getStatus}`);
        if (response.ok) {
            const data = await response.json();
            console.log('Initial detection status:', data);
            
            if (data.running) {
                isDetectionRunning = true;
                const timestamp = Date.now();
                videoFeed.src = `${API_BASE_URL}${API_ENDPOINTS.videoFeed}?t=${timestamp}`;
                startRealTimeUpdates();
            }
            
            updateDetectionStatus(data);
            updateUI();
        }
    } catch (error) {
        console.error('Error checking initial detection status:', error);
    }
}

async function fetchDetectionStatus() {
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.getStatus}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        updateDetectionStatus(data);
        connectionRetries = 0; // Reset retry counter on successful fetch
        
    } catch (error) {
        console.error('Error fetching detection status:', error);
        connectionRetries++;
        
        if (connectionRetries >= maxRetries) {
            console.warn('Max connection retries reached, stopping updates');
            stopRealTimeUpdates();
            // Show connection error in UI
            showConnectionError();
        }
    }
}

async function loadSystemInfo() {
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.systemInfo}`);
        if (response.ok) {
            const data = await response.json();
            updateSystemInfo(data);
        }
    } catch (error) {
        console.error('Error loading system info:', error);
    }
}

function updateDetectionStatus(data) {
    if (data.running !== undefined) {
        isDetectionRunning = data.running;
        updateUI();
    }

    if (data.stats) {
        const stats = data.stats;

        // Update main stats
        document.getElementById('people-count').textContent = stats.people_count || 0;
        document.getElementById('density').textContent = `${(stats.density || 0).toFixed(4)} ppl/m²`;

        // Update crowd level with confidence
        const crowdText = `${stats.crowd_level || 'Unknown'} (${Math.round((stats.crowd_confidence || 0) * 100)}%)`;
        document.getElementById('crowd-level').textContent = crowdText;

        // Update device status
        const deviceStatus = (stats.device_status || 'off').toUpperCase();
        document.getElementById('device-status').textContent = deviceStatus;

        // Update video stats
        document.getElementById('fps').textContent = (stats.fps || 0).toFixed(1);
        document.getElementById('processing-time').textContent = `${(stats.processing_time || 0).toFixed(2)} ms`;
        document.getElementById('frame-count').textContent = stats.frame_count || 0;

        // Update active tracks count
        const activeTracksCount = (stats.tracked_ids || []).length;
        document.getElementById('active-tracks').textContent = activeTracksCount;

        // Update tracking information
        updateTrackingTable(stats.tracking_info || []);
        updateTrackingSummary(stats.tracked_ids || [], stats.tracking_info || []);

        // Update device status indicator color
        updateDeviceStatusIndicator(deviceStatus);

        // ✅ NEW: Update device control UI (switches + sliders)
        if (stats.devices) {
            Object.entries(stats.devices).forEach(([deviceId, config]) => {
                const type = deviceId.split('-')[0]; // e.g., "fan-123" → "fan"
                const card = document.querySelector(`.device-card[data-device="${type}"]`);
                if (!card) return;

                // Power switch
                const switchEl = card.querySelector('.power-switch');
                const statusText = card.querySelector('.status-text');
                const statusIndicator = card.querySelector('.status-indicator');

                if (config.state) {
                    switchEl.classList.add('on');
                    statusText.textContent = 'Online';
                    statusIndicator.classList.add('active');
                } else {
                    switchEl.classList.remove('on');
                    statusText.textContent = 'Offline';
                    statusIndicator.classList.remove('active');
                }

                // Sliders (speed, brightness, volume, temperature)
                ['speed', 'brightness', 'volume', 'temperature'].forEach(control => {
                    if (config[control] !== undefined) {
                        const slider = card.querySelector(`input[data-control="${control}"]`);
                        const valueLabel = card.querySelector(`.slider-label[data-control="${control}"]`);
                        if (slider) slider.value = config[control];
                        if (valueLabel) valueLabel.textContent = `${config[control]}%`;
                    }
                });
            });
        }

        lastUpdateTime = Date.now();
    }
}


function updateTrackingTable(trackingInfo) {
    const tableBody = document.getElementById('tracking-data');
    
    if (!trackingInfo || trackingInfo.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="no-data">No active tracks</td></tr>';
        return;
    }
    
    tableBody.innerHTML = '';
    
    trackingInfo.forEach(track => {
        const row = document.createElement('tr');
        const statusClass = track.status.toLowerCase().replace(' ', '-');
        
        row.innerHTML = `
            <td class="track-id">${track.track_id}</td>
            <td class="track-position">${track.position}</td>
            <td class="track-confidence">${track.confidence}</td>
            <td class="track-status ${statusClass}">${track.status}</td>
        `;
        
        tableBody.appendChild(row);
    });
}

function updateTrackingSummary(trackedIds, trackingInfo) {
    const totalTracked = trackedIds.length;
    const activeTracks = trackingInfo.filter(track => track.status.toLowerCase() === 'confirmed').length;
    
    document.getElementById('total-tracked').textContent = totalTracked;
    document.getElementById('active-tracks-summary').textContent = activeTracks;
}

function updateSystemInfo(info) {
    if (info.device) {
        document.getElementById('processing-device').textContent = info.device;
    }
    if (info.yolo_model) {
        document.getElementById('yolo-model').textContent = info.yolo_model;
    }
    if (info.resnet_enabled !== undefined) {
        document.getElementById('resnet-enabled').textContent = info.resnet_enabled ? 'Yes' : 'No';
    }
    if (info.camera_fov) {
        document.getElementById('camera-fov').textContent = `${info.camera_fov} m²`;
    }
    if (info.density_threshold) {
        document.getElementById('density-threshold').textContent = `${info.density_threshold} ppl/m²`;
    }
}

function updateDeviceStatusIndicator(status) {
    const deviceStatusElement = document.getElementById('device-status');
    const deviceIcon = document.querySelector('.device-icon');
    
    if (status === 'ON') {
        deviceStatusElement.classList.add('status-on');
        deviceStatusElement.classList.remove('status-off');
        deviceIcon.style.backgroundColor = '#2ecc71';
    } else {
        deviceStatusElement.classList.add('status-off');
        deviceStatusElement.classList.remove('status-on');
        deviceIcon.style.backgroundColor = '#e74c3c';
    }
}

function resetStats() {
    document.getElementById('people-count').textContent = '0';
    document.getElementById('density').textContent = '0.00 ppl/m²';
    document.getElementById('crowd-level').textContent = 'Unknown (0%)';
    document.getElementById('device-status').textContent = 'OFF';
    document.getElementById('fps').textContent = '0.0';
    document.getElementById('processing-time').textContent = '0.00 ms';
    document.getElementById('frame-count').textContent = '0';
    document.getElementById('active-tracks').textContent = '0';
    document.getElementById('total-tracked').textContent = '0';
    document.getElementById('active-tracks-summary').textContent = '0';
    
    // Reset tracking table
    document.getElementById('tracking-data').innerHTML = '<tr><td colspan="4" class="no-data">No tracking data available</td></tr>';
    
    // Reset device status indicator
    updateDeviceStatusIndicator('OFF');
}

function resetUI() {
    resetStats();
    videoFeed.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjQ4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhbWVyYSBGZWVkIE9mZmxpbmU8L3RleHQ+Cjwvc3ZnPg==";
}

function showConnectionError() {
    // You could implement a more sophisticated error display here
    console.warn('Connection to backend lost');
}

// Real-time update functions
function startRealTimeUpdates() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    
    console.log('Starting real-time updates...');
    updateInterval = setInterval(() => {
        if (isDetectionRunning && isAuthenticated) {
            fetchDetectionStatus();
        }
    }, 1000); // Update every second
    
    // Initial fetch
    fetchDetectionStatus();
}

function stopRealTimeUpdates() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
        console.log('Stopped real-time updates');
    }
}

// Video control functions
function toggleFullscreen() {
    const videoWrapper = document.querySelector('.video-wrapper');
    
    if (!document.fullscreenElement) {
        videoWrapper.requestFullscreen().catch(err => {
            console.error('Error attempting to enable fullscreen:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

function handleFullscreenChange() {
    const icon = fullscreenBtn.querySelector('i');
    if (document.fullscreenElement) {
        icon.className = 'fas fa-compress';
        videoFeed.style.cursor = 'zoom-out';
    } else {
        icon.className = 'fas fa-expand';
        videoFeed.style.cursor = 'pointer';
    }
}

function handleVideoError() {
    console.error('Video feed error');
    if (isDetectionRunning) {
        // Try to reload the video feed
        setTimeout(() => {
            const timestamp = Date.now();
            videoFeed.src = `${API_BASE_URL}${API_ENDPOINTS.videoFeed}?t=${timestamp}`;
        }, 2000);
    }
}

// Page visibility handling
function handleVisibilityChange() {
    if (document.hidden) {
        // Page is hidden, reduce update frequency or pause updates
        if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = setInterval(() => {
                if (isDetectionRunning && isAuthenticated) {
                    fetchDetectionStatus();
                }
            }, 5000); // Update every 5 seconds when hidden
        }
    } else {
        // Page is visible, resume normal update frequency
        if (isDetectionRunning && isAuthenticated) {
            startRealTimeUpdates();
        }
    }
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', init);

// Handle page unload
window.addEventListener('beforeunload', () => {
    stopRealTimeUpdates();
});






---------------------------------------------***********************************-----------------------------------------
updated device-control.html (for adding new device making to adjust values )


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Device Control System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2rem;
            font-weight: 600;
        }

        .header h1 i {
            color: #667eea;
            margin-right: 10px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            text-decoration: none;
            color: #4a5568;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            gap: 30px;
        }

        .section-title {
            color: white;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .device-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .device-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #4a5568;
        }

        .device-icon {
            font-size: 1.8rem;
            padding: 10px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .power-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .power-switch.on {
            background: #48bb78;
        }

        .power-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .power-switch.on::after {
            transform: translateX(30px);
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e53e3e;
        }

        .status-indicator.active {
            background: #48bb78;
        }

        .controls-section {
            margin-top: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .slider-container {
            position: relative;
            margin-bottom: 10px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #718096;
        }

        .current-value {
            font-weight: 600;
            color: #667eea;
        }

        .add-device-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
        }

        .add-device-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .add-device-card i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .add-device-card h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #4a5568;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #4a5568;
        }

        .device-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .device-type {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .device-type:hover,
        .device-type.selected {
            border-color: #667eea;
            background: #f7fafc;
        }

        .device-type i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 40px;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .devices-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-home"></i> Smart Device Control</h1>
            <nav class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-users"></i> Crowd Management</a>
                <a href="/device-control.html" class="nav-link active"><i class="fas fa-home"></i> Device Control</a>
            </nav>
            <div class="auth-buttons">
                <button id="login-btn" class="btn btn-primary">Login</button>
                <button id="logout-btn" class="btn btn-danger" style="display: none;">Logout</button>
            </div>
        </header>

        <main class="main-content">
            <h2 class="section-title">
                <i class="fas fa-microchip"></i>
                Connected Devices
            </h2>

            <div class="devices-grid" id="devices-grid">
                <!-- Fan Device -->
                <div class="device-card" data-device="fan">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-fan"></i>
                            </div>
                            <span>Ceiling Fan</span>
                        </div>
                        <div class="power-switch" data-device="fan"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Speed Control</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="speed">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Light Device -->
                <div class="device-card" data-device="light">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <span>Smart Light</span>
                        </div>
                        <div class="power-switch" data-device="light"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Brightness</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="brightness">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TV Device -->
                <div class="device-card" data-device="tv">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-tv"></i>
                            </div>
                            <span>Smart TV</span>
                        </div>
                        <div class="power-switch" data-device="tv"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Volume</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="volume">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Device Card -->
                <div class="device-card add-device-card" id="add-device-btn">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Add New Device</h3>
                    <p>Connect a new smart device</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Made with 💡 by Yesvin Veluchamy for Summer Internship &copy; 2025</p>
        </footer>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Device</h2>
                <span class="close">&times;</span>
            </div>
            
            <div class="device-types">
                <div class="device-type" data-type="fan">
                    <i class="fas fa-fan"></i>
                    <div>Fan</div>
                </div>
                <div class="device-type" data-type="light">
                    <i class="fas fa-lightbulb"></i>
                    <div>Light</div>
                </div>
                <div class="device-type" data-type="tv">
                    <i class="fas fa-tv"></i>
                    <div>TV</div>
                </div>
                <div class="device-type" data-type="ac">
                    <i class="fas fa-snowflake"></i>
                    <div>AC</div>
                </div>
            </div>

            <form id="deviceForm">
                <div class="form-group">
                    <label for="deviceName">Device Name</label>
                    <input type="text" id="deviceName" name="deviceName" placeholder="Enter device name" required>
                </div>
                
                <div class="form-group">
                    <label for="deviceRoom">Room</label>
                    <select id="deviceRoom" name="deviceRoom" required>
                        <option value="">Select Room</option>
                        <option value="living-room">Living Room</option>
                        <option value="bedroom">Bedroom</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="bathroom">Bathroom</option>
                        <option value="office">Office</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Device</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables for device management
        let devices = {};
        let selectedDeviceType = '';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadDevices();
            setInterval(loadDevices, 2000); // Poll backend every 2 seconds for real-time sync
        });

        function initializeEventListeners() {
            // Power switch toggles
            document.querySelectorAll('.power-switch').forEach(switchEl => {
                switchEl.addEventListener('click', function() {
                    const deviceId = this.closest('.device-card').getAttribute('data-device');
                    sendDeviceState(deviceId, !this.classList.contains('on'));
                });
            });

            // Slider controls
            document.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('change', function() {
                    const value = this.value;
                    const deviceCard = this.closest('.device-card');
                    const deviceId = deviceCard.getAttribute('data-device');
                    const controlType = this.getAttribute('data-control');
                    sendControlUpdate(deviceId, controlType, value);
                });
            });

            // Add device modal
            const modal = document.getElementById('addDeviceModal');
            const addBtn = document.getElementById('add-device-btn');
            const closeBtn = document.querySelector('.close');

            addBtn.addEventListener('click', () => {
                modal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                resetModal();
            });

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    resetModal();
                }
            });

            // Device type selection
            document.querySelectorAll('.device-type').forEach(type => {
                type.addEventListener('click', function() {
                    document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDeviceType = this.getAttribute('data-type');
                });
            });

            // Form submission
            document.getElementById('deviceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewDevice();
            });

            // Auth buttons
            document.getElementById('login-btn').addEventListener('click', () => {
                // Simulate login - in real implementation, this would redirect to login page
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'block';
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'none';
            });
        }

        function sendDeviceState(deviceId, isOn) {
            fetch('/api/device/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, state: isOn })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device state updated:', data);
            })
            .catch(error => {
                console.error('Error updating device state:', error);
            });
        }

        function sendControlUpdate(deviceId, controlType, value) {
            fetch('/api/device/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, control: controlType, value: parseInt(value) })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device control updated:', data);
            })
            .catch(error => {
                console.error('Error updating device control:', error);
            });
        }

        function addNewDevice() {
            if (!selectedDeviceType) {
                alert('Please select a device type');
                return;
            }
            const deviceName = document.getElementById('deviceName').value;
            const deviceRoom = document.getElementById('deviceRoom').value;
            if (!deviceName || !deviceRoom) {
                alert('Please fill in all fields');
                return;
            }
            fetch('/api/device/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: selectedDeviceType, name: deviceName, room: deviceRoom })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('addDeviceModal').style.display = 'none';
                resetModal();
                // UI will update on next poll from backend
            })
            .catch(error => {
                console.error('Error adding new device:', error);
            });
        }

        function resetModal() {
            document.getElementById('deviceForm').reset();
            document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
            selectedDeviceType = '';
        }

        function loadDevices() {
            fetch('/api/devices')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateDevicesUI(data.devices);
                }
            })
            .catch(error => {
                console.error('Error loading devices:', error);
            });
        }

        function updateDevicesUI(devices) {
            const devicesGrid = document.getElementById('devices-grid');
            // Remove all device cards except the add-device card
            devicesGrid.querySelectorAll('.device-card:not(.add-device-card)').forEach(card => card.remove());

            // For each device from backend, create a card
            for (const [deviceId, deviceInfo] of Object.entries(devices)) {
                createDeviceCard(deviceId, deviceInfo);
            }
        }

        function createDeviceCard(deviceId, deviceInfo) {
            const devicesGrid = document.getElementById('devices-grid');
            // Don't duplicate cards
            if (devicesGrid.querySelector(`[data-device="${deviceId}"]`)) return;

            // Card container
            const card = document.createElement('div');
            card.className = 'device-card';
            card.setAttribute('data-device', deviceId);

            // Device icon
            let iconClass = 'fa-question';
            if (deviceInfo.type === 'fan') iconClass = 'fa-fan';
            if (deviceInfo.type === 'light') iconClass = 'fa-lightbulb';
            if (deviceInfo.type === 'tv') iconClass = 'fa-tv';
            if (deviceInfo.type === 'ac') iconClass = 'fa-snowflake';

            // Device header
            card.innerHTML = `
                <div class="device-header">
                    <div class="device-title">
                        <div class="device-icon">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        <span>${deviceInfo.name || deviceId}</span>
                    </div>
                    <div class="power-switch" data-device="${deviceId}"></div>
                </div>
                <div class="device-status">
                    <div class="status-indicator"></div>
                    <span class="status-text">Offline</span>
                </div>
                <div class="controls-section"></div>
            `;

            // Controls section
            const controlsSection = card.querySelector('.controls-section');
            if (deviceInfo.type === 'fan') {
                controlsSection.innerHTML = `
                    <div class="control-group">
                        <label class="control-label">Speed Control</label>
                        <div class="slider-container">
                            <input type="range" class="slider" min="0" max="100" value="${deviceInfo.speed || 0}" data-control="speed">
                            <div class="slider-value">
                                <span>0%</span>
                                <span class="current-value">${deviceInfo.speed || 0}%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (deviceInfo.type === 'light') {
                controlsSection.innerHTML = `
                    <div class="control-group">
                        <label class="control-label">Brightness</label>
                        <div class="slider-container">
                            <input type="range" class="slider" min="0" max="100" value="${deviceInfo.brightness || 0}" data-control="brightness">
                            <div class="slider-value">
                                <span>0%</span>
                                <span class="current-value">${deviceInfo.brightness || 0}%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (deviceInfo.type === 'tv') {
                controlsSection.innerHTML = `
                    <div class="control-group">
                        <label class="control-label">Volume</label>
                        <div class="slider-container">
                            <input type="range" class="slider" min="0" max="100" value="${deviceInfo.volume || 0}" data-control="volume">
                            <div class="slider-value">
                                <span>0%</span>
                                <span class="current-value">${deviceInfo.volume || 0}%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (deviceInfo.type === 'ac') {
                controlsSection.innerHTML = `
                    <div class="control-group">
                        <label class="control-label">Temperature</label>
                        <div class="slider-container">
                            <input type="range" class="slider" min="16" max="30" value="${deviceInfo.temperature || 20}" data-control="temperature">
                            <div class="slider-value">
                                <span>16°C</span>
                                <span class="current-value">${deviceInfo.temperature || 20}°C</span>
                                <span>30°C</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Insert before the add-device card
            const addDeviceCard = devicesGrid.querySelector('.add-device-card');
            devicesGrid.insertBefore(card, addDeviceCard);

            // Power switch event
            const powerSwitch = card.querySelector('.power-switch');
            powerSwitch.addEventListener('click', function() {
                sendDeviceState(deviceId, !powerSwitch.classList.contains('on'));
            });

            // Slider event(s)
            card.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('change', function() {
                    const value = this.value;
                    const controlType = this.getAttribute('data-control');
                    sendControlUpdate(deviceId, controlType, value);
                });
            });

            // Initial UI update
            updateSingleDeviceUI(card, deviceInfo);
        }

        function updateSingleDeviceUI(card, deviceInfo) {
            // Power switch
            const powerSwitch = card.querySelector('.power-switch');
            if (powerSwitch) {
                if (deviceInfo.state) {
                    powerSwitch.classList.add('on');
                    powerSwitch.classList.remove('off');
                } else {
                    powerSwitch.classList.remove('on');
                    powerSwitch.classList.add('off');
                }
            }
            // Status indicator
            const statusIndicator = card.querySelector('.status-indicator');
            const statusText = card.querySelector('.status-text');
            if (statusIndicator && statusText) {
                if (deviceInfo.state) {
                    statusIndicator.classList.add('active');
                    statusText.textContent = 'Online';
                } else {
                    statusIndicator.classList.remove('active');
                    statusText.textContent = 'Offline';
                }
            }
            // Sliders
            card.querySelectorAll('.slider').forEach(slider => {
                const controlType = slider.getAttribute('data-control');
                if (deviceInfo[controlType] !== undefined) {
                    slider.value = deviceInfo[controlType];
                    const currentValueSpan = slider.parentElement.querySelector('.current-value');
                    if (currentValueSpan) {
                        if (controlType === 'temperature') {
                            currentValueSpan.textContent = deviceInfo[controlType] + '°C';
                        } else {
                            currentValueSpan.textContent = deviceInfo[controlType] + '%';
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>





----------------------------------------------------------*****************************************************-------------------------------------------
device-control.html (updated both real time adjusment and add new device and also it's adjustment )



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Device Control System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2rem;
            font-weight: 600;
        }

        .header h1 i {
            color: #667eea;
            margin-right: 10px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            text-decoration: none;
            color: #4a5568;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            gap: 30px;
        }

        .section-title {
            color: white;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .device-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .device-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #4a5568;
        }

        .device-icon {
            font-size: 1.8rem;
            padding: 10px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .power-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .power-switch.on {
            background: #48bb78;
        }

        .power-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .power-switch.on::after {
            transform: translateX(30px);
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e53e3e;
        }

        .status-indicator.active {
            background: #48bb78;
        }

        .controls-section {
            margin-top: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .slider-container {
            position: relative;
            margin-bottom: 10px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #718096;
        }

        .current-value {
            font-weight: 600;
            color: #667eea;
        }

        .add-device-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
        }

        .add-device-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .add-device-card i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .add-device-card h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #4a5568;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #4a5568;
        }

        .device-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .device-type {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .device-type:hover,
        .device-type.selected {
            border-color: #667eea;
            background: #f7fafc;
        }

        .device-type i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 40px;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .devices-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-home"></i> Smart Device Control</h1>
            <nav class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-users"></i> Crowd Management</a>
                <a href="/device-control.html" class="nav-link active"><i class="fas fa-home"></i> Device Control</a>
            </nav>
            <div class="auth-buttons">
                <button id="login-btn" class="btn btn-primary">Login</button>
                <button id="logout-btn" class="btn btn-danger" style="display: none;">Logout</button>
            </div>
        </header>

        <main class="main-content">
            <h2 class="section-title">
                <i class="fas fa-microchip"></i>
                Connected Devices
            </h2>

            <div class="devices-grid" id="devices-grid">
                <!-- Fan Device -->
                <div class="device-card" data-device="fan">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-fan"></i>
                            </div>
                            <span>Ceiling Fan</span>
                        </div>
                        <div class="power-switch" data-device="fan"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Speed Control</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="speed">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Light Device -->
                <div class="device-card" data-device="light">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <span>Smart Light</span>
                        </div>
                        <div class="power-switch" data-device="light"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Brightness</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="brightness">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TV Device -->
                <div class="device-card" data-device="tv">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-tv"></i>
                            </div>
                            <span>Smart TV</span>
                        </div>
                        <div class="power-switch" data-device="tv"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Volume</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="volume">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Device Card -->
                <div class="device-card add-device-card" id="add-device-btn">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Add New Device</h3>
                    <p>Connect a new smart device</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Made with 💡 by Yesvin Veluchamy for Summer Internship &copy; 2025</p>
        </footer>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Device</h2>
                <span class="close">&times;</span>
            </div>
            
            <div class="device-types">
                <div class="device-type" data-type="fan">
                    <i class="fas fa-fan"></i>
                    <div>Fan</div>
                </div>
                <div class="device-type" data-type="light">
                    <i class="fas fa-lightbulb"></i>
                    <div>Light</div>
                </div>
                <div class="device-type" data-type="tv">
                    <i class="fas fa-tv"></i>
                    <div>TV</div>
                </div>
                <div class="device-type" data-type="ac">
                    <i class="fas fa-snowflake"></i>
                    <div>AC</div>
                </div>
            </div>

            <form id="deviceForm">
                <div class="form-group">
                    <label for="deviceName">Device Name</label>
                    <input type="text" id="deviceName" name="deviceName" placeholder="Enter device name" required>
                </div>
                
                <div class="form-group">
                    <label for="deviceRoom">Room</label>
                    <select id="deviceRoom" name="deviceRoom" required>
                        <option value="">Select Room</option>
                        <option value="living-room">Living Room</option>
                        <option value="bedroom">Bedroom</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="bathroom">Bathroom</option>
                        <option value="office">Office</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Device</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables for device management
        let devices = {};
        let selectedDeviceType = '';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadDevices();
            setInterval(loadDevices, 2000); // Poll backend every 2 seconds for real-time sync
        });

        function initializeEventListeners() {
            // Power switch toggles
            document.querySelectorAll('.power-switch').forEach(switchEl => {
                switchEl.addEventListener('click', function() {
                    const deviceId = this.closest('.device-card').getAttribute('data-device');
                    sendDeviceState(deviceId, !this.classList.contains('on'));
                });
            });

            // Slider controls
            document.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('change', function() {
                    const value = this.value;
                    const deviceCard = this.closest('.device-card');
                    const deviceId = deviceCard.getAttribute('data-device');
                    const controlType = this.getAttribute('data-control');
                    sendControlUpdate(deviceId, controlType, value);
                });
            });

            // Add device modal
            const modal = document.getElementById('addDeviceModal');
            const addBtn = document.getElementById('add-device-btn');
            const closeBtn = document.querySelector('.close');

            addBtn.addEventListener('click', () => {
                modal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                resetModal();
            });

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    resetModal();
                }
            });

            // Device type selection
            document.querySelectorAll('.device-type').forEach(type => {
                type.addEventListener('click', function() {
                    document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDeviceType = this.getAttribute('data-type');
                });
            });

            // Form submission
            document.getElementById('deviceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewDevice();
            });

            // Auth buttons
            document.getElementById('login-btn').addEventListener('click', () => {
                // Simulate login - in real implementation, this would redirect to login page
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'block';
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'none';
            });
        }

        function sendDeviceState(deviceId, isOn) {
            fetch('/api/device/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, state: isOn })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device state updated:', data);
            })
            .catch(error => {
                console.error('Error updating device state:', error);
            });
        }

        function sendControlUpdate(deviceId, controlType, value) {
            fetch('/api/device/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, control: controlType, value: parseInt(value) })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device control updated:', data);
            })
            .catch(error => {
                console.error('Error updating device control:', error);
            });
        }

        function addNewDevice() {
            if (!selectedDeviceType) {
                alert('Please select a device type');
                return;
            }
            const deviceName = document.getElementById('deviceName').value;
            const deviceRoom = document.getElementById('deviceRoom').value;
            if (!deviceName || !deviceRoom) {
                alert('Please fill in all fields');
                return;
            }
            fetch('/api/device/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: selectedDeviceType, name: deviceName, room: deviceRoom })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('addDeviceModal').style.display = 'none';
                resetModal();
                // UI will update on next poll from backend
            })
            .catch(error => {
                console.error('Error adding new device:', error);
            });
        }

        function resetModal() {
            document.getElementById('deviceForm').reset();
            document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
            selectedDeviceType = '';
        }

        function loadDevices() {
            fetch('/api/devices')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateDevicesUI(data.devices);
                }
            })
            .catch(error => {
                console.error('Error loading devices:', error);
            });
        }

        // Replace the updateDevicesUI function with this updated version
function updateDevicesUI(devices) {
    const devicesGrid = document.getElementById('devices-grid');
    
    // Update existing device cards and create new ones
    for (const [deviceId, deviceInfo] of Object.entries(devices)) {
        let existingCard = devicesGrid.querySelector(`[data-device="${deviceId}"]`);
        
        if (existingCard && !existingCard.classList.contains('add-device-card')) {
            // Update existing card
            updateSingleDeviceUI(existingCard, deviceInfo);
        } else if (!existingCard) {
            // Create new card for devices not already present
            createDeviceCard(deviceId, deviceInfo);
        }
    }
    
    // Remove cards for devices that no longer exist in backend
    devicesGrid.querySelectorAll('.device-card:not(.add-device-card)').forEach(card => {
        const deviceId = card.getAttribute('data-device');
        if (!devices[deviceId]) {
            card.remove();
        }
    });
}

// Replace the createDeviceCard function with this updated version
function createDeviceCard(deviceId, deviceInfo) {
    const devicesGrid = document.getElementById('devices-grid');
    
    // Don't duplicate cards
    if (devicesGrid.querySelector(`[data-device="${deviceId}"]`)) return;

    // Card container
    const card = document.createElement('div');
    card.className = 'device-card';
    card.setAttribute('data-device', deviceId);

    // Device icon mapping
    const iconMap = {
        'fan': 'fa-fan',
        'light': 'fa-lightbulb', 
        'tv': 'fa-tv',
        'ac': 'fa-snowflake'
    };
    const iconClass = iconMap[deviceInfo.type] || 'fa-question';

    // Device header (consistent for all devices)
    card.innerHTML = `
        <div class="device-header">
            <div class="device-title">
                <div class="device-icon">
                    <i class="fas ${iconClass}"></i>
                </div>
                <span>${deviceInfo.name || deviceId}</span>
            </div>
            <div class="power-switch" data-device="${deviceId}"></div>
        </div>
        <div class="device-status">
            <div class="status-indicator"></div>
            <span class="status-text">Offline</span>
        </div>
        <div class="controls-section"></div>
    `;

    // Controls section - standardized for all device types
    const controlsSection = card.querySelector('.controls-section');
    const controlsConfig = getControlsConfig(deviceInfo.type, deviceInfo);
    
    controlsSection.innerHTML = controlsConfig.html;

    // Insert before the add-device card
    const addDeviceCard = devicesGrid.querySelector('.add-device-card');
    devicesGrid.insertBefore(card, addDeviceCard);

    // Add event listeners
    addDeviceEventListeners(card, deviceId);

    // Initial UI update
    updateSingleDeviceUI(card, deviceInfo);
}

// New helper function for consistent control configurations
function getControlsConfig(deviceType, deviceInfo) {
    const configs = {
        'fan': {
            html: `
                <div class="control-group">
                    <label class="control-label">Speed Control</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="0" max="100" value="${deviceInfo.speed || 0}" data-control="speed">
                        <div class="slider-value">
                            <span>0%</span>
                            <span class="current-value">${deviceInfo.speed || 0}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            `
        },
        'light': {
            html: `
                <div class="control-group">
                    <label class="control-label">Brightness</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="0" max="100" value="${deviceInfo.brightness || 0}" data-control="brightness">
                        <div class="slider-value">
                            <span>0%</span>
                            <span class="current-value">${deviceInfo.brightness || 0}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            `
        },
        'tv': {
            html: `
                <div class="control-group">
                    <label class="control-label">Volume</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="0" max="100" value="${deviceInfo.volume || 0}" data-control="volume">
                        <div class="slider-value">
                            <span>0%</span>
                            <span class="current-value">${deviceInfo.volume || 0}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            `
        },
        'ac': {
            html: `
                <div class="control-group">
                    <label class="control-label">Temperature</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="16" max="30" value="${deviceInfo.temperature || 20}" data-control="temperature">
                        <div class="slider-value">
                            <span>16°C</span>
                            <span class="current-value">${deviceInfo.temperature || 20}°C</span>
                            <span>30°C</span>
                        </div>
                    </div>
                </div>
            `
        }
    };
    
    return configs[deviceType] || {
        html: `<div class="control-group"><p>No controls available</p></div>`
    };
}

// New helper function for consistent event listener attachment
function addDeviceEventListeners(card, deviceId) {
    // Power switch event
    const powerSwitch = card.querySelector('.power-switch');
    if (powerSwitch) {
        powerSwitch.addEventListener('click', function() {
            sendDeviceState(deviceId, !this.classList.contains('on'));
        });
    }

    // Slider events
    card.querySelectorAll('.slider').forEach(slider => {
        slider.addEventListener('input', function() {
            // Update display value immediately for responsive UI
            const value = this.value;
            const controlType = this.getAttribute('data-control');
            const currentValueSpan = this.parentElement.querySelector('.current-value');
            
            if (currentValueSpan) {
                if (controlType === 'temperature') {
                    currentValueSpan.textContent = value + '°C';
                } else {
                    currentValueSpan.textContent = value + '%';
                }
            }
        });
        
        slider.addEventListener('change', function() {
            const value = this.value;
            const controlType = this.getAttribute('data-control');
            sendControlUpdate(deviceId, controlType, value);
        });
    });
}

// Updated updateSingleDeviceUI function for better consistency
function updateSingleDeviceUI(card, deviceInfo) {
    // Power switch state
    const powerSwitch = card.querySelector('.power-switch');
    if (powerSwitch) {
        if (deviceInfo.state) {
            powerSwitch.classList.add('on');
            powerSwitch.classList.remove('off');
        } else {
            powerSwitch.classList.remove('on');
            powerSwitch.classList.add('off');
        }
    }
    
    // Status indicator
    const statusIndicator = card.querySelector('.status-indicator');
    const statusText = card.querySelector('.status-text');
    if (statusIndicator && statusText) {
        if (deviceInfo.state) {
            statusIndicator.classList.add('active');
            statusText.textContent = 'Online';
        } else {
            statusIndicator.classList.remove('active');
            statusText.textContent = 'Offline';
        }
    }
    
    // Update all sliders and their display values
    card.querySelectorAll('.slider').forEach(slider => {
        const controlType = slider.getAttribute('data-control');
        if (deviceInfo[controlType] !== undefined) {
            slider.value = deviceInfo[controlType];
            
            const currentValueSpan = slider.parentElement.querySelector('.current-value');
            if (currentValueSpan) {
                if (controlType === 'temperature') {
                    currentValueSpan.textContent = deviceInfo[controlType] + '°C';
                } else {
                    currentValueSpan.textContent = deviceInfo[controlType] + '%';
                }
            }
        }
    });
}
    </script>
</body>
</html>



--------------------------------------------------------********************************************************************------------------------------------------------------------------

updated seg12.py code (with all web proper functionality ) : 

import os
import cv2
import time
import csv
import torch
import numpy as np
from PIL import Image
from datetime import datetime
from torchvision import transforms, models
from ultralytics import YOLO
from torch import nn
from gpio_controller import turn_on_device, turn_off_device, cleanup_gpio
from deep_sort_realtime.deepsort_tracker import DeepSort
import logging
from flask import Flask, jsonify, Response, render_template, request, session, send_from_directory
from flask_cors import CORS
import threading
import json

app = Flask(__name__)
CORS(app)  # Enable CORS for frontend communication

# Serve frontend HTML files
@app.route('/')
def serve_index():
    return send_from_directory('../frontend', 'index.html')

@app.route('/device-control.html')
def serve_device_control():
    return send_from_directory('../frontend', 'device-control.html')

# Serve static assets (JS, CSS)
@app.route('/<path:filename>')
def serve_static_file(filename):
    return send_from_directory('../frontend', filename)

# Global variables for system state
current_stats = {
    'people_count': 0,
    'density': 0.0,
    'device_status': 'off',
    'crowd_level': 'unknown',
    'crowd_confidence': 0.0,
    'tracked_ids': [],
    'tracking_info': [],
    'processing_time': 0,
    'fps': 0,
    'frame_count': 0
}

detection_running = False
frame_buffer = None
cap = None

# In-memory storage for devices (you can replace with database)
devices = {
    'fan': {'name': 'Ceiling Fan', 'room': 'Living Room', 'speed': 0, 'state': False},
    'light': {'name': 'Smart Light', 'room': 'Living Room', 'brightness': 0, 'state': False},
    'tv': {'name': 'Smart TV', 'room': 'Living Room', 'volume': 0, 'state': False}
}

# Device control history
device_history = []

# Configuration constants
CAMERA_ID = 0
CAMERA_FOV_M2 = 100  # Camera field of view in square meters
DENSITY_THRESHOLD = 0.05
CSV_FILE = "density_log.csv"
DATASET_DIR = "dataset"
OUTPUT_DIR = "output_results"
YOLO_MODEL_PATH = "yolov8n.pt"
RESNET_MODEL_PATH = "model/resnet50_density_model.pth"
MIN_CONFIDENCE = 0.3
FRAME_SKIP = 2
FORCE_GPU = True
BATCH_SIZE = 4
USE_RESNET = True

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Create necessary directories
os.makedirs(DATASET_DIR, exist_ok=True)
os.makedirs(OUTPUT_DIR, exist_ok=True)
os.makedirs('model', exist_ok=True)

# Initialize CSV file
if not os.path.exists(CSV_FILE):
    with open(CSV_FILE, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(["Timestamp", "Camera ID", "People Count", "Density", "Device Status", 
                         "Crowd Density", "Tracked IDs", "Processing Time (ms)"])

def check_mps_availability():
    """Check if Apple Silicon GPU is available"""
    if torch.backends.mps.is_available():
        logger.info("MPS is available. Using Apple Silicon GPU!")
        return torch.device("mps")
    else:
        logger.info("MPS not available. Falling back to CPU.")
        return torch.device("cpu")

# Setup torch device
torch_device = check_mps_availability()
logger.info(f"Using device: {torch_device}")

# Load YOLO model
yolo_model = YOLO(YOLO_MODEL_PATH)
if torch_device.type == 'mps':
    yolo_model.to(torch_device)
    logger.info("YOLO model moved to GPU")

class DensityResNet(nn.Module):
    def __init__(self):
        super().__init__()
        self.base_model = models.resnet50(weights='IMAGENET1K_V2')
        self.base_model.fc = nn.Identity()
        self.base_model.avgpool = nn.Identity()
        self.density_head = nn.Sequential(
            nn.Conv2d(2048, 1024, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.Conv2d(1024, 512, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.Conv2d(512, 256, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.Conv2d(256, 1, kernel_size=1),
            nn.ReLU()
        )
    def forward(self, x):
        x = self.base_model.conv1(x)
        x = self.base_model.bn1(x)
        x = self.base_model.relu(x)
        x = self.base_model.maxpool(x)
        x = self.base_model.layer1(x)
        x = self.base_model.layer2(x)
        x = self.base_model.layer3(x)
        x = self.base_model.layer4(x)
        x = self.density_head(x)
        x = nn.functional.interpolate(x, size=(224, 224), mode='bilinear', align_corners=False)
        return x

class CrowdDensityClassifier(nn.Module):
    def __init__(self, density_model):
        super().__init__()
        self.density_model = density_model
        for param in self.density_model.parameters():
            param.requires_grad = False
        self.classifier = nn.Sequential(
            nn.AdaptiveAvgPool2d((1, 1)),
            nn.Flatten(),
            nn.Linear(1, 64),
            nn.ReLU(),
            nn.Dropout(0.3),
            nn.Linear(64, 32),
            nn.ReLU(),
            nn.Dropout(0.2),
            nn.Linear(32, 4),
            nn.Softmax(dim=1)
        )
    def forward(self, x):
        density_map = self.density_model(x)
        crowd_level = self.classifier(density_map)
        return density_map, crowd_level

def load_trained_model(model_path, device):
    """Load trained ResNet model"""
    try:
        model = DensityResNet()
        checkpoint = torch.load(model_path, map_location=device)
        if 'model_state_dict' in checkpoint:
            state_dict = checkpoint['model_state_dict']
            logger.info("Loaded checkpoint format")
        else:
            state_dict = checkpoint
            logger.info("Loaded direct state dict format")
        model.load_state_dict(state_dict)
        model.to(device)
        model.eval()
        logger.info("DensityResNet model loaded successfully")
        classifier_model = CrowdDensityClassifier(model)
        classifier_model.to(device)
        classifier_model.eval()
        return model, classifier_model
    except Exception as e:
        logger.error(f"Error loading model: {e}")
        return None, None

# Load ResNet model
resnet_model = None
crowd_classifier = None

if USE_RESNET:
    try:
        logger.info("Loading trained DensityResNet model...")
        resnet_model, crowd_classifier = load_trained_model(RESNET_MODEL_PATH, torch_device)
        if resnet_model is None:
            logger.warning("Could not load ResNet model, continuing without it")
            USE_RESNET = False
        else:
            logger.info("ResNet density model loaded successfully")
    except FileNotFoundError:
        logger.warning("ResNet model not found, continuing without it")
        USE_RESNET = False
    except Exception as e:
        logger.warning(f"Error loading ResNet model: {e}, continuing without it")
        USE_RESNET = False

# Setup transforms
resnet_transform = transforms.Compose([
    transforms.ToPILImage(),
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
])

# Initialize DeepSORT tracker
tracker = DeepSort(
    max_age=50,
    n_init=3,
    max_cosine_distance=0.4,
    nn_budget=None,
    embedder="mobilenet",
    half=True,
    bgr=True,
    embedder_gpu=torch_device.type == 'mps',
    embedder_wts=None,
    polygon=False,
    today=None
)

def calculate_iou(box1, box2):
    """Calculate IoU between two bounding boxes"""
    x1 = max(box1[0], box2[0])
    y1 = max(box1[1], box2[1])
    x2 = min(box1[2], box2[2])
    y2 = min(box1[3], box2[3])
    
    inter_area = max(0, x2 - x1) * max(0, y2 - y1)
    box1_area = (box1[2] - box1[0]) * (box1[3] - box1[1])
    box2_area = (box2[2] - box2[0]) * (box2[3] - box2[1])
    
    return inter_area / float(box1_area + box2_area - inter_area)

def analyze_crowd_density(frame, model, classifier, transform, device):
    """Analyze crowd density using ResNet"""
    if model is None or classifier is None:
        return 0.0, "Unknown", 0.0
    
    try:
        frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        input_tensor = transform(frame_rgb).unsqueeze(0).to(device)
        
        with torch.no_grad():
            density_map, crowd_level = classifier(input_tensor)
            
            total_count = torch.sum(density_map).item()
            
            crowd_probs = crowd_level[0]
            crowd_class = torch.argmax(crowd_probs).item()
            crowd_confidence = torch.max(crowd_probs).item()
            
            crowd_labels = ["Low", "Medium", "High", "Very High"]
            crowd_label = crowd_labels[crowd_class]
            
            return total_count, crowd_label, crowd_confidence
            
    except Exception as e:
        logger.warning(f"Error in crowd analysis: {e}")
        return 0.0, "Error", 0.0

def process_frame():
    """Main frame processing function"""
    global current_stats, frame_buffer, cap
    
    if not detection_running or cap is None:
        return
    
    start_time = time.time()
    ret, frame = cap.read()
    
    if not ret:
        logger.warning("Failed to read frame from camera")
        return
    
    try:
        # YOLO detection for people
        results = yolo_model(frame, verbose=False, conf=MIN_CONFIDENCE)
        people_boxes = []
        
        for r in results:
            for box in r.boxes:
                cls = int(box.cls[0])
                conf = float(box.conf[0])
                if yolo_model.names[cls] == "person":
                    x1, y1, x2, y2 = map(int, box.xyxy[0])
                    
                    # Validate bounding box
                    if x2 <= x1 or y2 <= y1 or x1 < 0 or y1 < 0 or x2 >= frame.shape[1] or y2 >= frame.shape[0]:
                        continue
                    
                    people_boxes.append((x1, y1, x2, y2, conf))
        
        # Format detections for DeepSORT
        formatted_detections = []
        for x1, y1, x2, y2, conf in people_boxes:
            formatted_detections.append(([x1, y1, x2, y2], conf, 0))
        
        # Update tracker
        tracks = tracker.update_tracks(formatted_detections, frame=frame)
        
        # Process tracked objects
        tracked_people = []
        active_track_ids = []
        tracking_info = []
        
        for track in tracks:
            if not track.is_confirmed():
                continue
            
            track_id = track.track_id
            ltrb = track.to_ltrb()
            x1, y1, x2, y2 = map(int, ltrb)
            active_track_ids.append(track_id)
            
            # Find best matching detection
            best_match = None
            best_iou = 0
            for det in people_boxes:
                det_box = det[:4]
                iou = calculate_iou(ltrb, det_box)
                if iou > best_iou:
                    best_iou = iou
                    best_match = det
            
            if best_match and best_iou > 0.3:
                conf = best_match[4]
            else:
                conf = 0.7
            
            tracked_people.append((x1, y1, x2, y2, track_id, conf))
            
            # Add to tracking info for frontend
            tracking_info.append({
                'track_id': track_id,
                'position': f"({x1},{y1})",
                'confidence': round(conf, 2),
                'status': 'Confirmed'
            })
        
        # Calculate density and device status
        people_count = len(tracked_people)
        density = people_count / CAMERA_FOV_M2
        device_status = "on" if people_count > 0 else "off"

        # Control GPIO devices
        try:
            if device_status == "on":
                turn_on_device()
        # Control all devices based on their type
                for device_id, device in devices.items():
                    device_type = device.get('type', device_id.split('-')[0])  # Get type from config or ID
            
                    if device_type == 'fan' or device_id == 'fan':
                        speed = min(100, max(30, int(density * 200)))
                        devices[device_id]['state'] = True
                        devices[device_id]['speed'] = speed
                    elif device_type == 'light' or device_id == 'light':
                        brightness = min(100, max(40, int(density * 250)))
                        devices[device_id]['state'] = True
                        devices[device_id]['brightness'] = brightness
                    elif device_type == 'tv' or device_id == 'tv':
                        volume = min(100, max(10, int(density * 150)))
                        devices[device_id]['state'] = True
                        devices[device_id]['volume'] = volume
                    elif device_type == 'ac':
                        temperature = min(30, max(18, int(20 + density * 50)))
                        devices[device_id]['state'] = True
                        devices[device_id]['temperature'] = temperature
            else:
                turn_off_device()
                # Turn off all devices
                for device_id, device in devices.items():
                    devices[device_id]['state'] = False
                    if 'speed' in devices[device_id]:
                        devices[device_id]['speed'] = 0
                    if 'brightness' in devices[device_id]:
                        devices[device_id]['brightness'] = 0
                    if 'volume' in devices[device_id]:
                        devices[device_id]['volume'] = 0
                    if 'temperature' in devices[device_id]:
                        devices[device_id]['temperature'] = 20
        except Exception as e:
            logger.warning(f"GPIO control error: {e}")
        
        # Analyze crowd density with ResNet
        crowd_level = "Unknown"
        crowd_confidence = 0.0
        if USE_RESNET and resnet_model is not None:
            _, crowd_level, crowd_confidence = analyze_crowd_density(
                frame, resnet_model, crowd_classifier, resnet_transform, torch_device
            )
        
        # Calculate processing time and FPS
        processing_time = (time.time() - start_time) * 1000
        fps = 1000 / processing_time if processing_time > 0 else 0
        
        # Update global stats
        current_stats.update({
            'people_count': people_count,
            'density': round(density, 4),
            'device_status': device_status,
            'crowd_level': crowd_level,
            'crowd_confidence': round(crowd_confidence, 2),
            'tracked_ids': active_track_ids,
            'tracking_info': tracking_info,
            'processing_time': round(processing_time, 2),
            'fps': round(fps, 1),
            'frame_count': current_stats['frame_count'] + 1
        })
        
        # Draw tracking results on frame
        for x1, y1, x2, y2, track_id, conf in tracked_people:
            # Draw bounding box
            cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
            
            # Draw track ID and confidence
            label = f"ID:{track_id} ({conf:.2f})"
            cv2.putText(frame, label, (x1, y1 - 5), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 2)
        
        # Draw system info on frame
        cv2.putText(frame, f"People: {people_count}", (10, 30), 
                   cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 0), 2)
        cv2.putText(frame, f"Density: {density:.4f} ppl/m² | Device: {device_status.upper()}", 
                   (10, 60), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 255, 0), 2)
        cv2.putText(frame, f"Crowd: {crowd_level} ({crowd_confidence:.2f})", 
                   (10, 90), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 0, 255), 2)
        cv2.putText(frame, f"FPS: {fps:.1f} | Tracks: {len(active_track_ids)}", 
                   (10, 120), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 255), 2)
        
        # Update frame buffer
        frame_buffer = frame.copy()
        
        # Log to CSV
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        tracked_ids_str = ",".join(map(str, active_track_ids)) if active_track_ids else "None"
        
        with open(CSV_FILE, mode='a', newline='') as file:
            writer = csv.writer(file)
            writer.writerow([
                timestamp,
                f"Camera {CAMERA_ID}",
                people_count,
                f"{density:.4f}",
                device_status.upper(),
                f"{crowd_level} ({crowd_confidence:.2f})",
                tracked_ids_str,
                f"{processing_time:.2f}"
            ])
        
    except Exception as e:
        logger.error(f"Error processing frame: {e}")

def detection_loop():
    """Main detection loop running in separate thread"""
    global detection_running, cap
    
    logger.info("Starting detection loop")
    
    while detection_running:
        try:
            process_frame()
            time.sleep(0.033)  # ~30 FPS
        except Exception as e:
            logger.error(f"Error in detection loop: {e}")
            time.sleep(1)
    
    logger.info("Detection loop stopped")

def generate_frames():
    """Generate frames for video streaming"""
    global frame_buffer
    
    while True:
        if frame_buffer is not None and detection_running:
            try:
                # Encode frame as JPEG
                _, buffer = cv2.imencode('.jpg', frame_buffer, [cv2.IMWRITE_JPEG_QUALITY, 85])
                frame_bytes = buffer.tobytes()
                
                yield (b'--frame\r\n'
                       b'Content-Type: image/jpeg\r\n\r\n' + frame_bytes + b'\r\n')
            except Exception as e:
                logger.error(f"Error generating frame: {e}")
        else:
            # Send placeholder image when detection is not running
            placeholder = np.zeros((480, 640, 3), dtype=np.uint8)
            cv2.putText(placeholder, "Camera Feed Stopped", (200, 240), 
                       cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 255), 2)
            
            _, buffer = cv2.imencode('.jpg', placeholder)
            frame_bytes = buffer.tobytes()
            
            yield (b'--frame\r\n'
                   b'Content-Type: image/jpeg\r\n\r\n' + frame_bytes + b'\r\n')
        
        time.sleep(0.033)  # ~30 FPS

@app.route('/api/detection_status')
def detection_status():
    """Get current detection status and stats with device integration"""
    # Calculate overall device status
    any_device_on = any(d.get('state') for d in devices.values()) 
    return jsonify({
        'running': detection_running,
        'stats': {
            **current_stats,
            'devices': devices,
            'device_status': 'on' if any_device_on else current_stats.get('device_status', 'off'),
            'total_devices': len(devices),
            'active_devices': sum(1 for d in devices.values() if d.get('state'))
        }
    })


@app.route('/api/start_detection', methods=['POST'])
def start_detection():
    """Start detection process"""
    global detection_running, cap
    
    try:
        if not detection_running:
            # Initialize camera
            cap = cv2.VideoCapture(CAMERA_ID)
            if not cap.isOpened():
                return jsonify({'error': 'Cannot access camera'}), 500
            
            # Set camera properties
            cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
            cap.set(cv2.CAP_PROP_FPS, 30)
            cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
            cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
            
            detection_running = True
            
            # Start detection thread
            detection_thread = threading.Thread(target=detection_loop, daemon=True)
            detection_thread.start()
            
            logger.info("Detection started successfully")
            return jsonify({'status': 'Detection started'})
        else:
            return jsonify({'status': 'Detection already running'})
            
    except Exception as e:
        logger.error(f"Error starting detection: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/stop_detection', methods=['POST'])
def stop_detection():
    """Stop detection process"""
    global detection_running, cap, frame_buffer
    
    try:
        if detection_running:
            detection_running = False
            
            # Release camera
            if cap is not None:
                cap.release()
                cap = None
            
            # Clear frame buffer
            frame_buffer = None
            
            # Reset stats
            current_stats.update({
                'people_count': 0,
                'density': 0.0,
                'device_status': 'off',
                'crowd_level': 'unknown',
                'crowd_confidence': 0.0,
                'tracked_ids': [],
                'tracking_info': [],
                'processing_time': 0,
                'fps': 0
            })
            
            # Turn off devices
            try:
                turn_off_device()
            except:
                pass
            
            logger.info("Detection stopped successfully")
            return jsonify({'status': 'Detection stopped'})
        else:
            return jsonify({'status': 'Detection not running'})
            
    except Exception as e:
        logger.error(f"Error stopping detection: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/video_feed')
def video_feed():
    """Video streaming route"""
    return Response(generate_frames(), 
                   mimetype='multipart/x-mixed-replace; boundary=frame')

@app.route('/api/system_info')
def system_info():
    """Get system information"""
    return jsonify({
        'device': str(devices),
        'yolo_model': YOLO_MODEL_PATH,
        'resnet_enabled': USE_RESNET,
        'camera_id': CAMERA_ID,
        'camera_fov': CAMERA_FOV_M2,
        'density_threshold': DENSITY_THRESHOLD
    })

# Device Control API Routes (Added from pasted code)
@app.route('/device-control')
def device_control():
    """Render the device control page"""
    return render_template('device-control.html')

@app.route('/api/devices', methods=['GET'])
def get_devices():
    """Get all devices and their current states"""
    try:
        return jsonify({
            'status': 'success',
            'devices': devices,
            'timestamp': datetime.now().isoformat()
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500
    

@app.route('/api/device/toggle', methods=['POST'])
def toggle_device():
    """Toggle device on/off state"""
    try:
        data = request.get_json()
        device_id = data.get('device')
        new_state = data.get('state')

        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404
        
        # Update device state
        devices[device_id]['state'] = new_state
        devices[device_id]['last_updated'] = datetime.now().isoformat()

        # If turning off, reset control values
        if not new_state:
            if 'speed' in devices[device_id]:
                devices[device_id]['speed'] = 0
            if 'brightness' in devices[device_id]:
                devices[device_id]['brightness'] = 0
            if 'volume' in devices[device_id]:
                devices[device_id]['volume'] = 0
            if 'temperature' in devices[device_id]:
                devices[device_id]['temperature'] = 0

        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'toggle',
            'state': new_state,
            'timestamp': datetime.now().isoformat(),
            'device_name': devices[device_id]['name']
        })
        
        return jsonify({
            'status': 'success',
            'device': device_id,
            'new_state': new_state,
            'message': f"Device {devices[device_id]['name']} turned {'on' if new_state else 'off'}",
            'timestamp': devices[device_id]['last_updated']
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/control', methods=['POST'])
def control_device():
    """Update device control settings (brightness, speed, volume, etc.)"""
    try:
        data = request.get_json()
        device_id = data.get('device')
        control_type = data.get('control')
        value = data.get('value')
        
        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404
        
        # Validate control type and update device
        valid_controls = {
            'speed': ['fan'],
            'brightness': ['light'],
            'volume': ['tv'],
            'temperature': ['ac']
        }
        
        # Extract base device type from device_id (handles dynamic IDs like 'fan-123456')
        base_device_type = device_id.split('-')[0]
        valid_controls = {
            'speed': ['fan'],
            'brightness': ['light'],
            'volume': ['tv'],
            'temperature': ['ac']
        }

        if control_type not in valid_controls or base_device_type not in valid_controls[control_type]:
            return jsonify({
                'status': 'error',
                'message': f"Invalid control type '{control_type}' for device type '{base_device_type}'"
            }), 400

        # Validate value
        if not isinstance(value, (int, float)):
            return jsonify({
                'status': 'error',
                'message': f"Invalid value type for control '{control_type}'. Expected int or float."
            }), 400

        # Update the control value
        devices[device_id][control_type] = value
        devices[device_id]['last_updated'] = datetime.now().isoformat()

        # Auto-turn on device if control value > 0
        if value > 0:
            devices[device_id]['state'] = True

        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'control_update',
            'control_type': control_type,
            'value': value,
            'timestamp': datetime.now().isoformat(),
            'device_name': devices[device_id]['name']
        })
        
        return jsonify({
            'status': 'success',
            'device': device_id,
            'control': control_type,
            'value': value,
            'message': f"{devices[device_id]['name']} {control_type} set to {value}%",
            'timestamp': devices[device_id]['last_updated']
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/add', methods=['POST'])
def add_device():
    """Add a new device to the system"""
    try:
        data = request.get_json()
        device_type = data.get('type')
        device_name = data.get('name')
        device_room = data.get('room')
        
        if not all([device_type, device_name, device_room]):
            return jsonify({
                'status': 'error',
                'message': 'Missing required fields: type, name, room'
            }), 400
        
        # Generate unique device ID
        import time
        device_id = f"{device_type}-{int(time.time())}"
        
        # Create device configuration based on type
        device_config = {
            'name': device_name,
            'state': False,
            'room': device_room,
            'type': device_type,
            'last_updated': datetime.now().isoformat(),
            'created_at': datetime.now().isoformat()
        }
        
        # Add type-specific controls
        if device_type == 'fan':
            device_config['speed'] = 1
        elif device_type == 'light':
            device_config['brightness'] = 0
        elif device_type == 'tv':
            device_config['volume'] = 0
        elif device_type == 'ac':
            device_config['temperature'] = 20  # Default temperature
        
        # Add device to storage
        devices[device_id] = device_config
        
        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'device_added',
            'device_type': device_type,
            'device_name': device_name,
            'room': device_room,
            'timestamp': datetime.now().isoformat()
        })
        
        return jsonify({
            'status': 'success',
            'device_id': device_id,
            'device': device_config,
            'message': f"Device '{device_name}' added successfully"
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/remove/<device_id>', methods=['DELETE'])
def remove_device(device_id):
    """Remove a device from the system"""
    try:
        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404

        device_name = devices[device_id]['name']
        del devices[device_id]

        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'device_removed',
            'device_name': device_name,
            'timestamp': datetime.now().isoformat()
        })
        
        return jsonify({
            'status': 'success',
            'message': f"Device '{device_name}' removed successfully"
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/history', methods=['GET'])
def get_device_history():
    """Get device control history"""
    try:
        # Get last N entries (default 50)
        limit = request.args.get('limit', 50, type=int)
        
        return jsonify({
            'status': 'success',
            'history': device_history[-limit:],
            'total_entries': len(device_history)
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/stats', methods=['GET'])
def get_device_stats():
    """Get device statistics"""
    try:
        stats = {
            'total_devices': len(devices),
            'active_devices': sum(1 for d in devices.values() if d.get('state')),
            'inactive_devices': sum(1 for d in devices.values() if not d.get('state')),
            'devices_by_room': {},
            'devices_by_type': {}
        }
        
        # Count devices by room and type
        for d in devices.values():
            room = d.get('room', 'Unknown')
            device_type = d.get('type', 'Unknown')

            stats['devices_by_room'][room] = stats['devices_by_room'].get(room, 0) + 1
            stats['devices_by_type'][device_type] = stats['devices_by_type'].get(device_type, 0) + 1
        
        return jsonify({
            'status': 'success',
            'stats': stats,
            'timestamp': datetime.now().isoformat()
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/density')
def get_density():
    """Get current density from live detection stats"""
    return jsonify({
        "density": current_stats.get('density', 0),
        "people_count": current_stats.get('people_count', 0),
        "device_status": current_stats.get('device_status', 'off'),
        "timestamp": datetime.now().isoformat()
    })

@app.route('/api/device/status/<device_id>', methods=['GET'])
def get_device_status(device_id):
    """Get specific device status"""
    try:
        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404
        
        return jsonify({
            'status': 'success',
            'device_id': device_id,
            'device': devices[device_id]
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

# Error handlers
@app.errorhandler(404)
def not_found_error(error):
    return jsonify({
        'status': 'error',
        'message': 'Endpoint not found'
    }), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({
        'status': 'error',
        'message': 'Internal server error'
    }), 500

if __name__ == '__main__':
    try:
        logger.info("Starting Crowd Management System Backend")
        logger.info(f"Using devices: {devices}")
        logger.info(f"ResNet enabled: {USE_RESNET}")
        logger.info("Starting Flask server on http://0.0.0.0:5000")
        
        app.run(host='0.0.0.0', port=5000, debug=False, threaded=True)
        
    except KeyboardInterrupt:
        logger.info("Shutting down...")
    finally:
        # Cleanup
        detection_running = False
        if cap is not None:
            cap.release()
        cleanup_gpio()
        cv2.destroyAllWindows()
        logger.info("Cleanup completed")


---------------------------------------------------------------***********************************************************-----------------------------------------------------------------

device-control.html (newly updated with no issues):

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Device Control System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2rem;
            font-weight: 600;
        }

        .header h1 i {
            color: #667eea;
            margin-right: 10px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            text-decoration: none;
            color: #4a5568;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            gap: 30px;
        }

        .section-title {
            color: white;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .device-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .device-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #4a5568;
        }

        .device-icon {
            font-size: 1.8rem;
            padding: 10px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .power-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .power-switch.on {
            background: #48bb78;
        }

        .power-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .power-switch.on::after {
            transform: translateX(30px);
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e53e3e;
        }

        .status-indicator.active {
            background: #48bb78;
        }

        .controls-section {
            margin-top: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .slider-container {
            position: relative;
            margin-bottom: 10px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #718096;
        }

        .current-value {
            font-weight: 600;
            color: #667eea;
        }

        .add-device-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
        }

        .add-device-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .add-device-card i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .add-device-card h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #4a5568;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #4a5568;
        }

        .device-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .device-type {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .device-type:hover,
        .device-type.selected {
            border-color: #667eea;
            background: #f7fafc;
        }

        .device-type i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 40px;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .devices-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-home"></i> Smart Device Control</h1>
            <nav class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-users"></i> Crowd Management</a>
                <a href="/device-control.html" class="nav-link active"><i class="fas fa-home"></i> Device Control</a>
            </nav>
            <div class="auth-buttons">
                <button id="login-btn" class="btn btn-primary">Login</button>
                <button id="logout-btn" class="btn btn-danger" style="display: none;">Logout</button>
            </div>
        </header>

        <main class="main-content">
            <h2 class="section-title">
                <i class="fas fa-microchip"></i>
                Connected Devices
            </h2>

            <div class="devices-grid" id="devices-grid">
                <!-- Fan Device -->
                <div class="device-card" data-device="fan">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-fan"></i>
                            </div>
                            <span>Ceiling Fan</span>
                        </div>
                        <div class="power-switch" data-device="fan"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Speed Control</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="speed">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Light Device -->
                <div class="device-card" data-device="light">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <span>Smart Light</span>
                        </div>
                        <div class="power-switch" data-device="light"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Brightness</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="brightness">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TV Device -->
                <div class="device-card" data-device="tv">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-tv"></i>
                            </div>
                            <span>Smart TV</span>
                        </div>
                        <div class="power-switch" data-device="tv"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Volume</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="volume">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Device Card -->
                <div class="device-card add-device-card" id="add-device-btn">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Add New Device</h3>
                    <p>Connect a new smart device</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Made with 💡 by Yesvin Veluchamy for Summer Internship &copy; 2025</p>
        </footer>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Device</h2>
                <span class="close">&times;</span>
            </div>
            
            <div class="device-types">
                <div class="device-type" data-type="fan">
                    <i class="fas fa-fan"></i>
                    <div>Fan</div>
                </div>
                <div class="device-type" data-type="light">
                    <i class="fas fa-lightbulb"></i>
                    <div>Light</div>
                </div>
                <div class="device-type" data-type="tv">
                    <i class="fas fa-tv"></i>
                    <div>TV</div>
                </div>
                <div class="device-type" data-type="ac">
                    <i class="fas fa-snowflake"></i>
                    <div>AC</div>
                </div>
            </div>

            <form id="deviceForm">
                <div class="form-group">
                    <label for="deviceName">Device Name</label>
                    <input type="text" id="deviceName" name="deviceName" placeholder="Enter device name" required>
                </div>
                
                <div class="form-group">
                    <label for="deviceRoom">Room</label>
                    <select id="deviceRoom" name="deviceRoom" required>
                        <option value="">Select Room</option>
                        <option value="living-room">Living Room</option>
                        <option value="bedroom">Bedroom</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="bathroom">Bathroom</option>
                        <option value="office">Office</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Device</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables for device management
        let devices = {};
        let selectedDeviceType = '';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadDevices();
            setInterval(loadDevices, 2000); // Poll backend every 2 seconds for real-time sync
        });

        function initializeEventListeners() {
            // Power switch toggles
            document.querySelectorAll('.power-switch').forEach(switchEl => {
                switchEl.addEventListener('click', function() {
                    const deviceId = this.closest('.device-card').getAttribute('data-device');
                    sendDeviceState(deviceId, !this.classList.contains('on'));
                });
            });

            // Slider controls
            document.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('change', function() {
                    const value = this.value;
                    const deviceCard = this.closest('.device-card');
                    const deviceId = deviceCard.getAttribute('data-device');
                    const controlType = this.getAttribute('data-control');
                    sendControlUpdate(deviceId, controlType, value);
                });
            });

            // Add device modal
            const modal = document.getElementById('addDeviceModal');
            const addBtn = document.getElementById('add-device-btn');
            const closeBtn = document.querySelector('.close');

            addBtn.addEventListener('click', () => {
                modal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                resetModal();
            });

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    resetModal();
                }
            });

            // Device type selection
            document.querySelectorAll('.device-type').forEach(type => {
                type.addEventListener('click', function() {
                    document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDeviceType = this.getAttribute('data-type');
                });
            });

            // Form submission
            document.getElementById('deviceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewDevice();
            });

            // Auth buttons
            document.getElementById('login-btn').addEventListener('click', () => {
                // Simulate login - in real implementation, this would redirect to login page
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'block';
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'none';
            });
        }

        function sendDeviceState(deviceId, isOn) {
            fetch('/api/device/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, state: isOn })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device state updated:', data);
            })
            .catch(error => {
                console.error('Error updating device state:', error);
            });
        }

        function sendControlUpdate(deviceId, controlType, value) {
            fetch('/api/device/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, control: controlType, value: parseInt(value) })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device control updated:', data);
            })
            .catch(error => {
                console.error('Error updating device control:', error);
            });
        }

        function addNewDevice() {
            if (!selectedDeviceType) {
                alert('Please select a device type');
                return;
            }
            const deviceName = document.getElementById('deviceName').value;
            const deviceRoom = document.getElementById('deviceRoom').value;
            if (!deviceName || !deviceRoom) {
                alert('Please fill in all fields');
                return;
            }
            fetch('/api/device/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: selectedDeviceType, name: deviceName, room: deviceRoom })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('addDeviceModal').style.display = 'none';
                resetModal();
                // UI will update on next poll from backend
            })
            .catch(error => {
                console.error('Error adding new device:', error);
            });
        }

        function resetModal() {
            document.getElementById('deviceForm').reset();
            document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
            selectedDeviceType = '';
        }

        function loadDevices() {
            fetch('/api/devices')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateDevicesUI(data.devices);
                }
            })
            .catch(error => {
                console.error('Error loading devices:', error);
            });
        }

        // Replace the updateDevicesUI function with this updated version
function updateDevicesUI(devices) {
    const devicesGrid = document.getElementById('devices-grid');
    
    // Update existing device cards and create new ones
    for (const [deviceId, deviceInfo] of Object.entries(devices)) {
        let existingCard = devicesGrid.querySelector(`[data-device="${deviceId}"]`);
        
        if (existingCard && !existingCard.classList.contains('add-device-card')) {
            // Update existing card
            updateSingleDeviceUI(existingCard, deviceInfo);
        } else if (!existingCard) {
            // Create new card for devices not already present
            createDeviceCard(deviceId, deviceInfo);
        }
    }
    
    // Remove cards for devices that no longer exist in backend
    devicesGrid.querySelectorAll('.device-card:not(.add-device-card)').forEach(card => {
        const deviceId = card.getAttribute('data-device');
        if (!devices[deviceId]) {
            card.remove();
        }
    });
}

// Replace the createDeviceCard function with this updated version
function createDeviceCard(deviceId, deviceInfo) {
    const devicesGrid = document.getElementById('devices-grid');
    
    // Don't duplicate cards
    if (devicesGrid.querySelector(`[data-device="${deviceId}"]`)) return;

    // Card container
    const card = document.createElement('div');
    card.className = 'device-card';
    card.setAttribute('data-device', deviceId);

    // Device icon mapping
    const iconMap = {
        'fan': 'fa-fan',
        'light': 'fa-lightbulb', 
        'tv': 'fa-tv',
        'ac': 'fa-snowflake'
    };
    const iconClass = iconMap[deviceInfo.type] || 'fa-question';

    // Device header (consistent for all devices)
    card.innerHTML = `
        <div class="device-header">
            <div class="device-title">
                <div class="device-icon">
                    <i class="fas ${iconClass}"></i>
                </div>
                <span>${deviceInfo.name || deviceId}</span>
            </div>
            <div class="power-switch" data-device="${deviceId}"></div>
        </div>
        <div class="device-status">
            <div class="status-indicator"></div>
            <span class="status-text">Offline</span>
        </div>
        <div class="controls-section"></div>
    `;

    // Controls section - standardized for all device types
    const controlsSection = card.querySelector('.controls-section');
    const controlsConfig = getControlsConfig(deviceInfo.type, deviceInfo);
    
    controlsSection.innerHTML = controlsConfig.html;

    // Insert before the add-device card
    const addDeviceCard = devicesGrid.querySelector('.add-device-card');
    devicesGrid.insertBefore(card, addDeviceCard);

    // Add event listeners
    addDeviceEventListeners(card, deviceId);

    // Initial UI update
    updateSingleDeviceUI(card, deviceInfo);
}

// New helper function for consistent control configurations
function getControlsConfig(deviceType, deviceInfo) {
    const configs = {
        'fan': {
            html: `
                <div class="control-group">
                    <label class="control-label">Speed Control</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="0" max="100" value="${deviceInfo.speed || 0}" data-control="speed">
                        <div class="slider-value">
                            <span>0%</span>
                            <span class="current-value">${deviceInfo.speed || 0}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            `
        },
        'light': {
            html: `
                <div class="control-group">
                    <label class="control-label">Brightness</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="0" max="100" value="${deviceInfo.brightness || 0}" data-control="brightness">
                        <div class="slider-value">
                            <span>0%</span>
                            <span class="current-value">${deviceInfo.brightness || 0}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            `
        },
        'tv': {
            html: `
                <div class="control-group">
                    <label class="control-label">Volume</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="0" max="100" value="${deviceInfo.volume || 0}" data-control="volume">
                        <div class="slider-value">
                            <span>0%</span>
                            <span class="current-value">${deviceInfo.volume || 0}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            `
        },
        'ac': {
            html: `
                <div class="control-group">
                    <label class="control-label">Temperature</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="16" max="30" value="${deviceInfo.temperature || 20}" data-control="temperature">
                        <div class="slider-value">
                            <span>16°C</span>
                            <span class="current-value">${deviceInfo.temperature || 20}°C</span>
                            <span>30°C</span>
                        </div>
                    </div>
                </div>
            `
        }
    };
    
    return configs[deviceType] || {
        html: `<div class="control-group"><p>No controls available</p></div>`
    };
}

// New helper function for consistent event listener attachment
function addDeviceEventListeners(card, deviceId) {
    // Power switch event
    const powerSwitch = card.querySelector('.power-switch');
    if (powerSwitch) {
        powerSwitch.addEventListener('click', function() {
            sendDeviceState(deviceId, !this.classList.contains('on'));
        });
    }

    // Slider events
    card.querySelectorAll('.slider').forEach(slider => {
        slider.addEventListener('input', function() {
            // Update display value immediately for responsive UI
            const value = this.value;
            const controlType = this.getAttribute('data-control');
            const currentValueSpan = this.parentElement.querySelector('.current-value');
            
            if (currentValueSpan) {
                if (controlType === 'temperature') {
                    currentValueSpan.textContent = value + '°C';
                } else {
                    currentValueSpan.textContent = value + '%';
                }
            }
        });
        
        slider.addEventListener('change', function() {
            const value = this.value;
            const controlType = this.getAttribute('data-control');
            sendControlUpdate(deviceId, controlType, value);
        });
    });
}

// Updated updateSingleDeviceUI function for better consistency
function updateSingleDeviceUI(card, deviceInfo) {
    // Power switch state
    const powerSwitch = card.querySelector('.power-switch');
    if (powerSwitch) {
        if (deviceInfo.state) {
            powerSwitch.classList.add('on');
            powerSwitch.classList.remove('off');
        } else {
            powerSwitch.classList.remove('on');
            powerSwitch.classList.add('off');
        }
    }
    
    // Status indicator
    const statusIndicator = card.querySelector('.status-indicator');
    const statusText = card.querySelector('.status-text');
    if (statusIndicator && statusText) {
        if (deviceInfo.state) {
            statusIndicator.classList.add('active');
            statusText.textContent = 'Online';
        } else {
            statusIndicator.classList.remove('active');
            statusText.textContent = 'Offline';
        }
    }
    
    // Update all sliders and their display values
    card.querySelectorAll('.slider').forEach(slider => {
        const controlType = slider.getAttribute('data-control');
        if (deviceInfo[controlType] !== undefined) {
            slider.value = deviceInfo[controlType];
            
            const currentValueSpan = slider.parentElement.querySelector('.current-value');
            if (currentValueSpan) {
                if (controlType === 'temperature') {
                    currentValueSpan.textContent = deviceInfo[controlType] + '°C';
                } else {
                    currentValueSpan.textContent = deviceInfo[controlType] + '%';
                }
            }
        }
    });
}
    </script>
</body>
</html>

---------------------------------------------------------------***********************************************************-----------------------------------------------------------------

device-control.js (newly updated code without no issues) : 


// Device Control System JavaScript
// Updated to work with the existing Flask API endpoints

// DOM Elements
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const mainContent = document.getElementById('main-content');
const devicesGrid = document.getElementById('devices-grid');
const systemStatus = document.getElementById('system-status');

// State variables (using memory instead of localStorage)
let isAuthenticated = false;
let deviceStates = {};
let authToken = null;
let detectionRunning = false;
let currentStats = {};

// API Base URL
const API_BASE = '/api';

// Initialize the application
function init() {
    console.log('🚀 Initializing Device Control System...');
    checkAuthStatus();
    setupEventListeners();
    // Load devices first, then start control loop after devices are loaded
    loadDevicesFromServer().then(() => {
        console.log('✅ Devices loaded successfully');
        // Delay starting the density control to ensure DOM is ready
        setTimeout(() => {
            startDensityControlLoop();
            console.log('🔄 Density control loop started');
        }, 1000);
    }).catch(err => {
        console.error('❌ Error loading devices:', err);
    });
    loadSystemStatus();
    updateUI();
    
    // Start periodic updates
    setInterval(updateSystemStatus, 2000); // Update every 2 seconds
    setInterval(loadDevices, 2000);
}

// Authentication functions
function checkAuthStatus() {
    // In a real application, you would check with your server
    // For now, we'll use a simple in-memory authentication state
    isAuthenticated = authToken !== null;
    console.log('Authentication status:', isAuthenticated);
}

function setupEventListeners() {
    // Authentication event listeners
    if (loginBtn) {
        loginBtn.addEventListener('click', () => {
            simulateLogin();
        });
    }
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
    }
    
    // Detection control buttons
    const startDetectionBtn = document.getElementById('start-detection-btn');
    const stopDetectionBtn = document.getElementById('stop-detection-btn');
    
    if (startDetectionBtn) {
        startDetectionBtn.addEventListener('click', startDetection);
    }
    
    if (stopDetectionBtn) {
        stopDetectionBtn.addEventListener('click', stopDetection);
    }
    
    // Device switch toggles
    document.querySelectorAll('.power-switch').forEach(switchEl => {
        switchEl.addEventListener('click', function() {
            const deviceId = this.getAttribute('data-device');
            toggleDeviceState(deviceId, this);
        });
    });
    
    // Slider controls
    document.querySelectorAll('.slider').forEach(slider => {
        slider.addEventListener('input', function() {
            const value = this.value;
            const currentValueSpan = this.parentElement.querySelector('.current-value');
            if (currentValueSpan) {
                currentValueSpan.textContent = value + '%';
            }
            
            const deviceCard = this.closest('.device-card');
            const deviceId = deviceCard.getAttribute('data-device');
            const controlType = this.getAttribute('data-control');
            
            updateDeviceControl(deviceId, controlType, value);
        });
    });
    
    // Add device button
    const addDeviceBtn = document.getElementById('add-device-btn');
    if (addDeviceBtn) {
        addDeviceBtn.addEventListener('click', function() {
            showAddDeviceModal();
        });
    }
    
    // Modal event listeners
    setupModalEventListeners();
}

function setupModalEventListeners() {
    const modal = document.getElementById('addDeviceModal');
    const closeBtn = document.querySelector('.close');
    
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            hideAddDeviceModal();
        });
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideAddDeviceModal();
        }
    });

    window.location.href = '/frontend/device-control.html';
        fetch('/frontend/device-control.html');
    
    // Device type selection
    document.querySelectorAll('.device-type').forEach(type => {
        type.addEventListener('click', function() {
            document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
            this.classList.add('selected');
        });
    });
    
    // Form submission
    const deviceForm = document.getElementById('deviceForm');
    if (deviceForm) {
        deviceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleAddDevice();
        });
    }
}

function simulateLogin() {
    // Simulate authentication
    authToken = 'simulated-token-' + Date.now();
    isAuthenticated = true;
    updateUI();
    console.log('Logged in successfully');
}

function logout() {
    authToken = null;
    isAuthenticated = false;
    deviceStates = {};
    updateUI();
    console.log('Logged out successfully');
}

function updateUI() {
    // Update authentication UI
    if (loginBtn) {
        loginBtn.style.display = isAuthenticated ? 'none' : 'block';
    }
    if (logoutBtn) {
        logoutBtn.style.display = isAuthenticated ? 'block' : 'none';
    }
    
    if (mainContent) {
        mainContent.style.display = isAuthenticated ? 'block' : 'none';
    }
}

// Detection Control Functions
function startDetection() {
    fetch(`${API_BASE}/start_detection`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Detection started:', data);
        detectionRunning = true;
        updateDetectionUI();
        showNotification('Detection started successfully', 'success');
    })
    .catch(error => {
        console.error('Error starting detection:', error);
        showNotification('Failed to start detection', 'error');
    });
}

function stopDetection() {
    fetch(`${API_BASE}/stop_detection`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Detection stopped:', data);
        detectionRunning = false;
        updateDetectionUI();
        showNotification('Detection stopped successfully', 'success');
    })
    .catch(error => {
        console.error('Error stopping detection:', error);
        showNotification('Failed to stop detection', 'error');
    });
}

function updateDetectionUI() {
    const startBtn = document.getElementById('start-detection-btn');
    const stopBtn = document.getElementById('stop-detection-btn');
    const statusIndicator = document.getElementById('detection-status');
    
    if (startBtn) startBtn.disabled = detectionRunning;
    if (stopBtn) stopBtn.disabled = !detectionRunning;
    
    if (statusIndicator) {
        statusIndicator.textContent = detectionRunning ? 'Running' : 'Stopped';
        statusIndicator.className = detectionRunning ? 'status-active' : 'status-inactive';
    }
}

// System Status Functions
function loadSystemStatus() {
    fetch(`${API_BASE}/detection_status`)
    .then(response => response.json())
    .then(data => {
        detectionRunning = data.running;
        currentStats = data.stats;
        updateSystemStatusUI(data);
        updateDetectionUI();
    })
    .catch(error => {
        console.error('Error loading system status:', error);
    });
}

function updateSystemStatus() {
    if (!isAuthenticated) return;
    
    fetch(`${API_BASE}/detection_status`)
    .then(response => response.json())
    .then(data => {
        detectionRunning = data.running;
        currentStats = data.stats;
        updateSystemStatusUI(data);
    })
    .catch(error => {
        console.error('Error updating system status:', error);
    });
}

function updateSystemStatusUI(data) {
    // Update people count
    const peopleCountEl = document.getElementById('people-count');
    if (peopleCountEl) {
        peopleCountEl.textContent = data.stats.people_count || 0;
    }
    
    // Update density
    const densityEl = document.getElementById('density-value');
    if (densityEl) {
        densityEl.textContent = (data.stats.density || 0).toFixed(4);
    }
    
    // Update device status
    const deviceStatusEl = document.getElementById('auto-device-status');
    if (deviceStatusEl) {
        deviceStatusEl.textContent = data.stats.device_status || 'off';
        deviceStatusEl.className = data.stats.device_status === 'on' ? 'status-on' : 'status-off';
    }
    
    // Update crowd level
    const crowdLevelEl = document.getElementById('crowd-level');
    if (crowdLevelEl) {
        crowdLevelEl.textContent = `${data.stats.crowd_level} (${data.stats.crowd_confidence}%)`;
    }
    
    // Update FPS
    const fpsEl = document.getElementById('fps-value');
    if (fpsEl) {
        fpsEl.textContent = data.stats.fps || 0;
    }
    
    // Update tracked IDs
    const trackedIdsEl = document.getElementById('tracked-ids');
    if (trackedIdsEl) {
        const ids = data.stats.tracked_ids || [];
        trackedIdsEl.textContent = ids.length > 0 ? ids.join(', ') : 'None';
    }
    
    // Update processing time
    const processingTimeEl = document.getElementById('processing-time');
    if (processingTimeEl) {
        processingTimeEl.textContent = `${data.stats.processing_time || 0}ms`;
    }
}

// Device Control Functions
function toggleDeviceState(deviceId, switchElement) {
    const isCurrentlyOn = switchElement.classList.contains('on');
    const newState = !isCurrentlyOn;

    // Optimistically update UI
    updateDeviceUI(deviceId, newState, switchElement);

    // Send to backend
    fetch(`${API_BASE}/device/toggle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device: deviceId, state: newState })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'success') {
            // If backend says error, revert UI
            updateDeviceUI(deviceId, isCurrentlyOn, switchElement);
            showNotification(data.message, 'error');
        }
    })
    .catch(() => {
        // On network error, revert UI
        updateDeviceUI(deviceId, isCurrentlyOn, switchElement);
        showNotification('Network error occurred', 'error');
    });
}

function updateDeviceUI(deviceId, isOn, switchElement) {
    const deviceCard = switchElement.closest('.device-card');
    const statusIndicator = deviceCard.querySelector('.status-indicator');
    const statusText = deviceCard.querySelector('.status-text');
    
    if (isOn) {
        switchElement.classList.add('on');
        switchElement.classList.remove('off');
        if (statusIndicator) statusIndicator.classList.add('active');
        if (statusText) statusText.textContent = 'Online';
    } else {
        switchElement.classList.remove('on');
        switchElement.classList.add('off');
        if (statusIndicator) statusIndicator.classList.remove('active');
        if (statusText) statusText.textContent = 'Offline';
        
        // Reset all sliders to 0
        deviceCard.querySelectorAll('.slider').forEach(slider => {
            slider.value = 0;
            const currentValueSpan = slider.parentElement.querySelector('.current-value');
            if (currentValueSpan) {
                currentValueSpan.textContent = '0%';
            }
        });
    }
}

function updateDeviceControl(deviceId, controlType, value) {
    const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
    const slider = deviceCard.querySelector(`.slider[data-control="${controlType}"]`);
    const currentValueSpan = slider.parentElement.querySelector('.current-value');

    // Optimistically update UI
    slider.value = value;
    if (currentValueSpan) currentValueSpan.textContent = value + '%';

    // Send to backend
    fetch(`${API_BASE}/device/control`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ device: deviceId, control: controlType, value: parseInt(value) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'success') {
            // If backend says error, revert UI (will be fixed on next poll)
            showNotification(data.message, 'error');
        }
    })
    .catch(() => {
        showNotification('Network error occurred', 'error');
    });
}

function showAddDeviceModal() {
    const modal = document.getElementById('addDeviceModal');
    if (modal) {
        modal.style.display = 'block';
    }
}

function hideAddDeviceModal() {
    const modal = document.getElementById('addDeviceModal');
    if (modal) {
        modal.style.display = 'none';
        resetAddDeviceForm();
    }
}

function resetAddDeviceForm() {
    const form = document.getElementById('deviceForm');
    if (form) {
        form.reset();
    }
    document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
}

function handleAddDevice() {
    const selectedType = document.querySelector('.device-type.selected');
    if (!selectedType) {
        showNotification('Please select a device type', 'error');
        return;
    }
    
    const deviceType = selectedType.getAttribute('data-type');
    const deviceName = document.getElementById('deviceName').value;
    const deviceRoom = document.getElementById('deviceRoom').value;
    
    if (!deviceName || !deviceRoom) {
        showNotification('Please fill in all fields', 'error');
        return;
    }
    
    // Send new device to server
    fetch(`${API_BASE}/device/add`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: deviceType,
            name: deviceName,
            room: deviceRoom
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('New device added:', data);
            // Create device card in UI
            createDeviceCard(data.device_id, data.device);
            hideAddDeviceModal();
            showNotification(data.message, 'success');
        } else {
            console.error('Error adding device:', data.message);
            showNotification('Error adding device: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        showNotification('Network error. Please try again.', 'error');
    });
}

function createDeviceCard(deviceId, device) {
    const devicesGrid = document.getElementById('devices-grid');
    const addDeviceCard = document.querySelector('.add-device-card');
    
    if (!devicesGrid) return;
    
    const icons = {
        fan: 'fas fa-fan',
        light: 'fas fa-lightbulb',
        tv: 'fas fa-tv',
        ac: 'fas fa-snowflake'
    };
    
    const controls = {
        fan: { label: 'Speed Control', type: 'speed' },
        light: { label: 'Brightness', type: 'brightness' },
        tv: { label: 'Volume', type: 'volume' },
        ac: { label: 'Temperature', type: 'temperature' }
    };
    
    const deviceType = device.type || 'unknown';
    const deviceCard = document.createElement('div');
    deviceCard.className = 'device-card';
    deviceCard.setAttribute('data-device', deviceId);
    
    deviceCard.innerHTML = `
        <div class="device-header">
            <div class="device-title">
                <div class="device-icon">
                    <i class="${icons[deviceType] || 'fas fa-microchip'}"></i>
                </div>
                <span>${device.name} (${device.room})</span>
            </div>
            <div class="power-switch off" data-device="${deviceId}"></div>
        </div>
        <div class="device-status">
            <div class="status-indicator"></div>
            <span class="status-text">Offline</span>
        </div>
        <div class="controls-section">
            <div class="control-group">
                <label class="control-label">${controls[deviceType]?.label || 'Control'}</label>
                <div class="slider-container">
                    <input type="range" class="slider" min="0" max="100" value="0" data-control="${controls[deviceType]?.type || 'value'}">
                    <div class="slider-value">
                        <span>0%</span>
                        <span class="current-value">0%</span>
                        <span>100%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="device-actions">
            <button class="remove-device-btn" onclick="removeDevice('${deviceId}')">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
    `;
    
    if (addDeviceCard) {
        devicesGrid.insertBefore(deviceCard, addDeviceCard);
    } else {
        devicesGrid.appendChild(deviceCard);
    }
    
    // Add event listeners to new device
    const powerSwitch = deviceCard.querySelector('.power-switch');
    const slider = deviceCard.querySelector('.slider');
    
    if (powerSwitch) {
        powerSwitch.addEventListener('click', function() {
            toggleDeviceState(deviceId, this);
        });
    }
    
    if (slider) {
        slider.addEventListener('input', function() {
            const value = this.value;
            const currentValueSpan = this.parentElement.querySelector('.current-value');
            if (currentValueSpan) {
                currentValueSpan.textContent = value + '%';
            }
            
            const controlType = this.getAttribute('data-control');
            updateDeviceControl(deviceId, controlType, value);
        });
    }
}

function removeDevice(deviceId) {
    if (!confirm('Are you sure you want to remove this device?')) {
        return;
    }
    
    fetch(`${API_BASE}/device/remove/${deviceId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Remove device card from UI
            const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
            if (deviceCard) {
                deviceCard.remove();
            }
            delete deviceStates[deviceId];
            showNotification(data.message, 'success');
        } else {
            showNotification('Error removing device: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        showNotification('Network error occurred', 'error');
    });
}

function loadDevicesFromServer() {
    console.log('📱 Loading devices from server...');
    return new Promise((resolve, reject) => {
        fetch('/api/devices')
            .then(async response => {
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Error response from server:', text);
                    throw new Error(`Server responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📱 Devices loaded:', data.devices);
                updateDevicesUI(data.devices);
                
                // Add debugging to see device structure
                if (data.devices) {
                    console.log('📊 Device structure:', JSON.stringify(data.devices, null, 2));
                }
                
                // Show debug info about device cards in DOM
                const deviceCards = document.querySelectorAll('.device-card');
                console.log(`📱 Found ${deviceCards.length} device cards in DOM:`);
                deviceCards.forEach(card => {
                    const id = card.getAttribute('data-device');
                    console.log(`- Device card: ${id}`);
                });
                
                resolve(data.devices);
            })
            .catch(error => {
                console.error('❌ Error loading devices:', error);
                reject(error);
            });
    });
}


function updateDevicesUI(devices) {
    Object.keys(devices).forEach(deviceId => {
        const device = devices[deviceId];
        const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
        if (deviceCard) {
            // Power switch
            const powerSwitch = deviceCard.querySelector('.power-switch');
            if (powerSwitch) {
                if (device.state) {
                    powerSwitch.classList.add('on');
                    powerSwitch.classList.remove('off');
                } else {
                    powerSwitch.classList.remove('on');
                    powerSwitch.classList.add('off');
                }
            }
            // Slider
            const slider = deviceCard.querySelector('.slider');
            if (slider) {
                const controlType = slider.getAttribute('data-control');
                if (device[controlType] !== undefined) {
                    slider.value = device[controlType];
                    const currentValueSpan = slider.parentElement.querySelector('.current-value');
                    if (currentValueSpan) {
                        currentValueSpan.textContent = device[controlType] + '%';
                    }
                }
            }
        }
    });
}

// Notification System
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button class="notification-close">&times;</button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
    
    // Manual close
    const closeBtn = notification.querySelector('.notification-close');
    closeBtn.addEventListener('click', () => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    });
}

// Load system information
function loadSystemInfo() {
    fetch(`${API_BASE}/system_info`)
    .then(response => response.json())
    .then(data => {
        console.log('System info:', data);
        // Update system info UI if elements exist
        const deviceEl = document.getElementById('system-device');
        if (deviceEl) deviceEl.textContent = data.device;
        
        const yoloEl = document.getElementById('yolo-model');
        if (yoloEl) yoloEl.textContent = data.yolo_model;
        
        const resnetEl = document.getElementById('resnet-enabled');
        if (resnetEl) resnetEl.textContent = data.resnet_enabled ? 'Yes' : 'No';
    })
    .catch(error => {
        console.error('Error loading system info:', error);
    });
}

// Density Control Config
const DENSITY_POLL_INTERVAL = 2000; // 2 seconds

function startDensityControlLoop() {
    console.log(`🔄 Starting density control loop (interval: ${DENSITY_POLL_INTERVAL}ms)`);
    
    // Run once immediately to check if everything works
    fetchAndApplyDensity().then(() => {
        console.log('✅ Initial density control check complete');
    }).catch(err => {
        console.error('❌ Error in initial density control:', err);
    });
    
    // Then start the interval
    setInterval(fetchAndApplyDensity, DENSITY_POLL_INTERVAL);
    // Also manually trigger the loop when detection status changes
    document.getElementById('start-detection-btn')?.addEventListener('click', () => {
        setTimeout(fetchAndApplyDensity, 1000);
    });
}

async function fetchAndApplyDensity() {
    try {
        // First get detection status to check people count
        const detectionRes = await fetch('/api/detection_status');
        const detectionData = await detectionRes.json();
        const peopleCount = detectionData.stats?.people_count || 0;
        
        // Get density data
        const densityRes = await fetch('/api/density');
        const densityData = await densityRes.json();
        const density = densityData.density || 0;

        // Clear debug log to track the automation process
        console.clear();
        console.log(`🔍 DETECTION DATA: People count: ${peopleCount}, Density: ${density}`);
        console.log(`⏱️ Time: ${new Date().toLocaleTimeString()}`);
        
        // Auto-control based on presence detection
        if (peopleCount > 0) {
            console.log("👤 PERSON DETECTED! Activating auto-control...");
            
            // Get all available devices in the DOM
            const deviceCards = document.querySelectorAll('.device-card');
            console.log(`📱 Found ${deviceCards.length} devices in DOM`);
            
            // List all devices found
            deviceCards.forEach(card => {
                const deviceId = card.getAttribute('data-device');
                console.log(`- Device found: ${deviceId}`);
            });
            
            // Turn on devices (if they're not already on)
            deviceCards.forEach(card => {
                const deviceId = card.getAttribute('data-device');
                if (deviceId === 'fan' || deviceId === 'light') {
                    turnOnDeviceIfNeeded(deviceId);
                }
            });
            
            // Calculate control values based on density
            // Map density to control value with a more sensitive scale
            // Higher density = higher control values (max 100)
            const fanSpeedValue = calculateControlValue(density, 0.3, 30, 100);
            const lightBrightnessValue = calculateControlValue(density, 0.3, 40, 100);
            
            console.log(`🎛️ AUTO-ADJUSTING: Fan: ${fanSpeedValue}%, Light: ${lightBrightnessValue}%`);
            
            // Apply to devices
            autoAdjustDevice('fan', 'speed', fanSpeedValue);
            autoAdjustDevice('light', 'brightness', lightBrightnessValue);
        } else {
            // No people detected - devices can remain in their current state
            console.log("❌ NO PEOPLE DETECTED - Devices remain in current state");
        }
    } catch (err) {
        console.error('❌ Density control error:', err);
    }
}

// Calculate control value based on density with custom scaling
function calculateControlValue(density, threshold, minValue, maxValue) {
    if (density <= 0) return 0;
    
    // Apply a non-linear scaling to make the control more responsive
    // Square root function gives more granular control at lower densities
    const scaledDensity = Math.sqrt(density) * 2;
    
    // Clamp the value between min and max
    return Math.min(maxValue, Math.max(minValue, Math.round(scaledDensity * 100)));
}

// Check and turn on a device if it's not already on
function turnOnDeviceIfNeeded(deviceId) {
    const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
    if (!deviceCard) {
        console.warn(`⚠️ Device not found: ${deviceId}`);
        return;
    }
    
    const powerSwitch = deviceCard.querySelector('.power-switch');
    if (!powerSwitch) {
        console.warn(`⚠️ Power switch not found for device: ${deviceId}`);
        return;
    }
    
    if (!powerSwitch.classList.contains('on')) {
        console.log(`🔌 AUTO-TURNING ON: ${deviceId}`);
        // Force change UI immediately
        powerSwitch.classList.add('on');
        powerSwitch.classList.remove('off');
        
        const statusIndicator = deviceCard.querySelector('.status-indicator');
        const statusText = deviceCard.querySelector('.status-text');
        
        if (statusIndicator) statusIndicator.classList.add('active');
        if (statusText) statusText.textContent = 'Online';
        
        // Then update server state
        toggleDeviceState(deviceId, powerSwitch);
    } else {
        console.log(`✓ Device already on: ${deviceId}`);
    }
}

function autoAdjustDevice(deviceId, controlType, value) {
    const deviceCard = document.querySelector(`[data-device="${deviceId}"]`);
    if (!deviceCard) {
        console.warn(`⚠️ Cannot adjust - Device not found: ${deviceId}`);
        return;
    }
    const slider = deviceCard.querySelector(`.slider[data-control="${controlType}"]`);
    if (!slider) {
        console.warn(`⚠️ Control slider not found: ${deviceId} - ${controlType}`);
        return;
    }
    
    const powerSwitch = deviceCard.querySelector('.power-switch');
    if (!powerSwitch) {
        console.warn(`⚠️ Power switch not found: ${deviceId}`);
        return;
    }

    // Ensure device is on before adjusting
    if (!powerSwitch.classList.contains('on')) {
        console.log(`🔌 Auto-turning on ${deviceId} before adjusting`);
        turnOnDeviceIfNeeded(deviceId);
    }
    
    // Only update if the value is different (reduces unnecessary updates)
    if (parseInt(slider.value) !== value) {
        console.log(`🎚️ Adjusting ${deviceId} ${controlType} to ${value}%`);
        
        // Force UI update immediately for responsive feel
        slider.value = value;
        
        // This triggers browser UI update for the slider
        const event = new Event('input', { bubbles: true });
        slider.dispatchEvent(event);
        
        const currentValueSpan = slider.parentElement.querySelector('.current-value');
        if (currentValueSpan) {
            currentValueSpan.textContent = value + '%';
        }
        
        // Update device control via API
        fetch(`${API_BASE}/device/control`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device: deviceId,
                control: controlType,
                value: parseInt(value)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log(`✓ Successfully adjusted ${deviceId} ${controlType}`);
                // Update local state
                if (!deviceStates[deviceId]) deviceStates[deviceId] = {};
                deviceStates[deviceId][controlType] = parseInt(value);
            } else {
                console.error(`❌ Error adjusting ${deviceId}: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('❌ Network error in auto-adjust:', error);
        });
    } else {
        console.log(`✓ ${deviceId} ${controlType} already at ${value}%`);
    }
}

// Poll and sync devices from server
function pollAndSyncDevices() {
    fetch('/api/devices')
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                updateDevicesUI(data.devices);
            }
        })
        .catch(err => console.error('Device poll error:', err));
}

// Call this every 2 seconds
setInterval(pollAndSyncDevices, 2000);

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    init();
    loadSystemInfo();
    startDensityControlLoop();
});




---------------------------------------------------------------***********************************************************-----------------------------------------------------------------

scripts.js (newly update without no issues) : 


// DOM Elements
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loginModal = document.getElementById('login-modal');
const closeModal = document.querySelector('.close-modal');
const loginForm = document.getElementById('login-form');
const mainContent = document.getElementById('main-content');
const startDetectionBtn = document.getElementById('start-detection');
const stopDetectionBtn = document.getElementById('stop-detection');
const systemStatus = document.getElementById('system-status');
const fullscreenBtn = document.getElementById('fullscreen-btn');
const videoFeed = document.getElementById('video-feed');

// State variables
let isAuthenticated = false;
let isDetectionRunning = false;
let updateInterval;
let lastUpdateTime = 0;
let connectionRetries = 0;
const maxRetries = 3;

// API Configuration
const API_BASE_URL = '';
const API_ENDPOINTS = {
    startDetection: '/api/start_detection',
    stopDetection: '/api/stop_detection',
    getStatus: '/api/detection_status',
    videoFeed: '/video_feed',
    systemInfo: '/api/system_info'
};

// Initialize the application
function init() {
    console.log('Initializing Crowd Management System...');
    checkAuthStatus();
    setupEventListeners();
    updateUI();
    
    // Load system info on startup
    if (isAuthenticated) {
        loadSystemInfo();
        checkInitialDetectionStatus();
    }
}

// Authentication functions
function checkAuthStatus() {
    const token = localStorage.getItem('authToken');
    isAuthenticated = !!token;
    console.log('Authentication status:', isAuthenticated);
}

function setupEventListeners() {
    // Authentication event listeners
    loginBtn.addEventListener('click', () => {
        loginModal.style.display = 'flex';
        document.getElementById('username').focus();
    });
    
    logoutBtn.addEventListener('click', logout);
    closeModal.addEventListener('click', () => loginModal.style.display = 'none');
    loginForm.addEventListener('submit', handleLogin);
    
    // Detection control event listeners
    startDetectionBtn.addEventListener('click', startDetection);
    stopDetectionBtn.addEventListener('click', stopDetection);
    
    // Video controls
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    videoFeed.addEventListener('click', toggleFullscreen);
    
    // Modal close on outside click
    window.addEventListener('click', (e) => {
        if (e.target === loginModal) {
            loginModal.style.display = 'none';
        }
    });
    
    // Fullscreen change listener
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', handleVisibilityChange);
}

function updateUI() {
    // Update authentication UI
    loginBtn.style.display = isAuthenticated ? 'none' : 'block';
    logoutBtn.style.display = isAuthenticated ? 'block' : 'none';
    mainContent.style.display = isAuthenticated ? 'block' : 'none';
    
    // Update system status
    systemStatus.textContent = isDetectionRunning ? 'Running' : 'Stopped';
    systemStatus.className = `status-badge ${isDetectionRunning ? 'running' : 'stopped'}`;
    
    // Update control buttons
    startDetectionBtn.disabled = isDetectionRunning;
    stopDetectionBtn.disabled = !isDetectionRunning;
    
    // Update button styles
    if (isDetectionRunning) {
        startDetectionBtn.classList.add('disabled');
        stopDetectionBtn.classList.remove('disabled');
    } else {
        startDetectionBtn.classList.remove('disabled');
        stopDetectionBtn.classList.add('disabled');
    }
}

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    // Simple authentication (replace with real authentication in production)
    if (username === 'admin' && password === 'admin123') {
        localStorage.setItem('authToken', `token-${Date.now()}`);
        isAuthenticated = true;
        loginModal.style.display = 'none';
        updateUI();
        
        // Load system information and check detection status
        await loadSystemInfo();
        await checkInitialDetectionStatus();
        
        console.log('Login successful');
    } else {
        alert('Invalid credentials. Please use admin/admin123');
        document.getElementById('password').value = '';
        document.getElementById('password').focus();
    }
}

function logout() {
    localStorage.removeItem('authToken');
    isAuthenticated = false;
    isDetectionRunning = false;
    stopRealTimeUpdates();
    resetUI();
    updateUI();
    console.log('Logged out successfully');
}

// Detection control functions
async function startDetection() {
    console.log('Starting detection...');
    startDetectionBtn.disabled = true;
    startDetectionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
    
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.startDetection}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Detection start response:', result);
        
        isDetectionRunning = true;
        
        // Start video feed
        const timestamp = Date.now();
        videoFeed.src = `${API_BASE_URL}${API_ENDPOINTS.videoFeed}?t=${timestamp}`;
        videoFeed.onerror = handleVideoError;
        
        updateUI();
        startRealTimeUpdates();
        connectionRetries = 0;
        
        console.log('Detection started successfully');
        
    } catch (error) {
        console.error('Failed to start detection:', error);
        alert('Failed to start detection. Please check if the backend server is running.');
    } finally {
        startDetectionBtn.disabled = false;
        startDetectionBtn.innerHTML = '<i class="fas fa-play"></i> Start Detection';
    }
}

async function stopDetection() {
    console.log('Stopping detection...');
    stopDetectionBtn.disabled = true;
    stopDetectionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
    
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.stopDetection}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Detection stop response:', result);
        
        isDetectionRunning = false;
        stopRealTimeUpdates();
        
        // Reset video feed to placeholder
        videoFeed.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjQ4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhbWVyYSBGZWVkIE9mZmxpbmU8L3RleHQ+Cjwvc3ZnPg==";
        
        // Reset all stats
        resetStats();
        updateUI();
        
        console.log('Detection stopped successfully');
        
    } catch (error) {
        console.error('Failed to stop detection:', error);
        alert('Failed to stop detection. Please check if the backend server is running.');
    } finally {
        stopDetectionBtn.disabled = false;
        stopDetectionBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Detection';
    }
}

// Data fetching functions
async function checkInitialDetectionStatus() {
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.getStatus}`);
        if (response.ok) {
            const data = await response.json();
            console.log('Initial detection status:', data);
            
            if (data.running) {
                isDetectionRunning = true;
                const timestamp = Date.now();
                videoFeed.src = `${API_BASE_URL}${API_ENDPOINTS.videoFeed}?t=${timestamp}`;
                startRealTimeUpdates();
            }
            
            updateDetectionStatus(data);
            updateUI();
        }
    } catch (error) {
        console.error('Error checking initial detection status:', error);
    }
}

async function fetchDetectionStatus() {
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.getStatus}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        updateDetectionStatus(data);
        connectionRetries = 0; // Reset retry counter on successful fetch
        
    } catch (error) {
        console.error('Error fetching detection status:', error);
        connectionRetries++;
        
        if (connectionRetries >= maxRetries) {
            console.warn('Max connection retries reached, stopping updates');
            stopRealTimeUpdates();
            // Show connection error in UI
            showConnectionError();
        }
    }
}

async function loadSystemInfo() {
    try {
        const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.systemInfo}`);
        if (response.ok) {
            const data = await response.json();
            updateSystemInfo(data);
        }
    } catch (error) {
        console.error('Error loading system info:', error);
    }
}

function updateDetectionStatus(data) {
    if (data.running !== undefined) {
        isDetectionRunning = data.running;
        updateUI();
    }

    if (data.stats) {
        const stats = data.stats;

        // Update main stats
        document.getElementById('people-count').textContent = stats.people_count || 0;
        document.getElementById('density').textContent = `${(stats.density || 0).toFixed(4)} ppl/m²`;

        // Update crowd level with confidence
        const crowdText = `${stats.crowd_level || 'Unknown'} (${Math.round((stats.crowd_confidence || 0) * 100)}%)`;
        document.getElementById('crowd-level').textContent = crowdText;

        // Update device status
        const deviceStatus = (stats.device_status || 'off').toUpperCase();
        document.getElementById('device-status').textContent = deviceStatus;

        // Update video stats
        document.getElementById('fps').textContent = (stats.fps || 0).toFixed(1);
        document.getElementById('processing-time').textContent = `${(stats.processing_time || 0).toFixed(2)} ms`;
        document.getElementById('frame-count').textContent = stats.frame_count || 0;

        // Update active tracks count
        const activeTracksCount = (stats.tracked_ids || []).length;
        document.getElementById('active-tracks').textContent = activeTracksCount;

        // Update tracking information
        updateTrackingTable(stats.tracking_info || []);
        updateTrackingSummary(stats.tracked_ids || [], stats.tracking_info || []);

        // Update device status indicator color
        updateDeviceStatusIndicator(deviceStatus);

        // ✅ NEW: Update device control UI (switches + sliders)
        if (stats.devices) {
            Object.entries(stats.devices).forEach(([deviceId, config]) => {
                const type = deviceId.split('-')[0]; // e.g., "fan-123" → "fan"
                const card = document.querySelector(`.device-card[data-device="${type}"]`);
                if (!card) return;

                // Power switch
                const switchEl = card.querySelector('.power-switch');
                const statusText = card.querySelector('.status-text');
                const statusIndicator = card.querySelector('.status-indicator');

                if (config.state) {
                    switchEl.classList.add('on');
                    statusText.textContent = 'Online';
                    statusIndicator.classList.add('active');
                } else {
                    switchEl.classList.remove('on');
                    statusText.textContent = 'Offline';
                    statusIndicator.classList.remove('active');
                }

                // Sliders (speed, brightness, volume, temperature)
                ['speed', 'brightness', 'volume', 'temperature'].forEach(control => {
                    if (config[control] !== undefined) {
                        const slider = card.querySelector(`input[data-control="${control}"]`);
                        const valueLabel = card.querySelector(`.slider-label[data-control="${control}"]`);
                        if (slider) slider.value = config[control];
                        if (valueLabel) valueLabel.textContent = `${config[control]}%`;
                    }
                });
            });
        }

        lastUpdateTime = Date.now();
    }
}


function updateTrackingTable(trackingInfo) {
    const tableBody = document.getElementById('tracking-data');
    
    if (!trackingInfo || trackingInfo.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="no-data">No active tracks</td></tr>';
        return;
    }
    
    tableBody.innerHTML = '';
    
    trackingInfo.forEach(track => {
        const row = document.createElement('tr');
        const statusClass = track.status.toLowerCase().replace(' ', '-');
        
        row.innerHTML = `
            <td class="track-id">${track.track_id}</td>
            <td class="track-position">${track.position}</td>
            <td class="track-confidence">${track.confidence}</td>
            <td class="track-status ${statusClass}">${track.status}</td>
        `;
        
        tableBody.appendChild(row);
    });
}

function updateTrackingSummary(trackedIds, trackingInfo) {
    const totalTracked = trackedIds.length;
    const activeTracks = trackingInfo.filter(track => track.status.toLowerCase() === 'confirmed').length;
    
    document.getElementById('total-tracked').textContent = totalTracked;
    document.getElementById('active-tracks-summary').textContent = activeTracks;
}

function updateSystemInfo(info) {
    if (info.device) {
        document.getElementById('processing-device').textContent = info.device;
    }
    if (info.yolo_model) {
        document.getElementById('yolo-model').textContent = info.yolo_model;
    }
    if (info.resnet_enabled !== undefined) {
        document.getElementById('resnet-enabled').textContent = info.resnet_enabled ? 'Yes' : 'No';
    }
    if (info.camera_fov) {
        document.getElementById('camera-fov').textContent = `${info.camera_fov} m²`;
    }
    if (info.density_threshold) {
        document.getElementById('density-threshold').textContent = `${info.density_threshold} ppl/m²`;
    }
}

function updateDeviceStatusIndicator(status) {
    const deviceStatusElement = document.getElementById('device-status');
    const deviceIcon = document.querySelector('.device-icon');
    
    if (status === 'ON') {
        deviceStatusElement.classList.add('status-on');
        deviceStatusElement.classList.remove('status-off');
        deviceIcon.style.backgroundColor = '#2ecc71';
    } else {
        deviceStatusElement.classList.add('status-off');
        deviceStatusElement.classList.remove('status-on');
        deviceIcon.style.backgroundColor = '#e74c3c';
    }
}

function resetStats() {
    document.getElementById('people-count').textContent = '0';
    document.getElementById('density').textContent = '0.00 ppl/m²';
    document.getElementById('crowd-level').textContent = 'Unknown (0%)';
    document.getElementById('device-status').textContent = 'OFF';
    document.getElementById('fps').textContent = '0.0';
    document.getElementById('processing-time').textContent = '0.00 ms';
    document.getElementById('frame-count').textContent = '0';
    document.getElementById('active-tracks').textContent = '0';
    document.getElementById('total-tracked').textContent = '0';
    document.getElementById('active-tracks-summary').textContent = '0';
    
    // Reset tracking table
    document.getElementById('tracking-data').innerHTML = '<tr><td colspan="4" class="no-data">No tracking data available</td></tr>';
    
    // Reset device status indicator
    updateDeviceStatusIndicator('OFF');
}

function resetUI() {
    resetStats();
    videoFeed.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjQ4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhbWVyYSBGZWVkIE9mZmxpbmU8L3RleHQ+Cjwvc3ZnPg==";
}

function showConnectionError() {
    // You could implement a more sophisticated error display here
    console.warn('Connection to backend lost');
}

// Real-time update functions
function startRealTimeUpdates() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    
    console.log('Starting real-time updates...');
    updateInterval = setInterval(() => {
        if (isDetectionRunning && isAuthenticated) {
            fetchDetectionStatus();
        }
    }, 1000); // Update every second
    
    // Initial fetch
    fetchDetectionStatus();
}

function stopRealTimeUpdates() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
        console.log('Stopped real-time updates');
    }
}

// Video control functions
function toggleFullscreen() {
    const videoWrapper = document.querySelector('.video-wrapper');
    
    if (!document.fullscreenElement) {
        videoWrapper.requestFullscreen().catch(err => {
            console.error('Error attempting to enable fullscreen:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

function handleFullscreenChange() {
    const icon = fullscreenBtn.querySelector('i');
    if (document.fullscreenElement) {
        icon.className = 'fas fa-compress';
        videoFeed.style.cursor = 'zoom-out';
    } else {
        icon.className = 'fas fa-expand';
        videoFeed.style.cursor = 'pointer';
    }
}

function handleVideoError() {
    console.error('Video feed error');
    if (isDetectionRunning) {
        // Try to reload the video feed
        setTimeout(() => {
            const timestamp = Date.now();
            videoFeed.src = `${API_BASE_URL}${API_ENDPOINTS.videoFeed}?t=${timestamp}`;
        }, 2000);
    }
}

// Page visibility handling
function handleVisibilityChange() {
    if (document.hidden) {
        // Page is hidden, reduce update frequency or pause updates
        if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = setInterval(() => {
                if (isDetectionRunning && isAuthenticated) {
                    fetchDetectionStatus();
                }
            }, 5000); // Update every 5 seconds when hidden
        }
    } else {
        // Page is visible, resume normal update frequency
        if (isDetectionRunning && isAuthenticated) {
            startRealTimeUpdates();
        }
    }
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', init);

// Handle page unload
window.addEventListener('beforeunload', () => {
    stopRealTimeUpdates();
});



---------------------------------------------------------------***********************************************************-----------------------------------------------------------------

index.html (newly updated without no issues) : 

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crowd Management System</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-users"></i> Crowd Management System</h1>
      <div class="auth-buttons">
        <button id="login-btn" class="btn btn-primary">Login</button>
        <button id="logout-btn" class="btn btn-danger">Logout</button>
      </div>
      <nav class="nav-links">
        <a href="/" class="nav-link active"><i class="fas fa-users"></i> Crowd Management</a>
        <a href="/device-control.html" class="nav-link"><i class="fas fa-lightbulb"></i> Device Control</a>
      </nav>
    </header>

    <div class="login-modal" id="login-modal">
      <div class="modal-content">
        <span class="close-modal">×</span>
        <h2>Login</h2>
        <form id="login-form">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" required />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required />
          </div>
          <button type="submit" class="btn btn-primary">Login</button>
        </form>
      </div>
    </div>

    <main class="main-content" id="main-content">
      <section class="control-panel">
        <h2><i class="fas fa-sliders-h"></i> Control Panel</h2>
        <div class="control-buttons">
          <button id="start-detection" class="btn btn-success">
            <i class="fas fa-play"></i> Start Detection
          </button>
          <button id="stop-detection" class="btn btn-danger">
            <i class="fas fa-stop"></i> Stop Detection
          </button>
        </div>
        <div class="system-status">
          <span class="status-label">System Status:</span>
          <span id="system-status" class="status-badge stopped">Stopped</span>
        </div>
      </section>

      <section class="dashboard">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon people-icon"><i class="fas fa-user-friends"></i></div>
            <div class="stat-info">
              <h3>People Count</h3>
              <p id="people-count">0</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon density-icon"><i class="fas fa-chart-area"></i></div>
            <div class="stat-info">
              <h3>Density</h3>
              <p id="density">0.00 ppl/m²</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon crowd-icon"><i class="fas fa-tachometer-alt"></i></div>
            <div class="stat-info">
              <h3>Crowd Level</h3>
              <p id="crowd-level">Unknown (0%)</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon device-icon"><i class="fas fa-lightbulb"></i></div>
            <div class="stat-info">
              <h3>Device Status</h3>
              <p id="device-status">OFF</p>
            </div>
          </div>
        </div>

        <div class="video-container">
          <h2><i class="fas fa-video"></i> Live Feed</h2>
          <div class="video-wrapper">
            <img id="video-feed" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjQ4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhbWVyYSBGZWVkIE9mZmxpbmU8L3RleHQ+Cjwvc3ZnPg==" alt="Live camera feed" />
            <button id="fullscreen-btn" class="fullscreen-btn">
              <i class="fas fa-expand"></i>
            </button>
          </div>
          <div class="video-stats">
            <div class="video-stat">
              <span>FPS:</span> 
              <span id="fps" class="stat-value">0.0</span>
            </div>
            <div class="video-stat">
              <span>Processing Time:</span> 
              <span id="processing-time" class="stat-value">0.00 ms</span>
            </div>
            <div class="video-stat">
              <span>Frame Count:</span> 
              <span id="frame-count" class="stat-value">0</span>
            </div>
            <div class="video-stat">
              <span>Active Tracks:</span> 
              <span id="active-tracks" class="stat-value">0</span>
            </div>
          </div>
        </div>

        <div class="tracking-info">
          <h2><i class="fas fa-id-card"></i> Tracking Information</h2>
          <div class="tracking-summary">
            <div class="summary-item">
              <span>Total Tracked IDs:</span>
              <span id="total-tracked" class="summary-value">0</span>
            </div>
            <div class="summary-item">
              <span>Active Tracks:</span>
              <span id="active-tracks-summary" class="summary-value">0</span>
            </div>
          </div>
          <div class="tracking-table-container">
            <table class="tracking-table">
              <thead>
                <tr>
                  <th>Track ID</th>
                  <th>Position</th>
                  <th>Confidence</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tracking-data">
                <tr>
                  <td colspan="4" class="no-data">No tracking data available</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="system-info">
          <h2><i class="fas fa-info-circle"></i> System Information</h2>
          <div class="system-details">
            <div class="detail-item">
              <span>Processing Device:</span>
              <span id="processing-device">Unknown</span>
            </div>
            <div class="detail-item">
              <span>YOLO Model:</span>
              <span id="yolo-model">yolov8n.pt</span>
            </div>
            <div class="detail-item">
              <span>ResNet Enabled:</span>
              <span id="resnet-enabled">Unknown</span>
            </div>
            <div class="detail-item">
              <span>Camera FOV:</span>
              <span id="camera-fov">100 m²</span>
            </div>
            <div class="detail-item">
              <span>Density Threshold:</span>
              <span id="density-threshold">0.05 ppl/m²</span>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <p>Made with 🔥 by Yesvin Veluchamy for Summer Intern © 2025</p>
    </footer>
  </div>

  <script src="scripts.js"></script>
</body>
</html>



--------------------------------seg12.py-------------------------------
seg12.py code recent :

import os
import cv2
import time
import csv
import torch
import numpy as np
from PIL import Image
from datetime import datetime
from torchvision import transforms, models
from ultralytics import YOLO
from torch import nn
from gpio_controller import turn_on_device, turn_off_device, cleanup_gpio
from deep_sort_realtime.deepsort_tracker import DeepSort
import logging
from flask import Flask, jsonify, Response, render_template, request, session, send_from_directory
from flask_cors import CORS
import threading
import json

app = Flask(__name__)
CORS(app)  # Enable CORS for frontend communication

# Serve frontend HTML files
@app.route('/')
def serve_index():
    return send_from_directory('../frontend', 'index.html')

@app.route('/device-control.html')
def serve_device_control():
    return send_from_directory('../frontend', 'device-control.html')

# Serve static assets (JS, CSS)
@app.route('/<path:filename>')
def serve_static_file(filename):
    return send_from_directory('../frontend', filename)

# Global variables for system state
current_stats = {
    'people_count': 0,
    'density': 0.0,
    'device_status': 'off',
    'crowd_level': 'unknown',
    'crowd_confidence': 0.0,
    'tracked_ids': [],
    'tracking_info': [],
    'processing_time': 0,
    'fps': 0,
    'frame_count': 0
}

detection_running = False
frame_buffer = None
cap = None

# In-memory storage for devices (you can replace with database)
devices = {
    'fan': {'name': 'Ceiling Fan', 'room': 'Living Room', 'speed': 0, 'state': False},
    'light': {'name': 'Smart Light', 'room': 'Living Room', 'brightness': 0, 'state': False},
    'tv': {'name': 'Smart TV', 'room': 'Living Room', 'volume': 0, 'state': False}
}

# Device control history
device_history = []

# Configuration constants
CAMERA_ID = 0
CAMERA_FOV_M2 = 100  # Camera field of view in square meters
DENSITY_THRESHOLD = 0.05
CSV_FILE = "density_log.csv"
DATASET_DIR = "dataset"
OUTPUT_DIR = "output_results"
YOLO_MODEL_PATH = "yolov8n.pt"
RESNET_MODEL_PATH = "model/resnet50_density_model.pth"
MIN_CONFIDENCE = 0.3
FRAME_SKIP = 2
FORCE_GPU = True
BATCH_SIZE = 4
USE_RESNET = True

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Create necessary directories
os.makedirs(DATASET_DIR, exist_ok=True)
os.makedirs(OUTPUT_DIR, exist_ok=True)
os.makedirs('model', exist_ok=True)

# Initialize CSV file
if not os.path.exists(CSV_FILE):
    with open(CSV_FILE, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(["Timestamp", "Camera ID", "People Count", "Density", "Device Status", 
                         "Crowd Density", "Tracked IDs", "Processing Time (ms)"])

def check_mps_availability():
    """Check if Apple Silicon GPU is available"""
    if torch.backends.mps.is_available():
        logger.info("MPS is available. Using Apple Silicon GPU!")
        return torch.device("mps")
    else:
        logger.info("MPS not available. Falling back to CPU.")
        return torch.device("cpu")

# Setup torch device
torch_device = check_mps_availability()
logger.info(f"Using device: {torch_device}")

# Load YOLO model
yolo_model = YOLO(YOLO_MODEL_PATH)
if torch_device.type == 'mps':
    yolo_model.to(torch_device)
    logger.info("YOLO model moved to GPU")

class DensityResNet(nn.Module):
    def __init__(self):
        super().__init__()
        self.base_model = models.resnet50(weights='IMAGENET1K_V2')
        self.base_model.fc = nn.Identity()
        self.base_model.avgpool = nn.Identity()
        self.density_head = nn.Sequential(
            nn.Conv2d(2048, 1024, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.Conv2d(1024, 512, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.Conv2d(512, 256, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.Conv2d(256, 1, kernel_size=1),
            nn.ReLU()
        )
    def forward(self, x):
        x = self.base_model.conv1(x)
        x = self.base_model.bn1(x)
        x = self.base_model.relu(x)
        x = self.base_model.maxpool(x)
        x = self.base_model.layer1(x)
        x = self.base_model.layer2(x)
        x = self.base_model.layer3(x)
        x = self.base_model.layer4(x)
        x = self.density_head(x)
        x = nn.functional.interpolate(x, size=(224, 224), mode='bilinear', align_corners=False)
        return x

class CrowdDensityClassifier(nn.Module):
    def __init__(self, density_model):
        super().__init__()
        self.density_model = density_model
        for param in self.density_model.parameters():
            param.requires_grad = False
        self.classifier = nn.Sequential(
            nn.AdaptiveAvgPool2d((1, 1)),
            nn.Flatten(),
            nn.Linear(1, 64),
            nn.ReLU(),
            nn.Dropout(0.3),
            nn.Linear(64, 32),
            nn.ReLU(),
            nn.Dropout(0.2),
            nn.Linear(32, 4),
            nn.Softmax(dim=1)
        )
    def forward(self, x):
        density_map = self.density_model(x)
        crowd_level = self.classifier(density_map)
        return density_map, crowd_level

def load_trained_model(model_path, device):
    """Load trained ResNet model"""
    try:
        model = DensityResNet()
        checkpoint = torch.load(model_path, map_location=device)
        if 'model_state_dict' in checkpoint:
            state_dict = checkpoint['model_state_dict']
            logger.info("Loaded checkpoint format")
        else:
            state_dict = checkpoint
            logger.info("Loaded direct state dict format")
        model.load_state_dict(state_dict)
        model.to(device)
        model.eval()
        logger.info("DensityResNet model loaded successfully")
        classifier_model = CrowdDensityClassifier(model)
        classifier_model.to(device)
        classifier_model.eval()
        return model, classifier_model
    except Exception as e:
        logger.error(f"Error loading model: {e}")
        return None, None

# Load ResNet model
resnet_model = None
crowd_classifier = None

if USE_RESNET:
    try:
        logger.info("Loading trained DensityResNet model...")
        resnet_model, crowd_classifier = load_trained_model(RESNET_MODEL_PATH, torch_device)
        if resnet_model is None:
            logger.warning("Could not load ResNet model, continuing without it")
            USE_RESNET = False
        else:
            logger.info("ResNet density model loaded successfully")
    except FileNotFoundError:
        logger.warning("ResNet model not found, continuing without it")
        USE_RESNET = False
    except Exception as e:
        logger.warning(f"Error loading ResNet model: {e}, continuing without it")
        USE_RESNET = False

# Setup transforms
resnet_transform = transforms.Compose([
    transforms.ToPILImage(),
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
])

# Initialize DeepSORT tracker
tracker = DeepSort(
    max_age=50,
    n_init=3,
    max_cosine_distance=0.4,
    nn_budget=None,
    embedder="mobilenet",
    half=True,
    bgr=True,
    embedder_gpu=torch_device.type == 'mps',
    embedder_wts=None,
    polygon=False,
    today=None
)

def calculate_iou(box1, box2):
    """Calculate IoU between two bounding boxes"""
    x1 = max(box1[0], box2[0])
    y1 = max(box1[1], box2[1])
    x2 = min(box1[2], box2[2])
    y2 = min(box1[3], box2[3])
    
    inter_area = max(0, x2 - x1) * max(0, y2 - y1)
    box1_area = (box1[2] - box1[0]) * (box1[3] - box1[1])
    box2_area = (box2[2] - box2[0]) * (box2[3] - box2[1])
    
    return inter_area / float(box1_area + box2_area - inter_area)

def analyze_crowd_density(frame, model, classifier, transform, device):
    """Analyze crowd density using ResNet"""
    if model is None or classifier is None:
        return 0.0, "Unknown", 0.0
    
    try:
        frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        input_tensor = transform(frame_rgb).unsqueeze(0).to(device)
        
        with torch.no_grad():
            density_map, crowd_level = classifier(input_tensor)
            
            total_count = torch.sum(density_map).item()
            
            crowd_probs = crowd_level[0]
            crowd_class = torch.argmax(crowd_probs).item()
            crowd_confidence = torch.max(crowd_probs).item()
            
            crowd_labels = ["Low", "Medium", "High", "Very High"]
            crowd_label = crowd_labels[crowd_class]
            
            return total_count, crowd_label, crowd_confidence
            
    except Exception as e:
        logger.warning(f"Error in crowd analysis: {e}")
        return 0.0, "Error", 0.0

def process_frame():
    """Main frame processing function"""
    global current_stats, frame_buffer, cap
    
    if not detection_running or cap is None:
        return
    
    start_time = time.time()
    ret, frame = cap.read()
    
    if not ret:
        logger.warning("Failed to read frame from camera")
        return
    
    try:
        # YOLO detection for people
        results = yolo_model(frame, verbose=False, conf=MIN_CONFIDENCE)
        people_boxes = []
        
        for r in results:
            for box in r.boxes:
                cls = int(box.cls[0])
                conf = float(box.conf[0])
                if yolo_model.names[cls] == "person":
                    x1, y1, x2, y2 = map(int, box.xyxy[0])
                    
                    # Validate bounding box
                    if x2 <= x1 or y2 <= y1 or x1 < 0 or y1 < 0 or x2 >= frame.shape[1] or y2 >= frame.shape[0]:
                        continue
                    
                    people_boxes.append((x1, y1, x2, y2, conf))
        
        # Format detections for DeepSORT
        formatted_detections = []
        for x1, y1, x2, y2, conf in people_boxes:
            formatted_detections.append(([x1, y1, x2, y2], conf, 0))
        
        # Update tracker
        tracks = tracker.update_tracks(formatted_detections, frame=frame)
        
        # Process tracked objects
        tracked_people = []
        active_track_ids = []
        tracking_info = []
        
        for track in tracks:
            if not track.is_confirmed():
                continue
            
            track_id = track.track_id
            ltrb = track.to_ltrb()
            x1, y1, x2, y2 = map(int, ltrb)
            active_track_ids.append(track_id)
            
            # Find best matching detection
            best_match = None
            best_iou = 0
            for det in people_boxes:
                det_box = det[:4]
                iou = calculate_iou(ltrb, det_box)
                if iou > best_iou:
                    best_iou = iou
                    best_match = det
            
            if best_match and best_iou > 0.3:
                conf = best_match[4]
            else:
                conf = 0.7
            
            tracked_people.append((x1, y1, x2, y2, track_id, conf))
            
            # Add to tracking info for frontend
            tracking_info.append({
                'track_id': track_id,
                'position': f"({x1},{y1})",
                'confidence': round(conf, 2),
                'status': 'Confirmed'
            })
        
        # Calculate density and device status
        people_count = len(tracked_people)
        density = people_count / CAMERA_FOV_M2
        device_status = "on" if people_count > 0 else "off"

        # Control GPIO devices
        try:
            if device_status == "on":
                turn_on_device()
        # Control all devices based on their type
                for device_id, device in devices.items():
                    device_type = device.get('type', device_id.split('-')[0])  # Get type from config or ID
            
                    if device_type == 'fan' or device_id == 'fan':
                        speed = min(100, max(30, int(density * 200)))
                        devices[device_id]['state'] = True
                        devices[device_id]['speed'] = speed
                    elif device_type == 'light' or device_id == 'light':
                        brightness = min(100, max(40, int(density * 250)))
                        devices[device_id]['state'] = True
                        devices[device_id]['brightness'] = brightness
                    elif device_type == 'tv' or device_id == 'tv':
                        volume = min(100, max(10, int(density * 150)))
                        devices[device_id]['state'] = True
                        devices[device_id]['volume'] = volume
                    elif device_type == 'ac':
                        temperature = min(30, max(18, int(20 + density * 50)))
                        devices[device_id]['state'] = True
                        devices[device_id]['temperature'] = temperature
            else:
                turn_off_device()
                # Turn off all devices
                for device_id, device in devices.items():
                    devices[device_id]['state'] = False
                    if 'speed' in devices[device_id]:
                        devices[device_id]['speed'] = 0
                    if 'brightness' in devices[device_id]:
                        devices[device_id]['brightness'] = 0
                    if 'volume' in devices[device_id]:
                        devices[device_id]['volume'] = 0
                    if 'temperature' in devices[device_id]:
                        devices[device_id]['temperature'] = 20
        except Exception as e:
            logger.warning(f"GPIO control error: {e}")
        
        # Analyze crowd density with ResNet
        crowd_level = "Unknown"
        crowd_confidence = 0.0
        if USE_RESNET and resnet_model is not None:
            _, crowd_level, crowd_confidence = analyze_crowd_density(
                frame, resnet_model, crowd_classifier, resnet_transform, torch_device
            )
        
        # Calculate processing time and FPS
        processing_time = (time.time() - start_time) * 1000
        fps = 1000 / processing_time if processing_time > 0 else 0
        
        # Update global stats
        current_stats.update({
            'people_count': people_count,
            'density': round(density, 4),
            'device_status': device_status,
            'crowd_level': crowd_level,
            'crowd_confidence': round(crowd_confidence, 2),
            'tracked_ids': active_track_ids,
            'tracking_info': tracking_info,
            'processing_time': round(processing_time, 2),
            'fps': round(fps, 1),
            'frame_count': current_stats['frame_count'] + 1
        })
        
        # Draw tracking results on frame
        for x1, y1, x2, y2, track_id, conf in tracked_people:
            # Draw bounding box
            cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
            
            # Draw track ID and confidence
            label = f"ID:{track_id} ({conf:.2f})"
            cv2.putText(frame, label, (x1, y1 - 5), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 2)
        
        # Draw system info on frame
        cv2.putText(frame, f"People: {people_count}", (10, 30), 
                   cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 0), 2)
        cv2.putText(frame, f"Density: {density:.4f} ppl/m² | Device: {device_status.upper()}", 
                   (10, 60), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 255, 0), 2)
        cv2.putText(frame, f"Crowd: {crowd_level} ({crowd_confidence:.2f})", 
                   (10, 90), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 0, 255), 2)
        cv2.putText(frame, f"FPS: {fps:.1f} | Tracks: {len(active_track_ids)}", 
                   (10, 120), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 255), 2)
        
        # Update frame buffer
        frame_buffer = frame.copy()
        
        # Log to CSV
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        tracked_ids_str = ",".join(map(str, active_track_ids)) if active_track_ids else "None"
        
        with open(CSV_FILE, mode='a', newline='') as file:
            writer = csv.writer(file)
            writer.writerow([
                timestamp,
                f"Camera {CAMERA_ID}",
                people_count,
                f"{density:.4f}",
                device_status.upper(),
                f"{crowd_level} ({crowd_confidence:.2f})",
                tracked_ids_str,
                f"{processing_time:.2f}"
            ])
        
    except Exception as e:
        logger.error(f"Error processing frame: {e}")

def detection_loop():
    """Main detection loop running in separate thread"""
    global detection_running, cap
    
    logger.info("Starting detection loop")
    
    while detection_running:
        try:
            process_frame()
            time.sleep(0.033)  # ~30 FPS
        except Exception as e:
            logger.error(f"Error in detection loop: {e}")
            time.sleep(1)
    
    logger.info("Detection loop stopped")

def generate_frames():
    """Generate frames for video streaming"""
    global frame_buffer
    
    while True:
        if frame_buffer is not None and detection_running:
            try:
                # Encode frame as JPEG
                _, buffer = cv2.imencode('.jpg', frame_buffer, [cv2.IMWRITE_JPEG_QUALITY, 85])
                frame_bytes = buffer.tobytes()
                
                yield (b'--frame\r\n'
                       b'Content-Type: image/jpeg\r\n\r\n' + frame_bytes + b'\r\n')
            except Exception as e:
                logger.error(f"Error generating frame: {e}")
        else:
            # Send placeholder image when detection is not running
            placeholder = np.zeros((480, 640, 3), dtype=np.uint8)
            cv2.putText(placeholder, "Camera Feed Stopped", (200, 240), 
                       cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 255), 2)
            
            _, buffer = cv2.imencode('.jpg', placeholder)
            frame_bytes = buffer.tobytes()
            
            yield (b'--frame\r\n'
                   b'Content-Type: image/jpeg\r\n\r\n' + frame_bytes + b'\r\n')
        
        time.sleep(0.033)  # ~30 FPS

@app.route('/api/detection_status')
def detection_status():
    """Get current detection status and stats with device integration"""
    # Calculate overall device status
    any_device_on = any(d.get('state') for d in devices.values()) 
    return jsonify({
        'running': detection_running,
        'stats': {
            **current_stats,
            'devices': devices,
            'device_status': 'on' if any_device_on else current_stats.get('device_status', 'off'),
            'total_devices': len(devices),
            'active_devices': sum(1 for d in devices.values() if d.get('state'))
        }
    })


@app.route('/api/start_detection', methods=['POST'])
def start_detection():
    """Start detection process"""
    global detection_running, cap
    
    try:
        if not detection_running:
            # Initialize camera
            cap = cv2.VideoCapture(CAMERA_ID)
            if not cap.isOpened():
                return jsonify({'error': 'Cannot access camera'}), 500
            
            # Set camera properties
            cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
            cap.set(cv2.CAP_PROP_FPS, 30)
            cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
            cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
            
            detection_running = True
            
            # Start detection thread
            detection_thread = threading.Thread(target=detection_loop, daemon=True)
            detection_thread.start()
            
            logger.info("Detection started successfully")
            return jsonify({'status': 'Detection started'})
        else:
            return jsonify({'status': 'Detection already running'})
            
    except Exception as e:
        logger.error(f"Error starting detection: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/stop_detection', methods=['POST'])
def stop_detection():
    """Stop detection process"""
    global detection_running, cap, frame_buffer
    
    try:
        if detection_running:
            detection_running = False
            
            # Release camera
            if cap is not None:
                cap.release()
                cap = None
            
            # Clear frame buffer
            frame_buffer = None
            
            # Reset stats
            current_stats.update({
                'people_count': 0,
                'density': 0.0,
                'device_status': 'off',
                'crowd_level': 'unknown',
                'crowd_confidence': 0.0,
                'tracked_ids': [],
                'tracking_info': [],
                'processing_time': 0,
                'fps': 0
            })
            
            # Turn off devices
            try:
                turn_off_device()
            except:
                pass
            
            logger.info("Detection stopped successfully")
            return jsonify({'status': 'Detection stopped'})
        else:
            return jsonify({'status': 'Detection not running'})
            
    except Exception as e:
        logger.error(f"Error stopping detection: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/video_feed')
def video_feed():
    """Video streaming route"""
    return Response(generate_frames(), 
                   mimetype='multipart/x-mixed-replace; boundary=frame')

@app.route('/api/system_info')
def system_info():
    """Get system information"""
    return jsonify({
        'device': str(devices),
        'yolo_model': YOLO_MODEL_PATH,
        'resnet_enabled': USE_RESNET,
        'camera_id': CAMERA_ID,
        'camera_fov': CAMERA_FOV_M2,
        'density_threshold': DENSITY_THRESHOLD
    })

# Device Control API Routes (Added from pasted code)
@app.route('/device-control')
def device_control():
    """Render the device control page"""
    return render_template('device-control.html')

@app.route('/api/devices', methods=['GET'])
def get_devices():
    """Get all devices and their current states"""
    try:
        return jsonify({
            'status': 'success',
            'devices': devices,
            'timestamp': datetime.now().isoformat()
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500
    

@app.route('/api/device/toggle', methods=['POST'])
def toggle_device():
    """Toggle device on/off state"""
    try:
        data = request.get_json()
        device_id = data.get('device')
        new_state = data.get('state')

        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404
        
        # Update device state
        devices[device_id]['state'] = new_state
        devices[device_id]['last_updated'] = datetime.now().isoformat()

        # If turning off, reset control values
        if not new_state:
            if 'speed' in devices[device_id]:
                devices[device_id]['speed'] = 0
            if 'brightness' in devices[device_id]:
                devices[device_id]['brightness'] = 0
            if 'volume' in devices[device_id]:
                devices[device_id]['volume'] = 0
            if 'temperature' in devices[device_id]:
                devices[device_id]['temperature'] = 0

        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'toggle',
            'state': new_state,
            'timestamp': datetime.now().isoformat(),
            'device_name': devices[device_id]['name']
        })
        
        return jsonify({
            'status': 'success',
            'device': device_id,
            'new_state': new_state,
            'message': f"Device {devices[device_id]['name']} turned {'on' if new_state else 'off'}",
            'timestamp': devices[device_id]['last_updated']
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/control', methods=['POST'])
def control_device():
    """Update device control settings (brightness, speed, volume, etc.)"""
    try:
        data = request.get_json()
        device_id = data.get('device')
        control_type = data.get('control')
        value = data.get('value')
        
        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404
        
        # Validate control type and update device
        valid_controls = {
            'speed': ['fan'],
            'brightness': ['light'],
            'volume': ['tv'],
            'temperature': ['ac']
        }
        
        # Extract base device type from device_id (handles dynamic IDs like 'fan-123456')
        base_device_type = device_id.split('-')[0]
        valid_controls = {
            'speed': ['fan'],
            'brightness': ['light'],
            'volume': ['tv'],
            'temperature': ['ac']
        }

        if control_type not in valid_controls or base_device_type not in valid_controls[control_type]:
            return jsonify({
                'status': 'error',
                'message': f"Invalid control type '{control_type}' for device type '{base_device_type}'"
            }), 400

        # Validate value
        if not isinstance(value, (int, float)):
            return jsonify({
                'status': 'error',
                'message': f"Invalid value type for control '{control_type}'. Expected int or float."
            }), 400

        # Update the control value
        devices[device_id][control_type] = value
        devices[device_id]['last_updated'] = datetime.now().isoformat()

        # Auto-turn on device if control value > 0
        if value > 0:
            devices[device_id]['state'] = True

        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'control_update',
            'control_type': control_type,
            'value': value,
            'timestamp': datetime.now().isoformat(),
            'device_name': devices[device_id]['name']
        })
        
        return jsonify({
            'status': 'success',
            'device': device_id,
            'control': control_type,
            'value': value,
            'message': f"{devices[device_id]['name']} {control_type} set to {value}%",
            'timestamp': devices[device_id]['last_updated']
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/add', methods=['POST'])
def add_device():
    """Add a new device to the system"""
    try:
        data = request.get_json()
        device_type = data.get('type')
        device_name = data.get('name')
        device_room = data.get('room')
        
        if not all([device_type, device_name, device_room]):
            return jsonify({
                'status': 'error',
                'message': 'Missing required fields: type, name, room'
            }), 400
        
        # Generate unique device ID
        import time
        device_id = f"{device_type}-{int(time.time())}"
        
        # Create device configuration based on type
        device_config = {
            'name': device_name,
            'state': False,
            'room': device_room,
            'type': device_type,
            'last_updated': datetime.now().isoformat(),
            'created_at': datetime.now().isoformat()
        }
        
        # Add type-specific controls
        if device_type == 'fan':
            device_config['speed'] = 1
        elif device_type == 'light':
            device_config['brightness'] = 0
        elif device_type == 'tv':
            device_config['volume'] = 0
        elif device_type == 'ac':
            device_config['temperature'] = 20  # Default temperature
        
        # Add device to storage
        devices[device_id] = device_config
        
        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'device_added',
            'device_type': device_type,
            'device_name': device_name,
            'room': device_room,
            'timestamp': datetime.now().isoformat()
        })
        
        return jsonify({
            'status': 'success',
            'device_id': device_id,
            'device': device_config,
            'message': f"Device '{device_name}' added successfully"
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/remove/<device_id>', methods=['DELETE'])
def remove_device(device_id):
    """Remove a device from the system"""
    try:
        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404

        device_name = devices[device_id]['name']
        del devices[device_id]

        # Log the action
        device_history.append({
            'device_id': device_id,
            'action': 'device_removed',
            'device_name': device_name,
            'timestamp': datetime.now().isoformat()
        })
        
        return jsonify({
            'status': 'success',
            'message': f"Device '{device_name}' removed successfully"
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/history', methods=['GET'])
def get_device_history():
    """Get device control history"""
    try:
        # Get last N entries (default 50)
        limit = request.args.get('limit', 50, type=int)
        
        return jsonify({
            'status': 'success',
            'history': device_history[-limit:],
            'total_entries': len(device_history)
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/device/stats', methods=['GET'])
def get_device_stats():
    """Get device statistics"""
    try:
        stats = {
            'total_devices': len(devices),
            'active_devices': sum(1 for d in devices.values() if d.get('state')),
            'inactive_devices': sum(1 for d in devices.values() if not d.get('state')),
            'devices_by_room': {},
            'devices_by_type': {}
        }
        
        # Count devices by room and type
        for d in devices.values():
            room = d.get('room', 'Unknown')
            device_type = d.get('type', 'Unknown')

            stats['devices_by_room'][room] = stats['devices_by_room'].get(room, 0) + 1
            stats['devices_by_type'][device_type] = stats['devices_by_type'].get(device_type, 0) + 1
        
        return jsonify({
            'status': 'success',
            'stats': stats,
            'timestamp': datetime.now().isoformat()
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/api/density')
def get_density():
    """Get current density from live detection stats"""
    return jsonify({
        "density": current_stats.get('density', 0),
        "people_count": current_stats.get('people_count', 0),
        "device_status": current_stats.get('device_status', 'off'),
        "timestamp": datetime.now().isoformat()
    })

@app.route('/api/device/status/<device_id>', methods=['GET'])
def get_device_status(device_id):
    """Get specific device status"""
    try:
        if device_id not in devices:
            return jsonify({
                'status': 'error',
                'message': 'Device not found'
            }), 404
        
        return jsonify({
            'status': 'success',
            'device_id': device_id,
            'device': devices[device_id]
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

# Error handlers
@app.errorhandler(404)
def not_found_error(error):
    return jsonify({
        'status': 'error',
        'message': 'Endpoint not found'
    }), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({
        'status': 'error',
        'message': 'Internal server error'
    }), 500

if __name__ == '__main__':
    try:
        logger.info("Starting Crowd Management System Backend")
        logger.info(f"Using devices: {devices}")
        logger.info(f"ResNet enabled: {USE_RESNET}")
        logger.info("Starting Flask server on http://0.0.0.0:5000")
        
        app.run(host='0.0.0.0', port=5000, debug=False, threaded=True)
        
    except KeyboardInterrupt:
        logger.info("Shutting down...")
    finally:
        # Cleanup
        detection_running = False
        if cap is not None:
            cap.release()
        cleanup_gpio()
        cv2.destroyAllWindows()
        logger.info("Cleanup completed")




--------------------------------device-control.html-----------------------------------------------
device-control.html (with recent update):

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Device Control System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2rem;
            font-weight: 600;
        }

        .header h1 i {
            color: #667eea;
            margin-right: 10px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            text-decoration: none;
            color: #4a5568;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            gap: 30px;
        }

        .section-title {
            color: white;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .device-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .device-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #4a5568;
        }

        .device-icon {
            font-size: 1.8rem;
            padding: 10px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .power-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .power-switch.on {
            background: #48bb78;
        }

        .power-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .power-switch.on::after {
            transform: translateX(30px);
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e53e3e;
        }

        .status-indicator.active {
            background: #48bb78;
        }

        .controls-section {
            margin-top: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .slider-container {
            position: relative;
            margin-bottom: 10px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #718096;
        }

        .current-value {
            font-weight: 600;
            color: #667eea;
        }

        .add-device-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
        }

        .add-device-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .add-device-card i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .add-device-card h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #4a5568;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #4a5568;
        }

        .device-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .device-type {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .device-type:hover,
        .device-type.selected {
            border-color: #667eea;
            background: #f7fafc;
        }

        .device-type i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 40px;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .devices-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-home"></i> Smart Device Control</h1>
            <nav class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-users"></i> Crowd Management</a>
                <a href="/device-control.html" class="nav-link active"><i class="fas fa-home"></i> Device Control</a>
            </nav>
            <div class="auth-buttons">
                <button id="login-btn" class="btn btn-primary">Login</button>
                <button id="logout-btn" class="btn btn-danger" style="display: none;">Logout</button>
            </div>
        </header>

        <main class="main-content">
            <h2 class="section-title">
                <i class="fas fa-microchip"></i>
                Connected Devices
            </h2>

            <div class="devices-grid" id="devices-grid">
                <!-- Fan Device -->
                <div class="device-card" data-device="fan">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-fan"></i>
                            </div>
                            <span>Ceiling Fan</span>
                        </div>
                        <div class="power-switch" data-device="fan"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Speed Control</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="speed">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Light Device -->
                <div class="device-card" data-device="light">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <span>Smart Light</span>
                        </div>
                        <div class="power-switch" data-device="light"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Brightness</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="brightness">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TV Device -->
                <div class="device-card" data-device="tv">
                    <div class="device-header">
                        <div class="device-title">
                            <div class="device-icon">
                                <i class="fas fa-tv"></i>
                            </div>
                            <span>Smart TV</span>
                        </div>
                        <div class="power-switch" data-device="tv"></div>
                    </div>
                    <div class="device-status">
                        <div class="status-indicator"></div>
                        <span class="status-text">Offline</span>
                    </div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label class="control-label">Volume</label>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" data-control="volume">
                                <div class="slider-value">
                                    <span>0%</span>
                                    <span class="current-value">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Device Card -->
                <div class="device-card add-device-card" id="add-device-btn">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Add New Device</h3>
                    <p>Connect a new smart device</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Made with 💡 by Yesvin Veluchamy for Summer Internship &copy; 2025</p>
        </footer>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Device</h2>
                <span class="close">&times;</span>
            </div>
            
            <div class="device-types">
                <div class="device-type" data-type="fan">
                    <i class="fas fa-fan"></i>
                    <div>Fan</div>
                </div>
                <div class="device-type" data-type="light">
                    <i class="fas fa-lightbulb"></i>
                    <div>Light</div>
                </div>
                <div class="device-type" data-type="tv">
                    <i class="fas fa-tv"></i>
                    <div>TV</div>
                </div>
                <div class="device-type" data-type="ac">
                    <i class="fas fa-snowflake"></i>
                    <div>AC</div>
                </div>
            </div>

            <form id="deviceForm">
                <div class="form-group">
                    <label for="deviceName">Device Name</label>
                    <input type="text" id="deviceName" name="deviceName" placeholder="Enter device name" required>
                </div>
                
                <div class="form-group">
                    <label for="deviceRoom">Room</label>
                    <select id="deviceRoom" name="deviceRoom" required>
                        <option value="">Select Room</option>
                        <option value="living-room">Living Room</option>
                        <option value="bedroom">Bedroom</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="bathroom">Bathroom</option>
                        <option value="office">Office</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Device</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables for device management
        let devices = {};
        let selectedDeviceType = '';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadDevices();
            setInterval(loadDevices, 2000); // Poll backend every 2 seconds for real-time sync
        });

        function initializeEventListeners() {
            // Power switch toggles
            document.querySelectorAll('.power-switch').forEach(switchEl => {
                switchEl.addEventListener('click', function() {
                    const deviceId = this.closest('.device-card').getAttribute('data-device');
                    sendDeviceState(deviceId, !this.classList.contains('on'));
                });
            });

            // Slider controls
            document.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('change', function() {
                    const value = this.value;
                    const deviceCard = this.closest('.device-card');
                    const deviceId = deviceCard.getAttribute('data-device');
                    const controlType = this.getAttribute('data-control');
                    sendControlUpdate(deviceId, controlType, value);
                });
            });

            // Add device modal
            const modal = document.getElementById('addDeviceModal');
            const addBtn = document.getElementById('add-device-btn');
            const closeBtn = document.querySelector('.close');

            addBtn.addEventListener('click', () => {
                modal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                resetModal();
            });

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    resetModal();
                }
            });

            // Device type selection
            document.querySelectorAll('.device-type').forEach(type => {
                type.addEventListener('click', function() {
                    document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDeviceType = this.getAttribute('data-type');
                });
            });

            // Form submission
            document.getElementById('deviceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewDevice();
            });

            // Auth buttons
            document.getElementById('login-btn').addEventListener('click', () => {
                // Simulate login - in real implementation, this would redirect to login page
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'block';
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'none';
            });
        }

        function sendDeviceState(deviceId, isOn) {
            fetch('/api/device/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, state: isOn })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device state updated:', data);
            })
            .catch(error => {
                console.error('Error updating device state:', error);
            });
        }

        function sendControlUpdate(deviceId, controlType, value) {
            fetch('/api/device/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: deviceId, control: controlType, value: parseInt(value) })
            })
            .then(response => response.json())
            .then(data => {
                // No UI update here! UI will update on next poll from backend.
                console.log('Device control updated:', data);
            })
            .catch(error => {
                console.error('Error updating device control:', error);
            });
        }

        function addNewDevice() {
            if (!selectedDeviceType) {
                alert('Please select a device type');
                return;
            }
            const deviceName = document.getElementById('deviceName').value;
            const deviceRoom = document.getElementById('deviceRoom').value;
            if (!deviceName || !deviceRoom) {
                alert('Please fill in all fields');
                return;
            }
            fetch('/api/device/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: selectedDeviceType, name: deviceName, room: deviceRoom })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('addDeviceModal').style.display = 'none';
                resetModal();
                // UI will update on next poll from backend
            })
            .catch(error => {
                console.error('Error adding new device:', error);
            });
        }

        function resetModal() {
            document.getElementById('deviceForm').reset();
            document.querySelectorAll('.device-type').forEach(t => t.classList.remove('selected'));
            selectedDeviceType = '';
        }

        function loadDevices() {
            fetch('/api/devices')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateDevicesUI(data.devices);
                }
            })
            .catch(error => {
                console.error('Error loading devices:', error);
            });
        }

        // Replace the updateDevicesUI function with this updated version
function updateDevicesUI(devices) {
    const devicesGrid = document.getElementById('devices-grid');
    
    // Update existing device cards and create new ones
    for (const [deviceId, deviceInfo] of Object.entries(devices)) {
        let existingCard = devicesGrid.querySelector(`[data-device="${deviceId}"]`);
        
        if (existingCard && !existingCard.classList.contains('add-device-card')) {
            // Update existing card
            updateSingleDeviceUI(existingCard, deviceInfo);
        } else if (!existingCard) {
            // Create new card for devices not already present
            createDeviceCard(deviceId, deviceInfo);
        }
    }
    
    // Remove cards for devices that no longer exist in backend
    devicesGrid.querySelectorAll('.device-card:not(.add-device-card)').forEach(card => {
        const deviceId = card.getAttribute('data-device');
        if (!devices[deviceId]) {
            card.remove();
        }
    });
}

// Replace the createDeviceCard function with this updated version
function createDeviceCard(deviceId, deviceInfo) {
    const devicesGrid = document.getElementById('devices-grid');
    
    // Don't duplicate cards
    if (devicesGrid.querySelector(`[data-device="${deviceId}"]`)) return;

    // Card container
    const card = document.createElement('div');
    card.className = 'device-card';
    card.setAttribute('data-device', deviceId);

    // Device icon mapping
    const iconMap = {
        'fan': 'fa-fan',
        'light': 'fa-lightbulb', 
        'tv': 'fa-tv',
        'ac': 'fa-snowflake'
    };
    const iconClass = iconMap[deviceInfo.type] || 'fa-question';

    // Device header (consistent for all devices)
    card.innerHTML = `
        <div class="device-header">
            <div class="device-title">
                <div class="device-icon">
                    <i class="fas ${iconClass}"></i>
                </div>
                <span>${deviceInfo.name || deviceId}</span>
            </div>
            <div class="power-switch" data-device="${deviceId}"></div>
        </div>
        <div class="device-status">
            <div class="status-indicator"></div>
            <span class="status-text">Offline</span>
        </div>
        <div class="controls-section"></div>
    `;

    // Controls section - standardized for all device types
    const controlsSection = card.querySelector('.controls-section');
    const controlsConfig = getControlsConfig(deviceInfo.type, deviceInfo);
    
    controlsSection.innerHTML = controlsConfig.html;

    // Insert before the add-device card
    const addDeviceCard = devicesGrid.querySelector('.add-device-card');
    devicesGrid.insertBefore(card, addDeviceCard);

    // Add event listeners
    addDeviceEventListeners(card, deviceId);

    // Initial UI update
    updateSingleDeviceUI(card, deviceInfo);
}

// New helper function for consistent control configurations
function getControlsConfig(deviceType, deviceInfo) {
    const configs = {
        'fan': {
            html: `
                <div class="control-group">
                    <label class="control-label">Speed Control</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="0" max="100" value="${deviceInfo.speed || 0}" data-control="speed">
                        <div class="slider-value">
                            <span>0%</span>
                            <span class="current-value">${deviceInfo.speed || 0}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            `
        },
        'light': {
            html: `
                <div class="control-group">
                    <label class="control-label">Brightness</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="0" max="100" value="${deviceInfo.brightness || 0}" data-control="brightness">
                        <div class="slider-value">
                            <span>0%</span>
                            <span class="current-value">${deviceInfo.brightness || 0}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            `
        },
        'tv': {
            html: `
                <div class="control-group">
                    <label class="control-label">Volume</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="0" max="100" value="${deviceInfo.volume || 0}" data-control="volume">
                        <div class="slider-value">
                            <span>0%</span>
                            <span class="current-value">${deviceInfo.volume || 0}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            `
        },
        'ac': {
            html: `
                <div class="control-group">
                    <label class="control-label">Temperature</label>
                    <div class="slider-container">
                        <input type="range" class="slider" min="16" max="30" value="${deviceInfo.temperature || 20}" data-control="temperature">
                        <div class="slider-value">
                            <span>16°C</span>
                            <span class="current-value">${deviceInfo.temperature || 20}°C</span>
                            <span>30°C</span>
                        </div>
                    </div>
                </div>
            `
        }
    };
    
    return configs[deviceType] || {
        html: `<div class="control-group"><p>No controls available</p></div>`
    };
}

// New helper function for consistent event listener attachment
function addDeviceEventListeners(card, deviceId) {
    // Power switch event
    const powerSwitch = card.querySelector('.power-switch');
    if (powerSwitch) {
        powerSwitch.addEventListener('click', function() {
            sendDeviceState(deviceId, !this.classList.contains('on'));
        });
    }

    // Slider events
    card.querySelectorAll('.slider').forEach(slider => {
        slider.addEventListener('input', function() {
            // Update display value immediately for responsive UI
            const value = this.value;
            const controlType = this.getAttribute('data-control');
            const currentValueSpan = this.parentElement.querySelector('.current-value');
            
            if (currentValueSpan) {
                if (controlType === 'temperature') {
                    currentValueSpan.textContent = value + '°C';
                } else {
                    currentValueSpan.textContent = value + '%';
                }
            }
        });
        
        slider.addEventListener('change', function() {
            const value = this.value;
            const controlType = this.getAttribute('data-control');
            sendControlUpdate(deviceId, controlType, value);
        });
    });
}

// Updated updateSingleDeviceUI function for better consistency
function updateSingleDeviceUI(card, deviceInfo) {
    // Power switch state
    const powerSwitch = card.querySelector('.power-switch');
    if (powerSwitch) {
        if (deviceInfo.state) {
            powerSwitch.classList.add('on');
            powerSwitch.classList.remove('off');
        } else {
            powerSwitch.classList.remove('on');
            powerSwitch.classList.add('off');
        }
    }
    
    // Status indicator
    const statusIndicator = card.querySelector('.status-indicator');
    const statusText = card.querySelector('.status-text');
    if (statusIndicator && statusText) {
        if (deviceInfo.state) {
            statusIndicator.classList.add('active');
            statusText.textContent = 'Online';
        } else {
            statusIndicator.classList.remove('active');
            statusText.textContent = 'Offline';
        }
    }
    
    // Update all sliders and their display values
    card.querySelectorAll('.slider').forEach(slider => {
        const controlType = slider.getAttribute('data-control');
        if (deviceInfo[controlType] !== undefined) {
            slider.value = deviceInfo[controlType];
            
            const currentValueSpan = slider.parentElement.querySelector('.current-value');
            if (currentValueSpan) {
                if (controlType === 'temperature') {
                    currentValueSpan.textContent = deviceInfo[controlType] + '°C';
                } else {
                    currentValueSpan.textContent = deviceInfo[controlType] + '%';
                }
            }
        }
    });
}
    </script>
</body>
</html>



-------------------------------------------------sensor_server.py---------------------------

# sensor_server.py
import time
import board
import adafruit_dht
import RPi.GPIO as GPIO
from flask import Flask, jsonify
import threading
import socket

# GPIO setup
LED_PIN = 18
GPIO.setmode(GPIO.BCM)
GPIO.setup(LED_PIN, GPIO.OUT)
pwm = GPIO.PWM(LED_PIN, 1000)
pwm.start(0)

# DHT Sensor setup
dht_device = adafruit_dht.DHT11(board.D4)

# Shared state
person_count = 0
current_temp = 0
light_intensity = 0

# Flask app
app = Flask(__name__)

@app.route('/api/devices', methods=['GET'])
def get_device_status():
    return jsonify({
        "status": "success",
        "devices": {
            "light": {
                "type": "light",
                "state": person_count > 0,
                "brightness": light_intensity
            },
            "fan": {
                "type": "fan",
                "state": person_count > 0,
                "speed": 70 if person_count > 0 else 0
            },
            "ac": {
                "type": "ac",
                "state": person_count > 0,
                "temperature": current_temp
            }
        }
    })

def update_devices():
    global current_temp, light_intensity
    while True:
        try:
            if person_count == 0:
                pwm.ChangeDutyCycle(0)
                current_temp = 0
                light_intensity = 0
            else:
                temp = dht_device.temperature
                current_temp = temp if temp is not None else 0
                light_intensity = min(100, person_count * 25)
                pwm.ChangeDutyCycle(light_intensity)
        except Exception as e:
            print(f"DHT error: {e}")
        time.sleep(2)

def start_socket_server():
    global person_count
    host = '0.0.0.0'
    port = 5001
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.bind((host, port))
    print(f"Listening for person count on {host}:{port}...")
    while True:
        data, _ = sock.recvfrom(1024)
        try:
            person_count = int(data.decode().strip())
            print(f"Updated person count: {person_count}")
        except ValueError:
            print(f"Invalid data: {data}")

if __name__ == "__main__":
    threading.Thread(target=update_devices, daemon=True).start()
    threading.Thread(target=start_socket_server, daemon=True).start()
    app.run(host='0.0.0.0', port=8000)





